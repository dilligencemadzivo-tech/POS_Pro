<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tanzania POS Pro Â· Duka Manager</title>
    <meta name="description" content="Professional Point of Sale System for Tanzanian Retail Businesses">
    <meta name="theme-color" content="#006837">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Charts & PDF (kept for reports) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #006837;
            --primary-light: #00A859;
            --primary-dark: #004D2D;
            --secondary: #2E5090;
            --success: #00A859;
            --warning: #FF9800;
            --danger: #E53935;
            --info: #2196F3;
            
            --bg-primary: #F5F7FA;
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-card: #FFFFFF;
            
            --text-primary: #1A1A1A;
            --text-secondary: #4A5568;
            --text-tertiary: #718096;
            
            --border: #E2E8F0;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
            
            --header-height: 64px;
            --bottom-nav-height: 70px;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        [data-theme="dark"] {
            --bg-primary: #1A202C;
            --bg-secondary: #2D3748;
            --bg-card: #2D3748;
            --text-primary: #F7FAFC;
            --text-secondary: #CBD5E0;
            --text-tertiary: #A0AEC0;
            --border: #4A5568;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            -webkit-font-smoothing: antialiased;
        }

        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Scroll Containers */
        .scrollable {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            overscroll-behavior: contain;
        }
        
        .scrollable::-webkit-scrollbar {
            display: none;
        }

        /* Login Screen */
        #loginScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(145deg, var(--primary-dark), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .login-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,104,55,0.15);
        }

        .form-control.error {
            border-color: var(--danger);
            background: rgba(229,57,53,0.05);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 48px;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #00C853);
            color: white;
            border: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #F44336);
            color: white;
            border: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-icon {
            width: 48px;
            height: 48px;
            padding: 0;
        }

        .btn-sm {
            min-height: 36px;
            padding: 0.5rem 1rem;
        }

        .w-full {
            width: 100%;
        }
        .flex-1 { flex:1; }

        /* POS Screen */
        #posScreen {
            display: none;
            height: 100%;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .pos-header {
            height: var(--header-height);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            border-radius: 100px;
            border: 1px solid var(--border);
        }

        .role-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Bottom Navigation */
        .bottom-nav {
            height: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0.5rem 0.5rem var(--safe-area-bottom);
            flex-shrink: 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            flex: 1;
            border-radius: var(--radius-md);
            transition: all 0.2s;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(0,104,55,0.1);
        }

        .nav-icon {
            font-size: 1.25rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .page {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .page.active {
            display: block;
        }

        /* Sales Page */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
            padding: 0.25rem;
        }

        .product-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .product-card:active {
            transform: scale(0.98);
            background: var(--bg-secondary);
        }

        .product-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .product-price {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .product-stock {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .product-stock.low {
            color: var(--warning);
        }

        .product-stock.out {
            color: var(--danger);
        }

        /* Cart Drawer */
        .cart-drawer {
            position: fixed;
            bottom: var(--bottom-nav-height);
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
            z-index: 1000;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .cart-drawer.open {
            transform: translateY(0);
        }

        .cart-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .cart-items {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:active {
            background: var(--bg-secondary);
        }

        .cart-summary {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .summary-row.total {
            font-weight: 700;
            font-size: 1.125rem;
            border-top: 1px solid var(--border);
            padding-top: 0.75rem;
            margin-top: 0.5rem;
        }

        /* Floating Cart Button */
        .floating-cart-btn {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + 1rem);
            right: 1rem;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 99;
            transition: all 0.2s;
        }

        .floating-cart-btn:active {
            transform: scale(0.95);
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-card);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1rem;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
        }

        /* Payment Methods â€” updated: Credit and Mobile */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .payment-method {
            padding: 1.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method.active {
            border-color: var(--primary);
            background: rgba(0,104,55,0.1);
        }

        .payment-method i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 20000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 350px;
        }

        .toast {
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius-md);
            padding: 1rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.success {
            border-left-color: var(--success);
        }
        
        .toast.error {
            border-left-color: var(--danger);
        }
        
        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--danger);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Tables */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: var(--bg-secondary);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        /* Loading Skeleton (minimal) */
        .skeleton {
            background: linear-gradient(90deg, var(--border) 25%, var(--bg-secondary) 50%, var(--border) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-tertiary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
            }
        }

        /* Hide elements */
        .hidden {
            display: none !important;
        }
        .text-center { text-align: center; }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="login-container scrollable">
                <div class="login-header">
                    <h1><i class="fas fa-store"></i> Tanzania POS</h1>
                    <p>Professional Duka Management</p>
                </div>
                
                <div class="login-form">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="Enter username" value="admin">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <div style="position: relative;">
                            <input type="password" id="loginPassword" class="form-control" placeholder="Enter password" value="admin123">
                            <button type="button" id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select id="loginRole" class="form-control">
                            <option value="cashier">Cashier</option>
                            <option value="manager">Manager</option>
                            <option value="admin" selected>Admin</option>
                        </select>
                    </div>
                    
                    <button id="loginBtn" class="btn btn-primary w-full">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    
                    <div class="demo-credentials" style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <p class="font-semibold mb-1">Demo Credentials:</p>
                        <p class="mb-1">admin / admin123 (Admin)</p>
                        <p>cashier / cashier123 (Cashier)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- POS Screen -->
        <div id="posScreen">
            <!-- Header -->
            <header class="pos-header">
                <div class="logo">
                    <i class="fas fa-store"></i>
                    <span>Tanzania POS</span>
                </div>
                
                <div class="datetime" id="datetime">
                    <span id="datetimeText"></span>
                </div>
                
                <div class="header-actions">
                    <button class="btn btn-icon" id="fullscreenBtn">
                        <i class="fas fa-expand"></i>
                    </button>
                    
                    <div class="user-info">
                        <span id="currentUser">User</span>
                        <span id="currentRole" class="role-badge">Admin</span>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Sales Page -->
                <div id="salesPage" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="salesToday">TZS 0</div>
                            <div class="stat-label">Today's Sales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="productsSold">0</div>
                            <div class="stat-label">Items Sold</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="transactionsToday">0</div>
                            <div class="stat-label">Transactions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgSale">TZS 0</div>
                            <div class="stat-label">Average</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="text" id="productSearch" class="form-control" placeholder="ðŸ” Search products...">
                        <button id="scanBtn" class="btn btn-primary btn-icon">
                            <i class="fas fa-barcode"></i>
                        </button>
                        <button id="quickSaleBtn" class="btn btn-success">
                            <i class="fas fa-bolt"></i> Quick
                        </button>
                    </div>
                    
                    <div class="category-tabs" id="categoryTabs" style="display: flex; gap: 0.5rem; overflow-x: auto; padding: 0.25rem 0; margin-bottom: 1rem;">
                        <!-- Categories will be loaded here -->
                    </div>
                    
                    <div class="products-grid" id="productsGrid">
                        <!-- Products will be loaded here -->
                    </div>
                </div>

                <!-- History Page (enhanced) -->
                <div id="historyPage" class="page">
                    <h2 style="margin-bottom: 1rem;"><i class="fas fa-history"></i> Sales History</h2>
                    
                    <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                        <select id="historyPeriod" class="form-control">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                            <option value="all">All Time</option>
                        </select>
                        
                        <input type="text" id="historySearch" class="form-control" placeholder="Search sales by ID or cashier...">
                        <button id="exportHistoryBtn" class="btn btn-primary"><i class="fas fa-download"></i> Export PDF</button>
                    </div>
                    
                    <div class="table-container">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Receipt #</th>
                                    <th>Items</th>
                                    <th>Cashier</th>
                                    <th>Payment</th>
                                    <th>Total</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- History will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Inventory Page -->
                <div id="inventoryPage" class="page">
                    <h2 style="margin-bottom: 1rem;"><i class="fas fa-boxes"></i> Inventory</h2>
                    
                    <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="text" id="inventorySearch" class="form-control" placeholder="Search products...">
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="inventoryFilter" class="form-control">
                                <option value="all">All Products</option>
                                <option value="low">Low Stock (<10)</option>
                                <option value="out">Out of Stock</option>
                            </select>
                            
                            <button id="addProductBtn" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Stock</th>
                                    <th>Price (TZS)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <!-- Inventory will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Reports Page (kept) -->
                <div id="reportsPage" class="page">
                    <h2 style="margin-bottom: 1rem;"><i class="fas fa-chart-bar"></i> Reports</h2>
                    
                    <div class="stats-grid" style="margin-bottom: 1rem;">
                        <div class="stat-card">
                            <div class="stat-value" id="reportTotalRevenue">TZS 0</div>
                            <div class="stat-label">Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="reportTotalSales">0</div>
                            <div class="stat-label">Sales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="reportAvgTransaction">TZS 0</div>
                            <div class="stat-label">Average</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="reportTopProduct">-</div>
                            <div class="stat-label">Top Product</div>
                        </div>
                    </div>
                    
                    <select id="reportPeriod" class="form-control" style="margin-bottom: 1rem;">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                    
                    <div style="background: var(--bg-card); padding: 1rem; border-radius: var(--radius-md);">
                        <canvas id="salesChart" style="width: 100%; height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settingsPage" class="page">
                    <h2 style="margin-bottom: 1rem;"><i class="fas fa-cog"></i> Settings</h2>
                    
                    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius-md);">
                        <div class="form-group">
                            <label class="form-label">Store Name</label>
                            <input type="text" id="storeName" class="form-control" value="Tanzania Shop">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tax Rate (%)</label>
                            <input type="number" id="taxRate" class="form-control" value="18" min="0" max="100">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Theme</label>
                            <div style="display: flex; gap: 1rem;">
                                <button class="theme-option btn" data-theme="light" style="flex:1;">
                                    <i class="fas fa-sun"></i> Light
                                </button>
                                <button class="theme-option btn" data-theme="dark" style="flex:1;">
                                    <i class="fas fa-moon"></i> Dark
                                </button>
                            </div>
                        </div>
                        
                        <hr style="margin: 1.5rem 0; border-color: var(--border);">
                        
                        <button id="logoutBtn" class="btn btn-danger w-full">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </main>

            <!-- Bottom Navigation -->
            <nav class="bottom-nav">
                <button class="nav-item active" data-page="sales">
                    <i class="fas fa-shopping-cart nav-icon"></i>
                    <span>Sales</span>
                </button>
                <button class="nav-item" data-page="history">
                    <i class="fas fa-history nav-icon"></i>
                    <span>History</span>
                </button>
                <button class="nav-item" data-page="inventory">
                    <i class="fas fa-boxes nav-icon"></i>
                    <span>Inventory</span>
                </button>
                <button class="nav-item" data-page="reports">
                    <i class="fas fa-chart-bar nav-icon"></i>
                    <span>Reports</span>
                </button>
                <button class="nav-item" data-page="settings">
                    <i class="fas fa-cog nav-icon"></i>
                    <span>Settings</span>
                </button>
            </nav>

            <!-- Floating Cart Button -->
            <button id="floatingCartBtn" class="floating-cart-btn">
                <i class="fas fa-shopping-cart"></i>
                <span id="cartBadge" class="cart-badge hidden">0</span>
            </button>

            <!-- Cart Drawer -->
            <div id="cartDrawer" class="cart-drawer">
                <div class="cart-header">
                    <h3><i class="fas fa-shopping-cart"></i> Your Cart</h3>
                    <button id="clearCartBtn" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                
                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be loaded here -->
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cartSubtotal">TZS 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax (18%):</span>
                        <span id="cartTax">TZS 0</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="cartTotal">TZS 0</span>
                    </div>
                    
                    <button id="checkoutBtn" class="btn btn-success w-full" style="margin-top: 1rem;">
                        <i class="fas fa-credit-card"></i> Checkout
                    </button>
                </div>
            </div>
        </div>

        <!-- Payment Modal (updated methods: Cash, Credit, Mobile) -->
        <div id="paymentModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Payment</h3>
                    <button id="closePaymentModal" class="btn btn-icon">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div class="payment-methods">
                        <div class="payment-method active" data-method="cash">
                            <i class="fas fa-money-bill-wave"></i>
                            <div>Cash</div>
                        </div>
                        <div class="payment-method" data-method="credit">
                            <i class="fas fa-credit-card"></i>
                            <div>Credit</div>
                        </div>
                        <div class="payment-method" data-method="mobile">
                            <i class="fas fa-mobile-alt"></i>
                            <div>Mobile</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Amount Tendered (if cash)</label>
                        <input type="number" id="amountTendered" class="form-control" placeholder="0.00">
                    </div>
                    
                    <div class="summary-row">
                        <span>Total:</span>
                        <span id="paymentTotal">TZS 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Change:</span>
                        <span id="paymentChange">TZS 0</span>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button id="cancelPaymentBtn" class="btn flex-1">Cancel</button>
                    <button id="confirmPaymentBtn" class="btn btn-success flex-1">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Product Modal (add/edit, with price editable) -->
        <div id="productModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="productModalTitle">Add Product</h3>
                    <button id="closeProductModal" class="btn btn-icon">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Product Name</label>
                        <input type="text" id="productName" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Price (TZS)</label>
                        <input type="number" id="productPrice" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Stock</label>
                        <input type="number" id="productStock" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="productCategory" class="form-control">
                            <option value="food">Food</option>
                            <option value="drinks">Drinks</option>
                            <option value="electronics">Electronics</option>
                            <option value="clothing">Clothing</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button id="cancelProductBtn" class="btn flex-1">Cancel</button>
                    <button id="saveProductBtn" class="btn btn-success flex-1">Save</button>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toastContainer" class="toast-container"></div>
    </div>

    <script>
        // ==================== DATA STORE ====================
        class DataStore {
            constructor() {
                this.products = JSON.parse(localStorage.getItem('pos_products')) || this.getDefaultProducts();
                this.sales = JSON.parse(localStorage.getItem('pos_sales')) || [];
                this.settings = JSON.parse(localStorage.getItem('pos_settings')) || this.getDefaultSettings();
                this.cart = JSON.parse(localStorage.getItem('pos_cart')) || [];
                this.categories = ['all', 'food', 'drinks', 'electronics', 'clothing', 'other'];
                this.currentUser = null;
                this.theme = localStorage.getItem('pos_theme') || 'light';
            }

            getDefaultProducts() {
                return [
                    { id: 1, name: 'Rice 1kg', price: 2500, stock: 50, category: 'food' },
                    { id: 2, name: 'Sugar 1kg', price: 1800, stock: 100, category: 'food' },
                    { id: 3, name: 'Cooking Oil 1L', price: 4500, stock: 30, category: 'food' },
                    { id: 4, name: 'Coca-Cola 500ml', price: 1200, stock: 200, category: 'drinks' },
                    { id: 5, name: 'Milk 1L', price: 2800, stock: 40, category: 'drinks' },
                    { id: 6, name: 'T-Shirt', price: 15000, stock: 25, category: 'clothing' },
                    { id: 7, name: 'USB Cable', price: 5000, stock: 15, category: 'electronics' },
                    { id: 8, name: 'Soap Bar', price: 1500, stock: 80, category: 'other' }
                ];
            }

            getDefaultSettings() {
                return {
                    storeName: 'Tanzania Shop',
                    taxRate: 18
                };
            }

            saveProducts() {
                localStorage.setItem('pos_products', JSON.stringify(this.products));
            }

            saveSales() {
                localStorage.setItem('pos_sales', JSON.stringify(this.sales));
            }

            saveSettings() {
                localStorage.setItem('pos_settings', JSON.stringify(this.settings));
            }

            saveCart() {
                localStorage.setItem('pos_cart', JSON.stringify(this.cart));
            }

            saveTheme() {
                localStorage.setItem('pos_theme', this.theme);
            }

            addProduct(product) {
                const id = this.products.length > 0 ? Math.max(...this.products.map(p => p.id)) + 1 : 1;
                product.id = id;
                this.products.push(product);
                this.saveProducts();
                return product;
            }

            updateProduct(id, updates) {
                const index = this.products.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.products[index] = { ...this.products[index], ...updates };
                    this.saveProducts();
                }
            }

            deleteProduct(id) {
                this.products = this.products.filter(p => p.id !== id);
                this.saveProducts();
            }

            addSale(sale) {
                sale.id = 'INV-' + Date.now().toString().slice(-8);
                sale.timestamp = new Date().toISOString();
                this.sales.unshift(sale);
                
                // Update stock
                sale.items.forEach(item => {
                    const product = this.products.find(p => p.id === item.productId);
                    if (product) {
                        product.stock -= item.quantity;
                    }
                });
                
                this.saveSales();
                this.saveProducts();
                return sale;
            }

            getProductById(id) {
                return this.products.find(p => p.id === id);
            }

            getTodaySales() {
                const today = new Date().toDateString();
                return this.sales.filter(s => new Date(s.timestamp).toDateString() === today);
            }

            getSalesByPeriod(period) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                switch(period) {
                    case 'today':
                        return this.sales.filter(s => new Date(s.timestamp) >= today);
                    case 'yesterday':
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        return this.sales.filter(s => {
                            const d = new Date(s.timestamp);
                            return d >= yesterday && d < today;
                        });
                    case 'week':
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return this.sales.filter(s => new Date(s.timestamp) >= weekAgo);
                    case 'month':
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        return this.sales.filter(s => new Date(s.timestamp) >= monthAgo);
                    case 'year':
                        const yearAgo = new Date(today);
                        yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                        return this.sales.filter(s => new Date(s.timestamp) >= yearAgo);
                    default:
                        return this.sales;
                }
            }

            getTotalRevenue(period) {
                return this.getSalesByPeriod(period).reduce((sum, s) => sum + s.total, 0);
            }

            getTotalSalesCount(period) {
                return this.getSalesByPeriod(period).length;
            }

            getAverageTransaction(period) {
                const sales = this.getSalesByPeriod(period);
                if (sales.length === 0) return 0;
                return sales.reduce((sum, s) => sum + s.total, 0) / sales.length;
            }

            getTopProduct(period) {
                const sales = this.getSalesByPeriod(period);
                const counts = {};
                sales.forEach(s => {
                    s.items.forEach(item => {
                        counts[item.productId] = (counts[item.productId] || 0) + item.quantity;
                    });
                });
                
                const topId = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b, null);
                if (!topId) return '-';
                const product = this.getProductById(parseInt(topId));
                return product ? product.name : '-';
            }
        }

        // ==================== INITIALIZE ====================
        const dataStore = new DataStore();
        
        // DOM Elements
        const elements = {
            loginScreen: document.getElementById('loginScreen'),
            posScreen: document.getElementById('posScreen'),
            loginBtn: document.getElementById('loginBtn'),
            loginUsername: document.getElementById('loginUsername'),
            loginPassword: document.getElementById('loginPassword'),
            loginRole: document.getElementById('loginRole'),
            currentUser: document.getElementById('currentUser'),
            currentRole: document.getElementById('currentRole'),
            datetimeText: document.getElementById('datetimeText'),
            navItems: document.querySelectorAll('.nav-item'),
            pages: document.querySelectorAll('.page'),
            salesToday: document.getElementById('salesToday'),
            productsSold: document.getElementById('productsSold'),
            transactionsToday: document.getElementById('transactionsToday'),
            avgSale: document.getElementById('avgSale'),
            productSearch: document.getElementById('productSearch'),
            categoryTabs: document.getElementById('categoryTabs'),
            productsGrid: document.getElementById('productsGrid'),
            scanBtn: document.getElementById('scanBtn'),
            quickSaleBtn: document.getElementById('quickSaleBtn'),
            floatingCartBtn: document.getElementById('floatingCartBtn'),
            cartBadge: document.getElementById('cartBadge'),
            cartDrawer: document.getElementById('cartDrawer'),
            cartItems: document.getElementById('cartItems'),
            cartSubtotal: document.getElementById('cartSubtotal'),
            cartTax: document.getElementById('cartTax'),
            cartTotal: document.getElementById('cartTotal'),
            clearCartBtn: document.getElementById('clearCartBtn'),
            checkoutBtn: document.getElementById('checkoutBtn'),
            paymentModal: document.getElementById('paymentModal'),
            closePaymentModal: document.getElementById('closePaymentModal'),
            paymentMethods: document.querySelectorAll('.payment-method'),
            amountTendered: document.getElementById('amountTendered'),
            paymentTotal: document.getElementById('paymentTotal'),
            paymentChange: document.getElementById('paymentChange'),
            cancelPaymentBtn: document.getElementById('cancelPaymentBtn'),
            confirmPaymentBtn: document.getElementById('confirmPaymentBtn'),
            historyPeriod: document.getElementById('historyPeriod'),
            historySearch: document.getElementById('historySearch'),
            historyTableBody: document.getElementById('historyTableBody'),
            exportHistoryBtn: document.getElementById('exportHistoryBtn'),
            inventorySearch: document.getElementById('inventorySearch'),
            inventoryFilter: document.getElementById('inventoryFilter'),
            inventoryTableBody: document.getElementById('inventoryTableBody'),
            addProductBtn: document.getElementById('addProductBtn'),
            productModal: document.getElementById('productModal'),
            closeProductModal: document.getElementById('closeProductModal'),
            productName: document.getElementById('productName'),
            productPrice: document.getElementById('productPrice'),
            productStock: document.getElementById('productStock'),
            productCategory: document.getElementById('productCategory'),
            cancelProductBtn: document.getElementById('cancelProductBtn'),
            saveProductBtn: document.getElementById('saveProductBtn'),
            productModalTitle: document.getElementById('productModalTitle'),
            reportTotalRevenue: document.getElementById('reportTotalRevenue'),
            reportTotalSales: document.getElementById('reportTotalSales'),
            reportAvgTransaction: document.getElementById('reportAvgTransaction'),
            reportTopProduct: document.getElementById('reportTopProduct'),
            reportPeriod: document.getElementById('reportPeriod'),
            salesChart: document.getElementById('salesChart'),
            storeName: document.getElementById('storeName'),
            taxRate: document.getElementById('taxRate'),
            themeOptions: document.querySelectorAll('.theme-option'),
            logoutBtn: document.getElementById('logoutBtn'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            togglePassword: document.getElementById('togglePassword'),
            toastContainer: document.getElementById('toastContainer')
        };

        // ==================== UTILITIES ====================
        function formatCurrency(amount) {
            return 'TZS ' + amount.toLocaleString('en-US');
        }

        function formatDate(dateString) {
            const d = new Date(dateString);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas ${icons[type]} toast-icon"></i>
                <div class="toast-content">
                    <div class="toast-title">${type.toUpperCase()}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            elements.toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function updateDateTime() {
            const now = new Date();
            elements.datetimeText.textContent = now.toLocaleString('en-US', { 
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                month: 'short', day: 'numeric'
            });
        }

        // ==================== CART FUNCTIONS ====================
        function updateCart() {
            const cart = dataStore.cart;
            let subtotal = 0;
            let totalItems = 0;
            
            elements.cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                elements.cartItems.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Your cart is empty</p></div>';
            } else {
                cart.forEach((item, index) => {
                    const product = dataStore.getProductById(item.productId);
                    if (!product) return;
                    
                    const itemTotal = product.price * item.quantity;
                    subtotal += itemTotal;
                    totalItems += item.quantity;
                    
                    const div = document.createElement('div');
                    div.className = 'cart-item';
                    div.innerHTML = `
                        <div class="cart-item-details">
                            <div class="cart-item-name">${product.name}</div>
                            <div>${formatCurrency(product.price)} x ${item.quantity}</div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn" data-index="${index}" data-action="decrease">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn" data-index="${index}" data-action="increase">+</button>
                        </div>
                        <button class="btn btn-danger btn-sm" data-index="${index}" data-action="remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    elements.cartItems.appendChild(div);
                });
            }
            
            const taxRate = dataStore.settings.taxRate || 18;
            const tax = subtotal * (taxRate / 100);
            const total = subtotal + tax;
            
            elements.cartSubtotal.textContent = formatCurrency(subtotal);
            elements.cartTax.textContent = formatCurrency(tax);
            elements.cartTotal.textContent = formatCurrency(total);
            elements.paymentTotal.textContent = formatCurrency(total);
            
            if (totalItems > 0) {
                elements.cartBadge.textContent = totalItems;
                elements.cartBadge.classList.remove('hidden');
            } else {
                elements.cartBadge.classList.add('hidden');
            }
            
            dataStore.saveCart();
        }

        function addToCart(productId, quantity = 1) {
            const product = dataStore.getProductById(productId);
            if (!product) return;
            
            if (product.stock < quantity) {
                showToast(`Only ${product.stock} available`, 'error');
                return;
            }
            
            const existing = dataStore.cart.find(i => i.productId === productId);
            if (existing) {
                if (product.stock < existing.quantity + quantity) {
                    showToast(`Only ${product.stock} available`, 'error');
                    return;
                }
                existing.quantity += quantity;
            } else {
                dataStore.cart.push({ productId, quantity });
            }
            
            updateCart();
            showToast(`Added ${product.name} to cart`, 'success');
        }

        function updateCartItem(index, action) {
            if (action === 'remove') {
                dataStore.cart.splice(index, 1);
                showToast('Item removed', 'info');
            } else if (action === 'increase') {
                const item = dataStore.cart[index];
                const product = dataStore.getProductById(item.productId);
                if (product.stock > item.quantity) {
                    item.quantity++;
                } else {
                    showToast('Stock limit reached', 'warning');
                }
            } else if (action === 'decrease') {
                const item = dataStore.cart[index];
                if (item.quantity > 1) {
                    item.quantity--;
                } else {
                    dataStore.cart.splice(index, 1);
                }
            }
            updateCart();
        }

        function clearCart() {
            dataStore.cart = [];
            updateCart();
            showToast('Cart cleared', 'info');
        }

        // ==================== SALES PAGE ====================
        function updateSalesStats() {
            const today = dataStore.getTodaySales();
            const revenue = today.reduce((sum, s) => sum + s.total, 0);
            const items = today.reduce((sum, s) => sum + s.items.reduce((a, i) => a + i.quantity, 0), 0);
            
            elements.salesToday.textContent = formatCurrency(revenue);
            elements.productsSold.textContent = items;
            elements.transactionsToday.textContent = today.length;
            elements.avgSale.textContent = formatCurrency(today.length ? revenue / today.length : 0);
        }

        function loadCategories() {
            elements.categoryTabs.innerHTML = '';
            
            dataStore.categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `category-tab btn btn-sm ${cat === 'all' ? 'btn-primary' : ''}`;
                btn.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                btn.dataset.category = cat;
                btn.style.background = cat === 'all' ? 'var(--primary)' : 'var(--bg-secondary)';
                btn.style.color = cat === 'all' ? 'white' : 'var(--text-primary)';
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(b => {
                        b.classList.remove('btn-primary');
                        b.style.background = 'var(--bg-secondary)';
                        b.style.color = 'var(--text-primary)';
                    });
                    btn.classList.add('btn-primary');
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                    loadProducts(cat, elements.productSearch.value);
                });
                elements.categoryTabs.appendChild(btn);
            });
        }

        function loadProducts(category = 'all', search = '') {
            elements.productsGrid.innerHTML = '';
            
            let products = dataStore.products;
            
            if (category !== 'all') {
                products = products.filter(p => p.category === category);
            }
            
            if (search) {
                products = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));
            }
            
            if (products.length === 0) {
                elements.productsGrid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="fas fa-box-open"></i><p>No products found</p></div>';
                return;
            }
            
            products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-name">${p.name}</div>
                    <div class="product-price">${formatCurrency(p.price)}</div>
                    <div class="product-stock ${p.stock === 0 ? 'out' : p.stock < 10 ? 'low' : ''}">
                        <i class="fas fa-box"></i> ${p.stock} left
                    </div>
                `;
                card.addEventListener('click', () => addToCart(p.id, 1));
                elements.productsGrid.appendChild(card);
            });
        }

        // ==================== HISTORY PAGE (enhanced) ====================
        function loadSalesHistory() {
            const period = elements.historyPeriod.value;
            const search = elements.historySearch.value.toLowerCase();
            
            let sales = dataStore.getSalesByPeriod(period);
            
            if (search) {
                sales = sales.filter(s => 
                    s.id.toLowerCase().includes(search) || 
                    (s.cashier && s.cashier.toLowerCase().includes(search))
                );
            }
            
            elements.historyTableBody.innerHTML = '';
            
            if (sales.length === 0) {
                elements.historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No sales found</td></tr>';
                return;
            }
            
            sales.forEach(sale => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(sale.timestamp)}</td>
                    <td>${sale.id}</td>
                    <td>${sale.items.reduce((a,i)=>a+i.quantity,0)} items</td>
                    <td>${sale.cashier || 'Cashier'}</td>
                    <td>${sale.paymentMethod || 'cash'}</td>
                    <td>${formatCurrency(sale.total)}</td>
                    <td><button class="btn btn-sm btn-info view-details" data-sale='${JSON.stringify(sale).replace(/'/g, "&apos;")}'><i class="fas fa-receipt"></i></button></td>
                `;
                elements.historyTableBody.appendChild(row);
            });

            // attach view details (simple alert for demo)
            document.querySelectorAll('.view-details').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const sale = JSON.parse(btn.dataset.sale);
                    let msg = `Receipt: ${sale.id}\nItems:\n`;
                    sale.items.forEach(i => {
                        const prod = dataStore.getProductById(i.productId);
                        msg += `${prod ? prod.name : 'item'} x${i.quantity} @ ${i.price}\n`;
                    });
                    msg += `Total: ${formatCurrency(sale.total)} (${sale.paymentMethod})`;
                    alert(msg);
                });
            });
        }

        // ==================== INVENTORY PAGE (with price editing) ====================
        function loadInventory() {
            const search = elements.inventorySearch.value.toLowerCase();
            const filter = elements.inventoryFilter.value;
            
            let products = dataStore.products;
            
            if (search) {
                products = products.filter(p => p.name.toLowerCase().includes(search));
            }
            
            if (filter === 'low') {
                products = products.filter(p => p.stock > 0 && p.stock < 10);
            } else if (filter === 'out') {
                products = products.filter(p => p.stock === 0);
            }
            
            elements.inventoryTableBody.innerHTML = '';
            
            if (products.length === 0) {
                elements.inventoryTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No products found</td></tr>';
                return;
            }
            
            products.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.category}</td>
                    <td>
                        <span class="${p.stock === 0 ? 'text-danger' : p.stock < 10 ? 'text-warning' : ''}">
                            ${p.stock} units
                        </span>
                    </td>
                    <td>${formatCurrency(p.price)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-product" data-id="${p.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger delete-product" data-id="${p.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                elements.inventoryTableBody.appendChild(row);
            });
            
            // Add edit/delete handlers
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', () => openProductModal(parseInt(btn.dataset.id)));
            });
            
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('Delete this product?')) {
                        dataStore.deleteProduct(parseInt(btn.dataset.id));
                        loadInventory();
                        loadProducts();
                        showToast('Product deleted', 'success');
                    }
                });
            });
        }

        // ==================== REPORTS PAGE ====================
        let chartInstance = null;
        
        function updateReports() {
            const period = elements.reportPeriod.value;
            
            elements.reportTotalRevenue.textContent = formatCurrency(dataStore.getTotalRevenue(period));
            elements.reportTotalSales.textContent = dataStore.getTotalSalesCount(period);
            elements.reportAvgTransaction.textContent = formatCurrency(dataStore.getAverageTransaction(period));
            elements.reportTopProduct.textContent = dataStore.getTopProduct(period);
            
            updateChart(period);
        }

        function updateChart(period) {
            if (chartInstance) chartInstance.destroy();
            
            const ctx = elements.salesChart.getContext('2d');
            
            let labels, data;
            if (period === 'today') {
                labels = ['8AM', '10AM', '12PM', '2PM', '4PM', '6PM'];
                data = [45000, 78000, 120000, 95000, 140000, 110000];
            } else if (period === 'week') {
                labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                data = [250000, 320000, 280000, 410000, 520000, 680000, 450000];
            } else if (period === 'month') {
                labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                data = [1850000, 2200000, 1980000, 2450000];
            } else {
                labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                data = [1250000, 1180000, 1420000, 1380000, 1560000, 1620000, 1580000, 1720000, 1680000, 1850000, 1920000, 2100000];
            }
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales (TZS)',
                        data: data,
                        borderColor: '#006837',
                        backgroundColor: 'rgba(0,104,55,0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // ==================== PRODUCT MODAL (edit price) ====================
        function openProductModal(id = null) {
            elements.productModal.classList.remove('hidden');
            
            if (id) {
                const p = dataStore.getProductById(id);
                if (p) {
                    elements.productModalTitle.textContent = 'Edit Product';
                    elements.productName.value = p.name;
                    elements.productPrice.value = p.price;
                    elements.productStock.value = p.stock;
                    elements.productCategory.value = p.category;
                    elements.saveProductBtn.dataset.id = id;
                    elements.saveProductBtn.dataset.mode = 'edit';
                }
            } else {
                elements.productModalTitle.textContent = 'Add Product';
                elements.productName.value = '';
                elements.productPrice.value = '';
                elements.productStock.value = '';
                elements.productCategory.value = 'food';
                elements.saveProductBtn.dataset.mode = 'add';
                delete elements.saveProductBtn.dataset.id;
            }
        }

        function saveProduct() {
            const mode = elements.saveProductBtn.dataset.mode;
            
            const productData = {
                name: elements.productName.value,
                price: parseFloat(elements.productPrice.value),
                stock: parseInt(elements.productStock.value),
                category: elements.productCategory.value
            };
            
            if (mode === 'edit') {
                const id = parseInt(elements.saveProductBtn.dataset.id);
                dataStore.updateProduct(id, productData);
                showToast('Product updated', 'success');
            } else {
                dataStore.addProduct(productData);
                showToast('Product added', 'success');
            }
            
            elements.productModal.classList.add('hidden');
            loadProducts();
            loadInventory();
        }

        // ==================== SETTINGS ====================
        function loadSettings() {
            elements.storeName.value = dataStore.settings.storeName || 'Tanzania Shop';
            elements.taxRate.value = dataStore.settings.taxRate || 18;
        }

        function saveSettings() {
            dataStore.settings = {
                storeName: elements.storeName.value,
                taxRate: parseFloat(elements.taxRate.value)
            };
            dataStore.saveSettings();
            showToast('Settings saved', 'success');
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', dataStore.theme);
            elements.themeOptions.forEach(opt => {
                opt.classList.toggle('active', opt.dataset.theme === dataStore.theme);
            });
        }

        // ==================== PAYMENT ====================
        function processPayment() {
            if (dataStore.cart.length === 0) {
                showToast('Cart is empty', 'error');
                return;
            }
            
            const total = parseFloat(elements.cartTotal.textContent.replace(/[^0-9.]/g, ''));
            const tendered = parseFloat(elements.amountTendered.value);
            const method = document.querySelector('.payment-method.active').dataset.method;
            
            // For non-cash, tendered is not strictly required, but we keep optional
            if (method === 'cash' && (isNaN(tendered) || tendered < total)) {
                showToast('Insufficient cash amount', 'error');
                return;
            }
            
            const sale = {
                items: dataStore.cart.map(i => ({
                    productId: i.productId,
                    quantity: i.quantity,
                    price: dataStore.getProductById(i.productId).price
                })),
                subtotal: parseFloat(elements.cartSubtotal.textContent.replace(/[^0-9.]/g, '')),
                tax: parseFloat(elements.cartTax.textContent.replace(/[^0-9.]/g, '')),
                total: total,
                paymentMethod: method,
                amountTendered: method === 'cash' ? tendered : total,
                change: method === 'cash' ? (tendered - total) : 0,
                cashier: dataStore.currentUser?.name || 'Cashier'
            };
            
            dataStore.addSale(sale);
            clearCart();
            elements.paymentModal.classList.add('hidden');
            
            showToast(`Sale complete! ${method === 'cash' ? 'Change: '+formatCurrency(tendered - total) : ''}`, 'success');
            
            // Refresh all views
            updateSalesStats();
            loadSalesHistory();
            loadInventory();
            updateReports();
        }

        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Login
            elements.loginBtn.addEventListener('click', () => {
                const username = elements.loginUsername.value;
                const password = elements.loginPassword.value;
                const role = elements.loginRole.value;
                
                if (username && password) {
                    dataStore.currentUser = { name: username, role };
                    elements.loginScreen.style.display = 'none';
                    elements.posScreen.style.display = 'flex';
                    elements.currentUser.textContent = username;
                    elements.currentRole.textContent = role;
                    
                    loadCategories();
                    loadProducts();
                    updateSalesStats();
                    loadSalesHistory();
                    loadInventory();
                    loadSettings();
                    updateReports();
                    updateCart();
                    applyTheme();
                    
                    showToast(`Welcome, ${username}!`, 'success');
                } else {
                    showToast('Enter credentials', 'error');
                }
            });
            
            // Navigation
            elements.navItems.forEach(item => {
                item.addEventListener('click', () => {
                    elements.navItems.forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    elements.pages.forEach(p => p.classList.remove('active'));
                    document.getElementById(item.dataset.page + 'Page').classList.add('active');
                });
            });
            
            // Search
            elements.productSearch.addEventListener('input', () => {
                const cat = document.querySelector('.category-tab.btn-primary')?.dataset.category || 'all';
                loadProducts(cat, elements.productSearch.value);
            });
            
            // Cart
            elements.floatingCartBtn.addEventListener('click', () => {
                elements.cartDrawer.classList.toggle('open');
            });
            
            elements.cartItems.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const index = btn.dataset.index;
                const action = btn.dataset.action;
                if (index !== undefined && action) {
                    updateCartItem(parseInt(index), action);
                }
            });
            
            elements.clearCartBtn.addEventListener('click', clearCart);
            
            elements.checkoutBtn.addEventListener('click', () => {
                if (dataStore.cart.length === 0) {
                    showToast('Cart empty', 'error');
                    return;
                }
                elements.cartDrawer.classList.remove('open');
                elements.paymentModal.classList.remove('hidden');
                elements.amountTendered.value = '';
                elements.paymentChange.textContent = formatCurrency(0);
            });
            
            // Payment modal
            elements.closePaymentModal.addEventListener('click', () => {
                elements.paymentModal.classList.add('hidden');
            });
            
            elements.cancelPaymentBtn.addEventListener('click', () => {
                elements.paymentModal.classList.add('hidden');
            });
            
            elements.paymentMethods.forEach(m => {
                m.addEventListener('click', () => {
                    elements.paymentMethods.forEach(p => p.classList.remove('active'));
                    m.classList.add('active');
                });
            });
            
            elements.amountTendered.addEventListener('input', () => {
                const total = parseFloat(elements.cartTotal.textContent.replace(/[^0-9.]/g, ''));
                const tendered = parseFloat(elements.amountTendered.value) || 0;
                elements.paymentChange.textContent = formatCurrency(Math.max(0, tendered - total));
            });
            
            elements.confirmPaymentBtn.addEventListener('click', processPayment);
            
            // Product modal
            elements.addProductBtn.addEventListener('click', () => openProductModal());
            
            elements.closeProductModal.addEventListener('click', () => {
                elements.productModal.classList.add('hidden');
            });
            
            elements.cancelProductBtn.addEventListener('click', () => {
                elements.productModal.classList.add('hidden');
            });
            
            elements.saveProductBtn.addEventListener('click', saveProduct);
            
            // History filters
            elements.historyPeriod.addEventListener('change', loadSalesHistory);
            elements.historySearch.addEventListener('input', loadSalesHistory);
            elements.exportHistoryBtn.addEventListener('click', () => {
                showToast('Export feature: PDF generation simulated', 'info');
            });
            
            // Inventory filters
            elements.inventorySearch.addEventListener('input', loadInventory);
            elements.inventoryFilter.addEventListener('change', loadInventory);
            
            // Reports
            elements.reportPeriod.addEventListener('change', updateReports);
            
            // Settings
            elements.storeName.addEventListener('change', saveSettings);
            elements.taxRate.addEventListener('change', saveSettings);
            
            elements.themeOptions.forEach(opt => {
                opt.addEventListener('click', () => {
                    dataStore.theme = opt.dataset.theme;
                    dataStore.saveTheme();
                    applyTheme();
                    showToast(`Theme: ${dataStore.theme}`, 'success');
                });
            });
            
            elements.logoutBtn.addEventListener('click', () => {
                dataStore.currentUser = null;
                dataStore.cart = [];
                dataStore.saveCart();
                elements.posScreen.style.display = 'none';
                elements.loginScreen.style.display = 'flex';
                showToast('Logged out', 'info');
            });
            
            // Fullscreen
            elements.fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    elements.fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                } else {
                    document.exitFullscreen();
                    elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                }
            });
            
            // Toggle password
            elements.togglePassword.addEventListener('click', () => {
                const type = elements.loginPassword.type === 'password' ? 'text' : 'password';
                elements.loginPassword.type = type;
                elements.togglePassword.innerHTML = `<i class="fas fa-eye${type === 'password' ? '' : '-slash'}"></i>`;
            });
            
            // Quick sale
            elements.quickSaleBtn.addEventListener('click', () => {
                if (dataStore.products.length >= 3) {
                    addToCart(1, 2);
                    addToCart(4, 3);
                    addToCart(6, 1);
                }
            });
            
            // Scan button (simulate)
            elements.scanBtn.addEventListener('click', () => {
                showToast('Barcode scanner ready', 'info');
            });
            
            // Close cart when clicking outside
            document.addEventListener('click', (e) => {
                if (elements.cartDrawer.classList.contains('open') && 
                    !e.target.closest('#cartDrawer') && 
                    !e.target.closest('#floatingCartBtn')) {
                    elements.cartDrawer.classList.remove('open');
                }
            });
        }

        // ==================== INITIALIZE APP ====================
        function initializeApp() {
            setInterval(updateDateTime, 1000);
            updateDateTime();
            initEventListeners();
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>