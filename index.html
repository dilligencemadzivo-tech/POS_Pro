<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfitPoint POS Pro - Complete Retail Management System</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SheetJS for CSV export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* CSS Variables for Professional Gradient Theme */
        :root {
            --primary-gradient: linear-gradient(135deg, #08437e 0%, #3498db 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            --light-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);

            --primary-color: #667eea;
            --secondary-color: #f093fb;
            --accent-color: #4facfe;
            --success-color: #43e97b;
            --warning-color: #fa709a;
            --danger-color: #ff6b6b;
            --dark-color: #2c3e50;
            --light-color: #121213;

            --background-color: #f6fbff;
            --text-primary: #1f2937;
            /* Changed from #0d0d0e to better contrast */
            --text-secondary: #4b5563;
            /* Changed from #0a0a0a to better contrast */
            --text-light: #6b7280;
            --border-color: #e2e8f0;
            --card-bg: #ffffff;
            --sidebar-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            /* Fixed text color */
            line-height: 1.6;
        }

        /* Professional Theme Variations */
        .theme-corporate {
            --primary-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .theme-modern {
            --primary-gradient: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            --secondary-gradient: linear-gradient(135deg, #fdbb2d 0%, #22c1c3 100%);
            --accent-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .theme-elegant {
            --primary-gradient: linear-gradient(135deg, #434343 0%, #000000 100%);
            --secondary-gradient: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%);
            --accent-gradient: linear-gradient(135deg, #f46b45 0%, #eea849 100%);
        }

        .theme-fresh {
            --primary-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --secondary-gradient: linear-gradient(135deg, #0575e6 0%, #021b79 100%);
            --accent-gradient: linear-gradient(135deg, #f46b45 0%, #eea849 100%);
        }

        /* Base Styles */
        * {
            box-sizing: border-box;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 1rem;
            border: none;
            color: var(--text-primary);
            /* Added text color */
        }


        /* Enhanced Interactive Components */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }



        /* Enhanced Toast Animations */
        .toast-enter {
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast-exit {
            animation: slideOutRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%) scale(0.9);
                opacity: 0;
            }

            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0) scale(1);
                opacity: 1;
            }

            to {
                transform: translateX(100%) scale(0.9);
                opacity: 0;
            }
        }

        /* Enhanced Barcode Scanner */
        .barcode-scanner {
            position: relative;
            width: 100%;
            height: 300px;
            background: var(--dark-gradient);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .barcode-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .barcode-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .barcode-frame {
            width: 220px;
            height: 120px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .barcode-frame::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid transparent;
            border-radius: 15px;
            background: var(--accent-gradient);
            animation: pulse 2s infinite, borderGlow 3s infinite;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            -webkit-mask-composite: xor;
        }

        @keyframes borderGlow {

            0%,
            100% {
                opacity: 1;
                filter: hue-rotate(0deg);
            }

            50% {
                opacity: 0.8;
                filter: hue-rotate(45deg);
            }
        }

        /* Enhanced Loyalty Card */
        .loyalty-card {
            background: var(--primary-gradient);
            border-radius: 20px;
            padding: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .loyalty-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .loyalty-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
            transition: all 0.6s ease;
        }

        .loyalty-card:hover::before {
            transform: rotate(45deg) translate(10px, 10px);
        }

        /* Enhanced POS Layout */
        .pos-with-wallpaper {
            position: relative;
            min-height: 100vh;
        }

        .pos-wallpaper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--light-gradient);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
        }

        .pos-content-transparent {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pos-header-transparent {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
        }

        .pos-cart-transparent {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
        }

        /* Enhanced Manager Layout */
        .manager-sidebar {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            width: 280px;
            background: var(--sidebar-bg);
            box-shadow: 6px 0 20px rgba(0, 0, 0, 0.1);
        }

        .manager-sidebar.collapsed {
            width: 80px;
        }

        .manager-content {
            margin-left: 280px;
            transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--light-gradient);
        }

        .manager-content.expanded {
            margin-left: 80px;
        }

        /* Enhanced Login Styles */
        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 200%;
            object-fit: cover;
            z-index: -2;
        }

        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            z-index: -1;
            opacity: 0.5;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .bg-glass-effect {
            background: linear-gradient(135deg, #e9e7e733 0%, rgba(255, 255, 255, 0.1) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .login-input {
            background: rgba(255, 255, 255, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            backdrop-filter: blur(15px);
            transition: all 0.3s ease;
            color: white !important;
            /* Keep white for login inputs */
            border-radius: 12px;
        }

        .login-input:focus {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1) !important;
            transform: translateY(-2px);
        }

        .login-input::placeholder {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        .login-btn {
            background: var(--primary-gradient);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .login-btn:hover::before {
            left: 100%;
        }

        /* Enhanced Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid rgb(170, 168, 175);
            width: 24px;
            height: 24px;
            animation: spin 0.5s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Enhanced Logo Animation */
        .logo-container {
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px) rotate(-3deg);
            }

            50% {
                transform: translateY(-15px) rotate(3deg);
            }
        }

        /* Enhanced Dashboard Cards - FIXED TEXT COLORS */
        .dashboard-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            /* Added text color */
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .stat-card {
            background: var(--primary-gradient);
            border-radius: 16px;
            color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        /* Enhanced Buttons with Gradients */
        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            transition: all 0.3s ease;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--secondary-gradient);
            color: white;
            transition: all 0.3s ease;
            border: none;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
        }

        .btn-accent {
            background: var(--accent-gradient);
            color: white;
            transition: all 0.3s ease;
            border: none;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .btn-success {
            background: var(--success-gradient);
            color: white;
            transition: all 0.3s ease;
            border: none;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 233, 123, 0.4);
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: white;
            transition: all 0.3s ease;
            border: none;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(250, 112, 154, 0.4);
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: white;
            transition: all 0.3s ease;
            border: none;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        /* Enhanced Product Cards - FIXED TEXT COLORS */
        .product-card-transparent {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
            /* Added text color */
        }


        .product-card-transparent:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }

        .quick-access-transparent {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
            /* Added text color */
        }

        .quick-access-transparent:hover {
            transform: scale(1.08) rotate(2deg);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        /* Enhanced Category Colors with Gradients */
        .category-bakery {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        }

        input,
        select,
        textarea {
            color: black !important;
        }

        input::placeholder {
            color: black !important;
        }

        /* Table Text Colors */
        table {
            color: black;
        }

        th {
            color: black;
        }

        td {
            color: black;
        }

        /* Manager App Specific Fixes */
        .manager-content {
            color: var(--text-primary);
        }

        /* POS App Specific Fixes */
        .pos-content-transparent {
            color: var(--text-primary);
        }

        .category-dairy {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .category-grains {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
        }

        .category-cooking {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .category-groceries {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .category-beverages {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
        }

        .category-personal-care {
            background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%);
        }

        .category-fruits {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .category-vegetables {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        .category-other {
            background: linear-gradient(135deg, #a3bded 0%, #6991c7 100%);
        }

        /* Enhanced Status Indicators */
        .status-online {
            background: var(--success-gradient);
        }

        .status-offline {
            background: var(--danger-gradient);
        }

        .status-busy {
            background: var(--warning-gradient);
        }

        /* Enhanced KPI Badges */
        .kpi-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .kpi-positive {
            background: var(--success-gradient);
            color: white;
        }

        .kpi-negative {
            background: var(--danger-gradient);
            color: white;
        }

        .kpi-neutral {
            background: var(--light-gradient);
            color: var(--text-primary);
        }

        /* Enhanced Animations */
        .fade-in {
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .delay-1 {
            animation-delay: 0.1s;
        }

        .delay-2 {
            animation-delay: 0.2s;
        }

        .delay-3 {
            animation-delay: 0.3s;
        }

        .delay-4 {
            animation-delay: 0.4s;
        }

        /* Enhanced Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-gradient);
        }

        /* Enhanced Table Styles */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        /* Enhanced Utility Classes */
        .shadow-glow {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.4);
        }

        .text-shadow {
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .backdrop-blur {
            backdrop-filter: blur(20px);
        }

        .border-glow {
            box-shadow: 0 0 15px var(--primary-color), 0 0 30px var(--accent-color);
        }

        /* Enhanced Loading States */
        .btn-loading {
            position: relative;
            color: transparent;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            top: 50%;
            left: 50%;
            margin-left: -12px;
            margin-top: -12px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        /* Enhanced Focus styles for accessibility */
        .login-input:focus-visible {
            outline: 3px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
        }

        .btn:focus-visible {
            outline: 3px solid rgba(255, 255, 255, 0.8);
            outline-offset: 3px;
        }

        /* Enhanced Notification Dot */
        .notification-dot {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            background: var(--danger-gradient);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
            animation: pulse 2s infinite;
        }

        /* Enhanced Batch Badge */
        .batch-badge {
            background: var(--accent-gradient);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        /* Enhanced Category Section */
        .category-section {
            margin-bottom: 3rem;
        }

        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--border-color);
        }

        .category-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        /* Enhanced Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--warning-gradient);
            color: white;
            text-align: center;
            padding: 1rem;
            font-weight: 600;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(250, 112, 154, 0.4);
        }

        /* Enhanced Responsive Button Styles */
        .responsive-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            text-align: center;
            border: none;
            outline: none;
            min-height: 48px;
            min-width: 48px;
            padding: 1rem 2rem;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .responsive-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .responsive-btn:hover::before {
            left: 100%;
        }

        .responsive-btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .responsive-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .responsive-btn-secondary {
            background: var(--secondary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }

        .responsive-btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        }

        .responsive-btn-accent {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .responsive-btn-accent:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .responsive-btn-danger {
            background: var(--danger-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .responsive-btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .responsive-btn-warning {
            background: var(--warning-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3);
        }

        .responsive-btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(250, 112, 154, 0.4);
        }

        .responsive-btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .responsive-btn-outline:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        /* Hover effects for all interactive elements */
        .interactive-element {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .interactive-element:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Gradient text effects */
        .gradient-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Card hover effects */
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* Professional shimmer effect for loading */
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        /* Enhanced focus states for better accessibility */
        .focus-enhanced:focus {
            outline: 3px solid var(--accent-color);
            outline-offset: 3px;
            box-shadow: 0 0 0 6px rgba(79, 172, 254, 0.1);
        }

        /* Professional badge styles */
        .badge-professional {
            background: var(--primary-gradient);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Enhanced responsive design for gradients */
        @media (max-width: 768px) {
            .manager-sidebar {
                transform: translateX(-100%);
            }

            .manager-sidebar.mobile-open {
                transform: translateX(0);
            }

            .manager-content {
                margin-left: 0;
            }

            .modal-content {
                margin: 0.5rem;
                width: 95%;
                border-radius: 16px;
            }

            .pos-cart-transparent {
                position: fixed;
                right: 0;
                top: 0;
                height: 100vh;
                width: 100%;
                z-index: 40;
                transform: translateX(100%);
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .pos-cart-transparent.mobile-open {
                transform: translateX(0);
            }

            /* Adjust gradients for mobile performance */
            .loyalty-card,
            .stat-card,
            .btn-primary,
            .btn-secondary,
            .btn-accent {
                background-attachment: scroll;
            }
        }

        @media (max-width: 640px) {
            .login-container {
                padding: 1rem;
            }

            .glass-effect {
                margin: 0.5rem;
            }

            .video-background {
                display: none;
            }

            .video-overlay {
                background: var(--primary-gradient);
            }

            /* Simplify gradients for very small screens */
            .responsive-btn,
            .badge-professional,
            .kpi-badge {
                background: var(--primary-color);
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .glass-effect {
                background: rgba(255, 255, 255, 0.95);
                color: #000;
                border: 2px solid #000;
            }

            .login-input {
                background: rgba(255, 255, 255, 0.95) !important;
                color: #000 !important;
                border: 2px solid #000 !important;
            }

            /* Use solid colors instead of gradients */
            .btn-primary,
            .btn-secondary,
            .btn-accent,
            .stat-card,
            .loyalty-card {
                background: var(--primary-color) !important;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {

            .spinner,
            .logo-container,
            .floating-element,
            .login-btn,
            .password-toggle,
            .responsive-btn,
            .product-card-transparent,
            .dashboard-card {
                animation: none;
                transition: none;
            }

            .loyalty-card:hover,
            .stat-card:hover,
            .product-card-transparent:hover,
            .dashboard-card:hover {
                transform: none;
            }
        }

        /* Dark mode support with gradients */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #0f172a;
                --text-primary: #f1f5f9;
                --text-secondary: #cbd5e1;
                --border-color: #334155;
                --card-bg: #f5f7fa;
            }

            .glass-effect {
                background: rgba(30, 41, 59, 0.8);
            }

            .login-input {
                background: rgba(30, 41, 59, 0.6) !important;
                color: #f1f5f9 !important;
            }

            .dashboard-card,
            .product-card-transparent,
            .quick-access-transparent {
                background: linear-gradient(135deg, #fafafc 0%, #d3daf1 100%);
            }
        }

        /* Print styles for receipts */
        @media print {
            body * {
                visibility: hidden;
            }

            .receipt-print,
            .receipt-print * {
                visibility: visible;
            }

            .receipt-print {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }

            .modal-content {
                box-shadow: none;
                border: none;
            }

            button {
                display: none !important;
            }
        }

        /* Ensure modal backdrop doesn't interfere with print */
        @media print {
            .modal-overlay {
                position: relative;
                background: transparent;
            }
        }
    </style>
</head>

<body class="bg-gray-100 theme-blue">
    <div id="root"></div>

    <script type="text/babel">
        // ============================================================================
        // ENHANCED PROFITPOINT POS PRO - COMPLETE RETAIL MANAGEMENT SYSTEM
        // ============================================================================

        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const { jsPDF } = window.jspdf;

        // Enhanced localStorage functions with error handling and fallbacks
        const safeParseJSON = (key, defaultValue = []) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (error) {
                console.error(`Error parsing ${key} from localStorage:`, error);
                return defaultValue;
            }
        };

        const safeSetJSON = (key, value) => {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (error) {
                console.error(`Error saving ${key} to localStorage:`, error);
                return false;
            }
        };

        // Enhanced ID generation with timestamp and randomness
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // Enhanced currency formatting with localization
        const formatCurrency = (amount) => {
            if (typeof amount !== 'number' || isNaN(amount)) return 'TZS 0';
            return `TZS ${amount.toLocaleString()}`;
        };

        // Enhanced date/time formatting with validation
        const formatDate = (date) => {
            try {
                return new Date(date).toLocaleDateString('en-GB');
            } catch (error) {
                return new Date().toLocaleDateString('en-GB');
            }
        };

        const formatTime = (date) => {
            try {
                return new Date(date).toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return new Date().toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        };

        const formatDateTime = (date) => {
            return `${formatDate(date)} ${formatTime(date)}`;
        };

        // Enhanced profit calculation with validation
        const calculateProfit = (buyPrice, sellPrice) => {
            const bp = parseFloat(buyPrice) || 0;
            const sp = parseFloat(sellPrice) || 0;
            return sp - bp;
        };

        // Enhanced expiry checking with validation
        const isExpiringSoon = (expiryDate) => {
            if (!expiryDate) return false;
            try {
                const expiry = new Date(expiryDate);
                const now = new Date();
                const diffTime = expiry - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 7 && diffDays > 0;
            } catch (error) {
                return false;
            }
        };

        // Enhanced ABC Analysis with error handling
        const performABC = (products) => {
            if (!products || !Array.isArray(products)) return [];

            const productsWithValue = products
                .filter(p => p && p.items_sold > 0)
                .map(p => ({
                    ...p,
                    value: (p.sell_price || 0) * (p.items_sold || 0)
                }))
                .sort((a, b) => (b.value || 0) - (a.value || 0));

            let totalValue = productsWithValue.reduce((sum, p) => sum + (p.value || 0), 0);
            if (totalValue === 0) return productsWithValue.map(p => ({ ...p, abc_category: 'C' }));

            let cumulative = 0;
            let aThreshold = totalValue * 0.8;
            let bThreshold = totalValue * 0.95;

            return productsWithValue.map(p => {
                cumulative += p.value || 0;
                let category = 'C';
                if (cumulative <= aThreshold) category = 'A';
                else if (cumulative <= bThreshold) category = 'B';
                return { ...p, abc_category: category };
            });
        };

        // Enhanced Toast Component with auto-dismiss and types
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColor = type === 'error' ? 'bg-red-500' :
                type === 'warning' ? 'bg-yellow-500' : 'bg-green-500';

            return (
                <div className={`${bgColor} text-white px-4 py-2 rounded-lg shadow-lg toast-enter mb-2`}>
                    <div className="flex items-center justify-between">
                        <span>{message}</span>
                        <button onClick={onClose} className="ml-4 text-white hover:text-gray-200 responsive-btn responsive-btn-outline">
                            <i className="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            );
        };

        // Enhanced Modal Component with accessibility
        const Modal = ({ isOpen, title, onClose, children, size = 'medium', showCloseButton = true }) => {
            if (!isOpen) return null;

            const sizeClasses = {
                small: 'max-w-md',
                medium: 'max-w-2xl',
                large: 'max-w-4xl',
                xlarge: 'max-w-6xl',
                full: 'max-w-full mx-4'
            };

            // Handle escape key
            useEffect(() => {
                const handleEscape = (e) => {
                    if (e.key === 'Escape') onClose();
                };

                if (isOpen) {
                    document.addEventListener('keydown', handleEscape);
                    document.body.style.overflow = 'hidden';
                }

                return () => {
                    document.removeEventListener('keydown', handleEscape);
                    document.body.style.overflow = 'unset';
                };
            }, [isOpen, onClose]);

            return (
                <div className="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
                    <div className={`modal-content ${sizeClasses[size]}`}>
                        <div className="p-6">
                            {(title || showCloseButton) && (
                                <div className="flex justify-between items-center mb-4">
                                    {title && <h2 id="modal-title" className="text-xl font-bold text-gray-800">{title}</h2>}
                                    {showCloseButton && (
                                        <button
                                            onClick={onClose}
                                            className="text-gray-500 hover:text-gray-700 text-xl focus:outline-none focus:ring-2 focus:ring-blue-500 rounded responsive-btn responsive-btn-outline"
                                            aria-label="Close modal"
                                        >
                                            <i className="fas fa-times"></i>
                                        </button>
                                    )}
                                </div>
                            )}
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================================================
        // MISSING MODAL COMPONENTS - ADDED
        // ============================================================================

        // User Modal Component
        const UserModal = ({ isOpen, onClose, onSave, user }) => {
            const [formData, setFormData] = useState({
                username: '',
                password: '',
                display_name: '',
                role: 'operator',
                status: 'active',
                permissions: ['pos', 'view_sales']
            });

            useEffect(() => {
                if (user) {
                    setFormData({
                        username: user.username || '',
                        password: '',
                        display_name: user.display_name || '',
                        role: user.role || 'operator',
                        status: user.status || 'active',
                        permissions: user.permissions || ['pos', 'view_sales']
                    });
                } else {
                    setFormData({
                        username: '',
                        password: '',
                        display_name: '',
                        role: 'operator',
                        status: 'active',
                        permissions: ['pos', 'view_sales']
                    });
                }
            }, [user]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={user ? 'Edit User' : 'Add User'}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                            <input
                                type="text"
                                value={formData.username}
                                onChange={(e) => setFormData({ ...formData, username: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                {user ? 'New Password (leave blank to keep current)' : 'Password *'}
                            </label>
                            <input
                                type="password"
                                value={formData.password}
                                onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required={!user}
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Display Name *</label>
                            <input
                                type="text"
                                value={formData.display_name}
                                onChange={(e) => setFormData({ ...formData, display_name: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Role</label>
                                <select
                                    value={formData.role}
                                    onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="operator">Operator</option>
                                    <option value="manager">Manager</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select
                                    value={formData.status}
                                    onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>

                        <div className="flex justify-end space-x-3 pt-4 responsive-btn-group">
                            <button
                                type="button"
                                onClick={onClose}
                                className="responsive-btn responsive-btn-outline responsive-btn-full-mobile"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                            >
                                {user ? 'Update User' : 'Add User'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };

        // Product Modal Component
        const ProductModal = ({ isOpen, onClose, onSave, product }) => {
            const [formData, setFormData] = useState({
                name: '',
                barcode: '',
                category: '',
                buy_price: 0,
                sell_price: 0,
                available_stock: 0,
                reorder_level: 0,
                expiration_date: ''
            });

            useEffect(() => {
                if (product) {
                    setFormData({
                        name: product.name || '',
                        barcode: product.barcode || '',
                        category: product.category || '',
                        buy_price: product.buy_price || 0,
                        sell_price: product.sell_price || 0,
                        available_stock: product.available_stock || 0,
                        reorder_level: product.reorder_level || 0,
                        expiration_date: product.expiration_date || ''
                    });
                } else {
                    setFormData({
                        name: '',
                        barcode: '',
                        category: '',
                        buy_price: 0,
                        sell_price: 0,
                        available_stock: 0,
                        reorder_level: 0,
                        expiration_date: ''
                    });
                }
            }, [product]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={product ? 'Edit Product' : 'Add Product'}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
                            <input
                                type="text"
                                value={formData.name}
                                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                                <input
                                    type="text"
                                    value={formData.barcode}
                                    onChange={(e) => setFormData({ ...formData, barcode: e.target.value })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                <input
                                    type="text"
                                    value={formData.category}
                                    onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Buy Price (TZS)</label>
                                <input
                                    type="number"
                                    value={formData.buy_price}
                                    onChange={(e) => setFormData({ ...formData, buy_price: parseFloat(e.target.value) || 0 })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    min="0"
                                    step="0.01"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Sell Price (TZS)</label>
                                <input
                                    type="number"
                                    value={formData.sell_price}
                                    onChange={(e) => setFormData({ ...formData, sell_price: parseFloat(e.target.value) || 0 })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    min="0"
                                    step="0.01"
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Available Stock</label>
                                <input
                                    type="number"
                                    value={formData.available_stock}
                                    onChange={(e) => setFormData({ ...formData, available_stock: parseInt(e.target.value) || 0 })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    min="0"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Reorder Level</label>
                                <input
                                    type="number"
                                    value={formData.reorder_level}
                                    onChange={(e) => setFormData({ ...formData, reorder_level: parseInt(e.target.value) || 0 })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    min="0"
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Expiration Date</label>
                            <input
                                type="date"
                                value={formData.expiration_date}
                                onChange={(e) => setFormData({ ...formData, expiration_date: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                        </div>

                        <div className="flex justify-end space-x-3 pt-4 responsive-btn-group">
                            <button
                                type="button"
                                onClick={onClose}
                                className="responsive-btn responsive-btn-outline responsive-btn-full-mobile"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                            >
                                {product ? 'Update Product' : 'Add Product'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };

        // Enhanced System Settings Modal Component
        const SystemSettingsModal = ({ isOpen, onClose, onSave, settings }) => {
            const [formData, setFormData] = useState({
                supermarketName: '',
                branchLocation: '',
                phoneNumber: '',
                slogan: '',
                receiptFooter: '',
                theme: 'blue',
                logo: null,
                wallpaper: null,
                wallpaperOpacity: 10,
                // New settings
                currency: 'USD',
                taxRate: 0,
                printReceipt: true,
                receiptLogo: true,
                barcodePrinting: true,
                lowStockAlert: 5,
                autoLogout: 30,
                language: 'en'
            });

            useEffect(() => {
                if (settings) {
                    setFormData(settings);
                }
            }, [settings]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            const handleFileUpload = (field, file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    setFormData({
                        ...formData,
                        [field]: {
                            file: file,
                            preview: e.target.result,
                            name: file.name
                        }
                    });
                };
                reader.readAsDataURL(file);
            };

            const removeFile = (field) => {
                setFormData({ ...formData, [field]: null });
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="System Settings" size="large">
                    <form onSubmit={handleSubmit} className="space-y-6">
                        {/* Basic Information Section */}
                        <div className="border-b border-gray-200 pb-4">
                            <h3 className="text-lg font-medium text-gray-900 mb-4">Basic Information</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Supermarket Name *</label>
                                    <input
                                        type="text"
                                        required
                                        value={formData.supermarketName}
                                        onChange={(e) => setFormData({ ...formData, supermarketName: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Branch Location</label>
                                    <input
                                        type="text"
                                        value={formData.branchLocation}
                                        onChange={(e) => setFormData({ ...formData, branchLocation: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                                    <input
                                        type="text"
                                        value={formData.phoneNumber}
                                        onChange={(e) => setFormData({ ...formData, phoneNumber: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Theme</label>
                                    <select
                                        value={formData.theme}
                                        onChange={(e) => setFormData({ ...formData, theme: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="blue">Blue</option>
                                        <option value="green">Green</option>
                                        <option value="purple">Purple</option>
                                        <option value="orange">Orange</option>
                                        <option value="red">Red</option>
                                        <option value="dark">Dark</option>
                                    </select>
                                </div>
                            </div>

                            <div className="mt-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Slogan</label>
                                <input
                                    type="text"
                                    value={formData.slogan}
                                    onChange={(e) => setFormData({ ...formData, slogan: e.target.value })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Your store slogan or tagline"
                                />
                            </div>
                        </div>

                        {/* Logo & Wallpaper Section */}
                        <div className="border-b border-gray-200 pb-4">
                            <h3 className="text-lg font-medium text-gray-900 mb-4">Appearance</h3>

                            {/* Logo Upload */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Store Logo</label>
                                <div className="flex items-center space-x-4">
                                    {formData.logo ? (
                                        <div className="flex items-center space-x-4">
                                            <img
                                                src={formData.logo.preview}
                                                alt="Logo preview"
                                                className="w-16 h-16 object-contain border rounded"
                                            />
                                            <div>
                                                <p className="text-sm text-gray-600">{formData.logo.name}</p>
                                                <button
                                                    type="button"
                                                    onClick={() => removeFile('logo')}
                                                    className="text-red-600 text-sm hover:text-red-800"
                                                >
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="border-2 border-dashed border-gray-300 rounded-md p-4 text-center">
                                            <input
                                                type="file"
                                                accept="image/*"
                                                onChange={(e) => handleFileUpload('logo', e.target.files[0])}
                                                className="hidden"
                                                id="logo-upload"
                                            />
                                            <label htmlFor="logo-upload" className="cursor-pointer">
                                                <div className="text-gray-400 mb-1">
                                                    <svg className="w-8 h-8 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                    </svg>
                                                </div>
                                                <span className="text-sm text-gray-600">Click to upload logo</span>
                                                <p className="text-xs text-gray-500 mt-1">PNG, JPG up to 2MB</p>
                                            </label>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Wallpaper Upload */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">POS Wallpaper</label>
                                <div className="flex items-center space-x-4">
                                    {formData.wallpaper ? (
                                        <div className="flex items-center space-x-4">
                                            <img
                                                src={formData.wallpaper.preview}
                                                alt="Wallpaper preview"
                                                className="w-24 h-16 object-cover border rounded"
                                            />
                                            <div>
                                                <p className="text-sm text-gray-600">{formData.wallpaper.name}</p>
                                                <button
                                                    type="button"
                                                    onClick={() => removeFile('wallpaper')}
                                                    className="text-red-600 text-sm hover:text-red-800"
                                                >
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="border-2 border-dashed border-gray-300 rounded-md p-4 text-center">
                                            <input
                                                type="file"
                                                accept="image/*"
                                                onChange={(e) => handleFileUpload('wallpaper', e.target.files[0])}
                                                className="hidden"
                                                id="wallpaper-upload"
                                            />
                                            <label htmlFor="wallpaper-upload" className="cursor-pointer">
                                                <div className="text-gray-400 mb-1">
                                                    <svg className="w-8 h-8 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                    </svg>
                                                </div>
                                                <span className="text-sm text-gray-600">Click to upload wallpaper</span>
                                                <p className="text-xs text-gray-500 mt-1">PNG, JPG up to 5MB</p>
                                            </label>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Wallpaper Opacity */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Wallpaper Opacity: {formData.wallpaperOpacity}%
                                </label>
                                <input
                                    type="range"
                                    min="0"
                                    max="100"
                                    value={formData.wallpaperOpacity}
                                    onChange={(e) => setFormData({ ...formData, wallpaperOpacity: parseInt(e.target.value) })}
                                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                />
                                <div className="flex justify-between text-xs text-gray-500">
                                    <span>Transparent</span>
                                    <span>Opaque</span>
                                </div>
                            </div>
                        </div>

                        {/* Receipt Settings */}
                        <div className="border-b border-gray-200 pb-4">
                            <h3 className="text-lg font-medium text-gray-900 mb-4">Receipt Settings</h3>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        checked={formData.printReceipt}
                                        onChange={(e) => setFormData({ ...formData, printReceipt: e.target.checked })}
                                        className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                    />
                                    <label className="ml-2 block text-sm text-gray-700">Auto-print receipts</label>
                                </div>

                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        checked={formData.receiptLogo}
                                        onChange={(e) => setFormData({ ...formData, receiptLogo: e.target.checked })}
                                        className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                    />
                                    <label className="ml-2 block text-sm text-gray-700">Include logo on receipts</label>
                                </div>

                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        checked={formData.barcodePrinting}
                                        onChange={(e) => setFormData({ ...formData, barcodePrinting: e.target.checked })}
                                        className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                    />
                                    <label className="ml-2 block text-sm text-gray-700">Print barcode on receipts</label>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Receipt Footer Message</label>
                                <textarea
                                    value={formData.receiptFooter}
                                    onChange={(e) => setFormData({ ...formData, receiptFooter: e.target.value })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    rows="3"
                                    placeholder="Thank you for shopping with us!"
                                />
                            </div>
                        </div>

                        {/* Business Settings */}
                        <div className="border-b border-gray-200 pb-4">
                            <h3 className="text-lg font-medium text-gray-900 mb-4">Business Settings</h3>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                                    <select
                                        value={formData.currency}
                                        onChange={(e) => setFormData({ ...formData, currency: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="USD">USD ($)</option>
                                        <option value="EUR">EUR (€)</option>
                                        <option value="GBP">GBP (£)</option>
                                        <option value="JPY">JPY (¥)</option>
                                        <option value="CAD">CAD (C$)</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Tax Rate (%)</label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="50"
                                        step="0.1"
                                        value={formData.taxRate}
                                        onChange={(e) => setFormData({ ...formData, taxRate: parseFloat(e.target.value) })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Low Stock Alert Level</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={formData.lowStockAlert}
                                        onChange={(e) => setFormData({ ...formData, lowStockAlert: parseInt(e.target.value) })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Auto Logout (minutes)</label>
                                    <select
                                        value={formData.autoLogout}
                                        onChange={(e) => setFormData({ ...formData, autoLogout: parseInt(e.target.value) })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value={0}>Never</option>
                                        <option value={5}>5 minutes</option>
                                        <option value={15}>15 minutes</option>
                                        <option value={30}>30 minutes</option>
                                        <option value={60}>1 hour</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        {/* System Preferences */}
                        <div>
                            <h3 className="text-lg font-medium text-gray-900 mb-4">System Preferences</h3>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Language</label>
                                    <select
                                        value={formData.language}
                                        onChange={(e) => setFormData({ ...formData, language: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="en">English</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="de">German</option>
                                        <option value="zh">Chinese</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-end space-x-3 pt-4 responsive-btn-group">
                            <button
                                type="button"
                                onClick={onClose}
                                className="responsive-btn responsive-btn-outline responsive-btn-full-mobile"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                            >
                                Save Settings
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };

        // ============================================================================
        // NEW ENHANCED FEATURES COMPONENTS
        // ============================================================================

        // Barcode Scanner Component
        const BarcodeScanner = ({ isOpen, onClose, onScan }) => {
            const videoRef = useRef(null);
            const [isScanning, setIsScanning] = useState(false);
            const [hasPermission, setHasPermission] = useState(null);

            useEffect(() => {
                if (isOpen) {
                    startScanner();
                } else {
                    stopScanner();
                }

                return () => {
                    stopScanner();
                };
            }, [isOpen]);

            const startScanner = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });
                    setHasPermission(true);
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        setIsScanning(true);
                    }
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    setHasPermission(false);
                }
            };

            const stopScanner = () => {
                if (videoRef.current && videoRef.current.srcObject) {
                    videoRef.current.srcObject.getTracks().forEach(track => track.stop());
                    setIsScanning(false);
                }
            };

            const handleManualInput = (barcode) => {
                onScan(barcode);
                onClose();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Barcode Scanner" size="medium">
                    <div className="space-y-4">
                        {hasPermission === false ? (
                            <div className="text-center p-8">
                                <i className="fas fa-camera-slash text-4xl text-gray-400 mb-4"></i>
                                <p className="text-gray-600 mb-4">Camera access denied. Please allow camera access to use barcode scanner.</p>
                                <div className="space-y-3">
                                    <p className="text-sm text-gray-500">Or enter barcode manually:</p>
                                    <input
                                        type="text"
                                        placeholder="Enter barcode"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                handleManualInput(e.target.value);
                                            }
                                        }}
                                    />
                                    <button
                                        onClick={() => document.querySelector('input').focus()}
                                        className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                                    >
                                        Enter Manually
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <>
                                <div className="barcode-scanner">
                                    <video
                                        ref={videoRef}
                                        autoPlay
                                        playsInline
                                        className="barcode-video"
                                    />
                                    <div className="barcode-overlay">
                                        <div className="barcode-frame"></div>
                                    </div>
                                </div>

                                <div className="flex justify-between items-center">
                                    <p className="text-sm text-gray-600">
                                        Point camera at barcode to scan automatically
                                    </p>
                                    <button
                                        onClick={() => document.querySelector('input').focus()}
                                        className="text-blue-600 hover:text-blue-800 text-sm responsive-btn responsive-btn-outline"
                                    >
                                        Enter manually
                                    </button>
                                </div>

                                <input
                                    type="text"
                                    placeholder="Or enter barcode manually"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') {
                                            handleManualInput(e.target.value);
                                        }
                                    }}
                                />
                            </>
                        )}
                    </div>
                </Modal>
            );
        };

        // Loyalty Program Component
        const LoyaltyProgram = ({ isOpen, onClose, customer, onPointsUpdate }) => {
            const [points, setPoints] = useState(customer?.loyaltyPoints || 0);
            const [transactionAmount, setTransactionAmount] = useState('');
            const [action, setAction] = useState('earn'); // 'earn' or 'redeem'

            const calculatePoints = (amount) => {
                // 1 point per 1000 TZS spent
                return Math.floor(amount / 1000);
            };

            const calculateRedeemValue = (points) => {
                // 100 points = 1000 TZS discount
                return (points / 100) * 1000;
            };

            const handleSubmit = () => {
                const amount = parseFloat(transactionAmount) || 0;
                let newPoints = points;

                if (action === 'earn') {
                    const earnedPoints = calculatePoints(amount);
                    newPoints += earnedPoints;
                    setPoints(newPoints);
                    onPointsUpdate(customer.id, newPoints, earnedPoints);
                } else {
                    const redeemValue = calculateRedeemValue(amount);
                    if (amount <= points) {
                        newPoints -= amount;
                        setPoints(newPoints);
                        onPointsUpdate(customer.id, newPoints, -amount, redeemValue);
                    } else {
                        alert('Not enough points to redeem');
                        return;
                    }
                }
                onClose();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Loyalty Program">
                    <div className="space-y-6">
                        {/* Loyalty Card Display */}
                        <div className="loyalty-card">
                            <div className="relative z-10">
                                <h3 className="text-lg font-bold mb-2">{customer?.name}'s Loyalty Card</h3>
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-blue-100">Current Points</p>
                                        <p className="text-3xl font-bold">{points}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-blue-100">Reward Value</p>
                                        <p className="text-xl font-bold">{formatCurrency(calculateRedeemValue(points))}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Action Selection */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Action</label>
                            <div className="grid grid-cols-2 gap-4">
                                <button
                                    onClick={() => setAction('earn')}
                                    className={`responsive-btn ${action === 'earn'
                                        ? 'responsive-btn-primary'
                                        : 'responsive-btn-outline'
                                        }`}
                                >
                                    <i className="fas fa-plus-circle mr-2"></i>
                                    Earn Points
                                </button>
                                <button
                                    onClick={() => setAction('redeem')}
                                    className={`responsive-btn ${action === 'redeem'
                                        ? 'responsive-btn-primary'
                                        : 'responsive-btn-outline'
                                        }`}
                                >
                                    <i className="fas fa-gift mr-2"></i>
                                    Redeem Points
                                </button>
                            </div>
                        </div>

                        {/* Transaction Details */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                {action === 'earn' ? 'Transaction Amount (TZS)' : 'Points to Redeem'}
                            </label>
                            <input
                                type="number"
                                value={transactionAmount}
                                onChange={(e) => setTransactionAmount(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder={action === 'earn' ? 'Enter amount' : 'Enter points'}
                            />
                        </div>

                        {/* Calculation Preview */}
                        {transactionAmount && (
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <h4 className="font-medium text-gray-800 mb-2">Calculation</h4>
                                {action === 'earn' ? (
                                    <div className="space-y-1 text-sm">
                                        <p>Transaction: {formatCurrency(parseFloat(transactionAmount))}</p>
                                        <p>Points to earn: {calculatePoints(parseFloat(transactionAmount))}</p>
                                        <p className="font-medium text-green-600">
                                            New total: {points + calculatePoints(parseFloat(transactionAmount))} points
                                        </p>
                                    </div>
                                ) : (
                                    <div className="space-y-1 text-sm">
                                        <p>Points to redeem: {transactionAmount}</p>
                                        <p>Discount value: {formatCurrency(calculateRedeemValue(parseFloat(transactionAmount)))}</p>
                                        <p className="font-medium text-blue-600">
                                            Remaining points: {points - parseFloat(transactionAmount)}
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Action Buttons */}
                        <div className="flex justify-end space-x-3 pt-4 border-t border-gray-200 responsive-btn-group">
                            <button
                                onClick={onClose}
                                className="responsive-btn responsive-btn-outline responsive-btn-full-mobile"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={!transactionAmount}
                                className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                            >
                                {action === 'earn' ? 'Add Points' : 'Redeem Points'}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // Multi-Store Management Component
        const MultiStoreManager = ({ isOpen, onClose, stores, onStoreChange }) => {
            const [newStore, setNewStore] = useState({
                name: '',
                location: '',
                manager: '',
                phone: '',
                address: ''
            });

            const handleAddStore = () => {
                if (!newStore.name || !newStore.location) {
                    alert('Please fill in store name and location');
                    return;
                }

                const store = {
                    id: generateId(),
                    ...newStore,
                    isActive: true,
                    createdAt: new Date().toISOString()
                };

                const updatedStores = [...stores, store];
                safeSetJSON('stores', updatedStores);
                setNewStore({ name: '', location: '', manager: '', phone: '', address: '' });
            };

            const handleStoreSelect = (storeId) => {
                onStoreChange(storeId);
                onClose();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Multi-Store Management" size="large">
                    <div className="space-y-6">
                        {/* Current Stores */}
                        <div>
                            <h3 className="text-lg font-medium text-gray-800 mb-4">Available Stores</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {stores.map(store => (
                                    <div key={store.id} className="store-card bg-white p-4 rounded-lg shadow-sm">
                                        <div className="flex justify-between items-start mb-2">
                                            <h4 className="font-bold text-gray-800">{store.name}</h4>
                                            <span className={`px-2 py-1 text-xs rounded-full ${store.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                                }`}>
                                                {store.isActive ? 'Active' : 'Inactive'}
                                            </span>
                                        </div>
                                        <p className="text-sm text-gray-600 mb-2">{store.location}</p>
                                        <p className="text-sm text-gray-500 mb-3">Manager: {store.manager}</p>
                                        <div className="flex space-x-2 responsive-btn-group">
                                            <button
                                                onClick={() => handleStoreSelect(store.id)}
                                                className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                                            >
                                                Select Store
                                            </button>
                                            <button className="responsive-btn responsive-btn-outline">
                                                <i className="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Add New Store */}
                        <div className="border-t pt-6">
                            <h3 className="text-lg font-medium text-gray-800 mb-4">Add New Store</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Store Name</label>
                                    <input
                                        type="text"
                                        value={newStore.name}
                                        onChange={(e) => setNewStore({ ...newStore, name: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Enter store name"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                    <input
                                        type="text"
                                        value={newStore.location}
                                        onChange={(e) => setNewStore({ ...newStore, location: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Enter location"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Manager</label>
                                    <input
                                        type="text"
                                        value={newStore.manager}
                                        onChange={(e) => setNewStore({ ...newStore, manager: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Enter manager name"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                    <input
                                        type="text"
                                        value={newStore.phone}
                                        onChange={(e) => setNewStore({ ...newStore, phone: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Enter phone number"
                                    />
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                    <textarea
                                        value={newStore.address}
                                        onChange={(e) => setNewStore({ ...newStore, address: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Enter full address"
                                        rows="3"
                                    />
                                </div>
                            </div>
                            <div className="flex justify-end mt-4">
                                <button
                                    onClick={handleAddStore}
                                    className="responsive-btn responsive-btn-secondary responsive-btn-full-mobile"
                                >
                                    Add Store
                                </button>
                            </div>
                        </div>
                    </div>
                </Modal>
            );
        };

        // Customer Management Component
        const CustomerManagement = ({ isOpen, onClose, customers, onCustomerUpdate }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [showAddForm, setShowAddForm] = useState(false);
            const [newCustomer, setNewCustomer] = useState({
                name: '',
                phone: '',
                email: '',
                address: ''
            });

            const filteredCustomers = useMemo(() => {
                return customers.filter(customer =>
                    customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    customer.phone.includes(searchTerm) ||
                    customer.email.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [customers, searchTerm]);

            const handleAddCustomer = () => {
                if (!newCustomer.name || !newCustomer.phone) {
                    alert('Please fill in customer name and phone number');
                    return;
                }

                const customer = {
                    id: generateId(),
                    ...newCustomer,
                    loyaltyPoints: 0,
                    totalSpent: 0,
                    visitCount: 0,
                    createdAt: new Date().toISOString(),
                    lastVisit: new Date().toISOString()
                };

                const updatedCustomers = [...customers, customer];
                safeSetJSON('customers', updatedCustomers);
                onCustomerUpdate(updatedCustomers);
                setNewCustomer({ name: '', phone: '', email: '', address: '' });
                setShowAddForm(false);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Customer Management" size="large">
                    <div className="space-y-6">
                        {/* Search and Add */}
                        <div className="flex justify-between items-center responsive-btn-group">
                            <div className="flex-1 max-w-md">
                                <input
                                    type="text"
                                    placeholder="Search customers..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                            <button
                                onClick={() => setShowAddForm(true)}
                                className="responsive-btn responsive-btn-secondary responsive-btn-full-mobile"
                            >
                                <i className="fas fa-plus mr-2"></i>
                                Add Customer
                            </button>
                        </div>

                        {/* Add Customer Form */}
                        {showAddForm && (
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <h3 className="text-lg font-medium text-gray-800 mb-4">Add New Customer</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                                        <input
                                            type="text"
                                            value={newCustomer.name}
                                            onChange={(e) => setNewCustomer({ ...newCustomer, name: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Enter customer name"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                                        <input
                                            type="text"
                                            value={newCustomer.phone}
                                            onChange={(e) => setNewCustomer({ ...newCustomer, phone: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Enter phone number"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input
                                            type="email"
                                            value={newCustomer.email}
                                            onChange={(e) => setNewCustomer({ ...newCustomer, email: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Enter email address"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                        <input
                                            type="text"
                                            value={newCustomer.address}
                                            onChange={(e) => setNewCustomer({ ...newCustomer, address: e.target.value })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Enter address"
                                        />
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-3 mt-4 responsive-btn-group">
                                    <button
                                        onClick={() => setShowAddForm(false)}
                                        className="responsive-btn responsive-btn-outline responsive-btn-full-mobile"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleAddCustomer}
                                        className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                                    >
                                        Add Customer
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Customers List */}
                        <div className="bg-white rounded-lg shadow-sm overflow-hidden">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loyalty Points</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Spent</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Visit</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredCustomers.map(customer => (
                                        <tr key={customer.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <div className="flex items-center">
                                                    <div className="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
                                                        <i className="fas fa-user text-blue-500"></i>
                                                    </div>
                                                    <div className="ml-4">
                                                        <div className="text-sm font-medium text-gray-900">{customer.name}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <div className="text-sm text-gray-900">{customer.phone}</div>
                                                <div className="text-sm text-gray-500">{customer.email}</div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                                    {customer.loyaltyPoints} points
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                {formatCurrency(customer.totalSpent || 0)}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {customer.visitCount || 0}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {customer.lastVisit ? formatDate(customer.lastVisit) : 'Never'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </Modal>
            );
        };

        // Enhanced Login Component
        const LoginView = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [videoError, setVideoError] = useState(false);

            const handleLogin = (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');

                // Simulate API call
                setTimeout(() => {
                    // Demo credentials
                    if ((username === 'operator' && password === 'operator123') ||
                        (username === 'manager' && password === 'manager123')) {

                        const user = {
                            id: generateId(),
                            username: username,
                            display_name: username === 'operator' ? 'POS Operator' : 'Store Manager',
                            role: username === 'operator' ? 'operator' : 'manager',
                            permissions: username === 'operator' ? ['pos', 'view_sales'] : ['all'],
                            loginTime: new Date().toISOString(),
                            currentStore: 'store-1'
                        };

                        safeSetJSON('currentUser', user);
                        localStorage.setItem('userLoginTime', new Date().toISOString());
                        onLogin(user);
                    } else {
                        setError('Invalid username or password');
                    }
                    setIsLoading(false);
                }, 1000);
            };

            const handleVideoError = () => {
                setVideoError(true);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
                    <div className="video-background">
                        {!videoError ? (
                            <video
                                autoPlay
                                muted
                                loop
                                className="video-background"
                                onError={handleVideoError}
                                poster="images/wallaper1.jpg"
                            >
                                <source src="images/video.mp4" type="video/mp4" />
                                <source src="images/video.webm" type="video/webm" />
                            </video>
                        ) : (
                            <div
                                className="video-background"
                                style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' }}
                            />
                        )}
                    </div>

                    {/* Dark overlay */}
                    <div className="video-overlay"></div>

                    {/* Animated Background Elements */}
                    <div className="absolute inset-0 overflow-hidden">
                        <div className="absolute -top-40 -right-40 w-80 h-80 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse"></div>
                        <div className="absolute -bottom-40 -left-40 w-80 h-80 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse delay-1000"></div>
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-indigo-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse delay-500"></div>
                    </div>

                    <div className="relative w-full max-w-md z-10">
                        {/* Main Login Card */}
                        <div className="glass-effect rounded-3xl shadow-2xl border border-white/20 overflow-hidden">
                            {/* Header Section with Logo */}
                            <div className="bg-glass-effect p-8 text-center">
                                <div className="flex justify-center mb-4">
                                    <div className="relative">
                                        {/* Logo Container */}
                                        <div className="w-22 h-22  backdrop-blur-sm  shadow-lg flex items-center justify-center  hover:rotate-0 transition-transform duration-300 overflow-hidden">
                                            <img
                                                src="images/ProfitPointPOS Logo Design.png"
                                                alt="ProfitPointPOS Logo"
                                                className="w-full h-full object-contain p-2"
                                                draggable="false"
                                            />
                                        </div>

                                        {/* Animated Ring */}
                                        <div className="absolute inset-0 border-4 border-white/30 rounded-2xl animate-ping pointer-events-none"></div>
                                    </div>
                                </div>
                            </div>


                            <div className="p-8">
                                <form onSubmit={handleLogin} className="space-y-6">
                                    {/* Username Field */}
                                    <div className="space-y-2">
                                        <label className="flex items-center text-sm font-medium text-white">
                                            <i className="fas fa-user mr-2 text-blue-400"></i>
                                            Username
                                        </label>
                                        <div className="relative">
                                            <input
                                                type="text"
                                                value={username}
                                                onChange={(e) => setUsername(e.target.value)}
                                                className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 login-input"
                                                placeholder="Enter your username"
                                                required
                                                aria-label="Username"
                                                disabled={isLoading}
                                            />
                                            <div className="absolute right-3 top-3 text-gray-300">
                                                <i className="fas fa-user-circle"></i>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Password Field */}
                                    <div className="space-y-2">
                                        <label className="flex items-center text-sm font-medium text-white">
                                            <i className="fas fa-lock mr-2 text-blue-400"></i>
                                            Password
                                        </label>
                                        <div className="relative">
                                            <input
                                                type={showPassword ? "text" : "password"}
                                                value={password}
                                                onChange={(e) => setPassword(e.target.value)}
                                                className="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 login-input"
                                                placeholder="Enter your password"
                                                required
                                                aria-label="Password"
                                                disabled={isLoading}
                                            />
                                            <button
                                                type="button"
                                                onClick={() => setShowPassword(!showPassword)}
                                                className="absolute right-3 top-3 p-2 text-gray-400 hover:text-blue-500 focus:text-blue-500 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
                                                aria-label={showPassword ? "Hide password" : "Show password"}
                                                aria-pressed={showPassword}
                                                disabled={isLoading}
                                                tabIndex={0}
                                            >
                                                <i
                                                    className={`fas ${showPassword ? "fa-eye-slash" : "fa-eye"} text-lg`}
                                                    aria-hidden="true"
                                                ></i>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Error Message */}
                                    {error && (
                                        <div className="bg-red-500/20 border border-red-500/30 text-red-200 px-4 py-3 rounded-lg flex items-center" role="alert">
                                            <i className="fas fa-exclamation-triangle mr-2"></i>
                                            {error}
                                        </div>
                                    )}

                                    {/* Login Button */}
                                    <button
                                        type="submit"
                                        disabled={isLoading}
                                        className="responsive-btn responsive-btn-primary responsive-btn-full-mobile login-btn"
                                        aria-label="Sign In"
                                    >
                                        {isLoading ? (
                                            <>
                                                <div className="spinner mr-2"></div>
                                                Verifying User...
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-sign-in-alt mr-2"></i>
                                                Sign In
                                            </>
                                        )}
                                    </button>
                                </form>

                                {/* Footer */}
                                <div className="mt-6 text-center">
                                    <p className="text-gray-400 text-xs">
                                        Powered By ProfitPoint POS • Version 3.0 Pro
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Floating Elements */}
                        <div className="absolute -z-10 top-10 -left-10 w-20 h-20 bg-blue-500/10 rounded-full blur-lg"></div>
                        <div className="absolute -z-10 bottom-10 -right-10 w-20 h-20 bg-purple-500/10 rounded-full blur-lg"></div>
                    </div>
                </div>
            );
        };
        // Enhanced Payment Processing Components
        const CashPaymentModal = ({ isOpen, onClose, cartTotal, onPaymentComplete }) => {
            const [amountReceived, setAmountReceived] = useState('');
            const [change, setChange] = useState(0);

            useEffect(() => {
                const received = parseFloat(amountReceived) || 0;
                setChange(Math.max(0, received - cartTotal));
            }, [amountReceived, cartTotal]);

            const handlePayment = () => {
                if (parseFloat(amountReceived) >= cartTotal) {
                    onPaymentComplete({
                        method: 'cash',
                        amountReceived: parseFloat(amountReceived),
                        change: change,
                        total: cartTotal
                    });
                    onClose();
                }
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Cash Payment">
                    <div className="space-y-4">
                        <div className="bg-blue-50 p-4 rounded-lg">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-gray-600">Total Amount:</span>
                                <span className="text-xl font-bold text-blue-600">{formatCurrency(cartTotal)}</span>
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-100 mb-1">
                                Amount Received (TZS)
                            </label>
                            <input
                                type="number"
                                value={amountReceived}
                                onChange={(e) => setAmountReceived(e.target.value)}
                                className="w-full px-3 py-2 text-secondary: #0a0a0a border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Enter amount received"
                                autoFocus
                            />
                        </div>

                        {change > 0 && (
                            <div className="bg-green-50 p-4 rounded-lg">
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-600">Change to Give:</span>
                                    <span className="text-xl font-bold text-green-600">{formatCurrency(change)}</span>
                                </div>
                            </div>
                        )}

                        {parseFloat(amountReceived) < cartTotal && (
                            <div className="bg-red-50 p-4 rounded-lg">
                                <p className="text-red-600 text-sm">
                                    Insufficient amount. Need {formatCurrency(cartTotal - parseFloat(amountReceived))} more.
                                </p>
                            </div>
                        )}

                        <div className="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                            <button
                                onClick={onClose}
                                className="responsive-btn responsive-btn-outline"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handlePayment}
                                disabled={!amountReceived || parseFloat(amountReceived) < cartTotal}
                                className="responsive-btn responsive-btn-primary"
                            >
                                Complete Payment
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const MobilePaymentModal = ({ isOpen, onClose, cartTotal, onPaymentComplete }) => {
            const [phoneNumber, setPhoneNumber] = useState('');
            const [paymentMethod, setPaymentMethod] = useState('mpesa');

            const handlePayment = () => {
                if (phoneNumber) {
                    onPaymentComplete({
                        method: paymentMethod,
                        phoneNumber: phoneNumber,
                        transactionId: 'TXN' + Date.now(),
                        total: cartTotal
                    });
                    onClose();
                }
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Mobile Payment">
                    <div className="space-y-4">
                        <div className="bg-blue-50 p-4 rounded-lg">
                            <div className="flex justify-between items-center">
                                <span className="text-gray-600">Total Amount:</span>
                                <span className="text-xl font-bold text-blue-600">{formatCurrency(cartTotal)}</span>
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Payment Method
                            </label>
                            <select
                                value={paymentMethod}
                                onChange={(e) => setPaymentMethod(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="mpesa">M-PESA</option>
                                <option value="airtelmoney">Airtel Money</option>
                                <option value="tigopesa">Tigo Pesa</option>
                                <option value="halopesa">Halo Pesa</option>
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Phone Number
                            </label>
                            <input
                                type="tel"
                                value={phoneNumber}
                                onChange={(e) => setPhoneNumber(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="255712345678"
                            />
                        </div>

                        <div className="bg-yellow-50 p-4 rounded-lg">
                            <p className="text-yellow-700 text-sm">
                                <i className="fas fa-info-circle mr-2"></i>
                                A payment request will be sent to the provided phone number.
                            </p>
                        </div>

                        <div className="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                            <button
                                onClick={onClose}
                                className="responsive-btn responsive-btn-outline"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handlePayment}
                                disabled={!phoneNumber}
                                className="responsive-btn responsive-btn-primary"
                            >
                                Send Payment Request
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };
        const ReceiptModal = ({ isOpen, onClose, sale, settings }) => {
            if (!sale) return null;

            const printReceipt = () => {
                window.print();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Sale Receipt" size="small">
                    <div className="bg-white text-blue-800 p-6 receipt-print">
                        {/* Receipt Header */}
                        <div className="text-center mb-4">
                            {settings?.logo && (
                                <img
                                    src={settings.logo}
                                    alt="Store Logo"
                                    className="h-16 mx-auto mb-2"
                                />
                            )}
                            <h2 className="text-xl font-bold">{settings?.supermarketName || 'ProfitPoint POS Pro'}</h2>
                            {settings?.branchLocation && (
                                <p className="text-gray-600">{settings.branchLocation}</p>
                            )}
                            {settings?.phoneNumber && (
                                <p className="text-gray-600">{settings.phoneNumber}</p>
                            )}
                            <div className="border-t border-gray-300 my-2"></div>
                        </div>

                        {/* Receipt Details */}
                        <div className="mb-4">
                            <div className="flex justify-between text-sm mb-2">
                                <span>Receipt #:</span>
                                <span className="font-mono">{sale.id.slice(-8).toUpperCase()}</span>
                            </div>
                            <div className="flex justify-between text-sm mb-2">
                                <span>Date:</span>
                                <span>{formatDate(sale.date)}</span>
                            </div>
                            <div className="flex justify-between text-sm mb-2">
                                <span>Time:</span>
                                <span>{formatTime(sale.date)}</span>
                            </div>
                            <div className="flex justify-between text-sm mb-2">
                                <span>Cashier:</span>
                                <span>{sale.user_name}</span>
                            </div>
                        </div>

                        {/* Items List */}
                        <div className="border-t border-gray-300 pt-2 mb-4">
                            <div className="flex justify-between text-sm font-bold mb-2">
                                <span>Item</span>
                                <span>Total</span>
                            </div>
                            {sale.items.map((item, index) => (
                                <div key={index} className="flex justify-between text-sm mb-1">
                                    <div>
                                        <span>{item.name}</span>
                                        <span className="text-gray-500 ml-2">x{item.quantity}</span>
                                    </div>
                                    <span>{formatCurrency(item.total)}</span>
                                </div>
                            ))}
                        </div>

                        {/* Totals */}
                        <div className="border-t border-gray-300 pt-2">
                            <div className="flex justify-between text-sm mb-1">
                                <span>Subtotal:</span>
                                <span>{formatCurrency(sale.subtotal)}</span>
                            </div>
                            <div className="flex justify-between text-sm mb-1">
                                <span>Tax:</span>
                                <span>{formatCurrency(sale.tax)}</span>
                            </div>
                            {sale.loyaltyDiscount > 0 && (
                                <div className="flex justify-between text-sm mb-1 text-green-600">
                                    <span>Loyalty Discount:</span>
                                    <span>-{formatCurrency(sale.loyaltyDiscount)}</span>
                                </div>
                            )}
                            <div className="flex justify-between font-bold text-lg mt-2">
                                <span>TOTAL:</span>
                                <span>{formatCurrency(sale.total)}</span>
                            </div>
                        </div>

                        {/* Payment Method */}
                        <div className="border-t border-gray-300 pt-2 mt-4">
                            <div className="flex justify-between text-sm">
                                <span>Payment Method:</span>
                                <span className="capitalize">{sale.payment_method}</span>
                            </div>
                            {sale.payment_details?.change > 0 && (
                                <div className="flex justify-between text-sm">
                                    <span>Change:</span>
                                    <span>{formatCurrency(sale.payment_details.change)}</span>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="text-center mt-6">
                            {settings?.receiptFooter && (
                                <p className="text-sm text-gray-600">{settings.receiptFooter}</p>
                            )}
                            <p className="text-xs text-gray-500 mt-2">
                                Thank you for your business!
                            </p>
                        </div>
                    </div>

                    <div className="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button
                            onClick={printReceipt}
                            className="responsive-btn responsive-btn-primary"
                        >
                            <i className="fas fa-print mr-2"></i>
                            Print Receipt
                        </button>
                        <button
                            onClick={onClose}
                            className="responsive-btn responsive-btn-outline"
                        >
                            Close
                        </button>
                    </div>
                </Modal>
            );
        };
        const QuickAccessManager = ({ isOpen, onClose, products, currentQuickAccess, onSave }) => {
            const [selectedProducts, setSelectedProducts] = useState(currentQuickAccess.map(p => p.id));

            const toggleProduct = (productId) => {
                setSelectedProducts(prev => {
                    if (prev.includes(productId)) {
                        return prev.filter(id => id !== productId);
                    } else if (prev.length < 6) {
                        return [...prev, productId];
                    } else {
                        return prev;
                    }
                });
            };

            const handleSave = () => {
                const selected = products.filter(p => selectedProducts.includes(p.id));
                onSave(selected.slice(0, 6)); // Limit to 6 products
                onClose();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Manage Quick Access Products" size="large">
                    <div className="space-y-4">
                        <div className="bg-blue-50 p-4 rounded-lg">
                            <p className="text-blue-700 text-sm">
                                <i className="fas fa-info-circle mr-2"></i>
                                Select up to 6 products to display in the quick access section.
                                These will be easily accessible from the POS interface.
                            </p>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
                            {products.map(product => (
                                <div
                                    key={product.id}
                                    onClick={() => toggleProduct(product.id)}
                                    className={`border-2 rounded-lg p-4 cursor-pointer transition-all ${selectedProducts.includes(product.id)
                                        ? 'border-blue-500 bg-blue-50'
                                        : 'border-gray-200 hover:border-gray-300'
                                        }`}
                                >
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center">
                                            <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                                <i className="fas fa-box text-blue-500"></i>
                                            </div>
                                            <div>
                                                <h3 className="font-medium text-gray-800">{product.name}</h3>
                                                <p className="text-sm text-gray-500">{formatCurrency(product.sell_price)}</p>
                                            </div>
                                        </div>
                                        {selectedProducts.includes(product.id) && (
                                            <i className="fas fa-check text-blue-500"></i>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="flex justify-between items-center pt-4 border-t border-gray-200">
                            <span className="text-sm text-gray-600">
                                {selectedProducts.length} of 6 products selected
                            </span>
                            <div className="flex space-x-3">
                                <button
                                    onClick={onClose}
                                    className="responsive-btn responsive-btn-outline"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleSave}
                                    className="responsive-btn responsive-btn-primary"
                                >
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </Modal>
            );
        };


        // ============================================================================
        // ENHANCED POS APPLICATION WITH NEW FEATURES
        // ============================================================================

        const POSApp = ({ currentUser, onLogout, settings }) => {
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [showMobilePayment, setShowMobilePayment] = useState(false);
            const [showCashPayment, setShowCashPayment] = useState(false);
            const [showReceipt, setShowReceipt] = useState(false);
            const [currentSale, setCurrentSale] = useState(null);
            const [toasts, setToasts] = useState([]);
            const [showQuickAccessManager, setShowQuickAccessManager] = useState(false);
            const [quickAccessProducts, setQuickAccessProducts] = useState([]);
            const [loginTime] = useState(localStorage.getItem('userLoginTime') || new Date().toISOString());
            const [showBarcodeScanner, setShowBarcodeScanner] = useState(false);
            const [showLoyaltyProgram, setShowLoyaltyProgram] = useState(false);
            const [showCustomerManagement, setShowCustomerManagement] = useState(false);
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [customers, setCustomers] = useState([]);
            const [isOffline, setIsOffline] = useState(!navigator.onLine);
            const cartTotal = useMemo(() => {
                return cart.reduce((total, item) => total + (item.sell_price * item.quantity), 0);
            }, [cart]);
            const handleBarcodeScan = (barcode) => {
                const product = products.find(p => p.barcode === barcode);
                if (product) {
                    addToCart(product);
                    showToast(`Scanned: ${product.name}`);
                } else {
                    showToast('Product not found', 'error');
                }
            };

            const Header = () => (
                <header className="pos-header-transparent px-4 sm:px-6 py-4 border-b border-gray-200">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center">
                            {settings?.logo ? (
                                <img src={settings.logo} alt="Logo" className="h-10 w-10 mr-3" />
                            ) : (
                                <i className="fas fa-shopping-cart text-blue-500 text-2xl mr-3"></i>
                            )}
                            <div>
                                <h1 className="text-xl font-bold text-gray-800">
                                    {settings?.supermarketName || 'ProfitPoint POS Pro'}
                                </h1>
                                <p className="text-sm text-gray-600">Welcome, {currentUser.display_name}</p>
                            </div>
                        </div>
                        <div className="flex items-center space-x-3">
                            <button
                                onClick={() => setShowBarcodeScanner(true)}
                                className="responsive-btn responsive-btn-primary"
                            >
                                <i className="fas fa-barcode mr-2"></i>
                                Scan
                            </button>
                            <button
                                onClick={() => setShowCustomerManagement(true)}
                                className="responsive-btn responsive-btn-outline"
                            >
                                <i className="fas fa-users mr-2"></i>
                                Customers
                            </button>
                            <button
                                onClick={onLogout}
                                className="responsive-btn responsive-btn-danger"
                            >
                                <i className="fas fa-sign-out-alt mr-2"></i>
                                Logout
                            </button>
                        </div>
                    </div>
                </header>
            );

            const SearchBar = () => (
                <div className="mb-6">
                    <div className="relative">
                        <input
                            type="text"
                            placeholder="Search products by name or barcode..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full px-4 py-3 pl-12 bg-primary-gradient border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <i className="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
            );

            const QuickAccessSection = () => (
                <div className="mb-6">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg font-bold text-gray-800">Quick Access</h2>
                        <button
                            onClick={() => setShowQuickAccessManager(true)}
                            className="text-blue-600 hover:text-blue-800 text-sm responsive-btn responsive-btn-outline"
                        >
                            <i className="fas fa-edit mr-1"></i>
                            Manage
                        </button>
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3">
                        {quickAccessProducts.map(product => (
                            <div
                                key={product.id}
                                onClick={() => addToCart(product)}
                                className="quick-access-transparent p-4 text-center cursor-pointer"
                            >
                                <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-2">
                                    <i className="fas fa-box text-blue-500"></i>
                                </div>
                                <p className="text-sm font-medium text-gray-800 truncate">{product.name}</p>
                                <p className="text-xs text-gray-600">{formatCurrency(product.sell_price)}</p>
                            </div>
                        ))}

                        {quickAccessProducts.length === 0 && (
                            <div className="col-span-full text-center py-4 text-gray-500">
                                <p>No quick access products set up</p>
                                <button
                                    onClick={() => setShowQuickAccessManager(true)}
                                    className="text-blue-600 hover:text-blue-800 text-sm mt-2"
                                >
                                    Click here to add some
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );

            const ProductsGrid = () => {
                const filteredProducts = products.filter(product =>
                    product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    product.barcode.includes(searchTerm)
                );

                return (
                    <div>
                        <h2 className="text-lg font-bold text-gray-800 mb-4">All Products</h2>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                            {filteredProducts.map(product => (
                                <div
                                    key={product.id}
                                    onClick={() => addToCart(product)}
                                    className="product-card-transparent p-4 cursor-pointer"
                                >
                                    <div className="flex items-center mb-3">
                                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                            <i className="fas fa-box text-blue-500"></i>
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="font-medium text-gray-800 truncate">{product.name}</h3>
                                            <p className="text-sm text-gray-600">{product.category}</p>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="font-bold text-gray-800">{formatCurrency(product.sell_price)}</span>
                                        <span className={`text-xs px-2 py-1 rounded-full ${product.available_stock > 10
                                            ? 'bg-green-100 text-green-800'
                                            : product.available_stock > 0
                                                ? 'bg-yellow-100 text-yellow-800'
                                                : 'bg-red-100 text-red-800'
                                            }`}>
                                            {product.available_stock} in stock
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {filteredProducts.length === 0 && (
                            <div className="text-center py-8 text-gray-500">
                                <i className="fas fa-search text-4xl mb-3"></i>
                                <p>No products found</p>
                                <p className="text-sm">Try adjusting your search terms</p>
                            </div>
                        )}
                    </div>
                );
            };

            const CartSection = () => (
                <div className="h-full flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-white">Current Sale</h2>
                        <button
                            onClick={clearCart}
                            className="text-white hover:text-gray-300 responsive-btn responsive-btn-outline"
                            disabled={cart.length === 0}
                        >
                            <i className="fas fa-trash mr-2"></i>
                            Clear
                        </button>
                    </div>

                    {/* Customer Selection */}
                    <div className="mb-4">
                        <label className="block text-white text-sm font-medium mb-2">Customer</label>
                        <div className="flex space-x-2">
                            <select
                                value={selectedCustomer?.id || ''}
                                onChange={(e) => {
                                    const customer = customers.find(c => c.id === e.target.value);
                                    setSelectedCustomer(customer || null);
                                }}
                                className="flex-1 px-3 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">Walk-in Customer</option>
                                {customers.map(customer => (
                                    <option key={customer.id} value={customer.id}>
                                        {customer.name} ({customer.phone})
                                    </option>
                                ))}
                            </select>
                            {selectedCustomer && (
                                <button
                                    onClick={() => setShowLoyaltyProgram(true)}
                                    className="responsive-btn responsive-btn-accent"
                                >
                                    <i className="fas fa-crown"></i>
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Cart Items */}
                    <div className="flex-1 overflow-y-auto custom-scrollbar mb-4">
                        {cart.length === 0 ? (
                            <div className="text-center py-8 text-gray-400">
                                <i className="fas fa-shopping-cart text-4xl mb-3"></i>
                                <p>Cart is empty</p>
                                <p className="text-sm">Add products to get started</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {cart.map(item => (
                                    <div key={item.id} className="bg-gray-700 rounded-lg p-3">
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="flex-1">
                                                <h3 className="font-medium text-white">{item.name}</h3>
                                                <p className="text-gray-300 text-sm">{formatCurrency(item.sell_price)} each</p>
                                            </div>
                                            <button
                                                onClick={() => removeFromCart(item.id)}
                                                className="text-red-400 hover:text-red-300 ml-2"
                                            >
                                                <i className="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center space-x-2">
                                                <button
                                                    onClick={() => updateQuantity(item.id, item.quantity - 1)}
                                                    className="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-white hover:bg-gray-500"
                                                >
                                                    -
                                                </button>
                                                <span className="text-white font-medium w-8 text-center">{item.quantity}</span>
                                                <button
                                                    onClick={() => updateQuantity(item.id, item.quantity + 1)}
                                                    className="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-white hover:bg-gray-500"
                                                >
                                                    +
                                                </button>
                                            </div>
                                            <span className="text-white font-bold">
                                                {formatCurrency(item.sell_price * item.quantity)}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Cart Summary */}
                    {cart.length > 0 && (
                        <div className="bg-gray-800 rounded-lg p-4 mb-4">
                            <div className="space-y-2">
                                <div className="flex justify-between text-white">
                                    <span>Subtotal:</span>
                                    <span>{formatCurrency(cartTotal)}</span>
                                </div>
                                {selectedCustomer && selectedCustomer.loyaltyPoints > 0 && (
                                    <div className="flex justify-between text-green-400">
                                        <span>Loyalty Discount:</span>
                                        <span>-{formatCurrency((selectedCustomer.loyaltyPoints / 100) * 1000)}</span>
                                    </div>
                                )}
                                <div className="flex justify-between text-xl font-bold text-white border-t border-gray-600 pt-2">
                                    <span>TOTAL:</span>
                                    <span>
                                        {formatCurrency(
                                            Math.max(0, cartTotal - (selectedCustomer ? (selectedCustomer.loyaltyPoints / 100) * 1000 : 0))
                                        )}
                                    </span>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Payment Buttons */}
                    {cart.length > 0 && (
                        <div className="space-y-3">
                            <button
                                onClick={() => setShowCashPayment(true)}
                                className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                            >
                                <i className="fas fa-money-bill-wave mr-2"></i>
                                Cash Payment
                            </button>
                            <button
                                onClick={() => setShowMobilePayment(true)}
                                className="responsive-btn responsive-btn-secondary responsive-btn-full-mobile"
                            >
                                <i className="fas fa-mobile-alt mr-2"></i>
                                Mobile Payment
                            </button>
                        </div>
                    )}
                </div>
            );
            // Initialize data
            useEffect(() => {
                const savedProducts = safeParseJSON('products', []);
                const savedQuickAccess = safeParseJSON('quickAccessProducts', []);
                const savedCustomers = safeParseJSON('customers', []);

                setProducts(savedProducts);
                setQuickAccessProducts(savedQuickAccess);
                setCustomers(savedCustomers);

                if (savedProducts.length === 0) {
                    createSampleProducts();
                }

                // Set up offline detection
                const handleOnline = () => setIsOffline(false);
                const handleOffline = () => setIsOffline(true);

                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Cart functions
            const addToCart = (product) => {
                if (product.available_stock <= 0) {
                    showToast(`${product.name} is out of stock`, 'error');
                    return;
                }

                const existingItem = cart.find(item => item.id === product.id);

                if (existingItem) {
                    if (existingItem.quantity >= product.available_stock) {
                        showToast(`Only ${product.available_stock} units available`, 'warning');
                        return;
                    }
                    setCart(cart.map(item =>
                        item.id === product.id
                            ? { ...item, quantity: item.quantity + 1 }
                            : item
                    ));
                } else {
                    setCart([...cart, {
                        ...product,
                        quantity: 1,
                        batchNumber: product.batch_number,
                        scanned: false
                    }]);
                }

            };

            const updateQuantity = (productId, newQuantity) => {
                if (newQuantity < 1) {
                    removeFromCart(productId);
                    return;
                }

                const product = products.find(p => p.id === productId);
                if (product && newQuantity > product.available_stock) {
                    showToast(`Only ${product.available_stock} units available`, 'warning');
                    return;
                }

                setCart(cart.map(item =>
                    item.id === productId
                        ? { ...item, quantity: newQuantity }
                        : item
                ));
            };



            const clearCart = () => {
                setCart([]);
                showToast('Cart cleared');
            };

            // Payment handling
            const handleCashPayment = (paymentDetails) => {
                completeSale({
                    ...paymentDetails,
                    method: 'cash'
                });
            };

            const handleMobilePayment = (paymentDetails) => {
                completeSale({
                    ...paymentDetails,
                    method: paymentDetails.paymentMethod || 'mpesa'
                });
            };

            const completeSale = (paymentDetails) => {
                // Calculate sale details
                const subtotal = cart.reduce((total, item) => total + (item.sell_price * item.quantity), 0);
                const tax = 0;
                const loyaltyDiscount = selectedCustomer ? (selectedCustomer.loyaltyPoints / 100) * 1000 : 0;
                const total = Math.max(0, subtotal + tax - loyaltyDiscount);

                // Create sale record
                const sale = {
                    id: generateId(),
                    date: new Date().toISOString(),
                    user_id: currentUser.id,
                    user_name: currentUser.display_name,
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        quantity: item.quantity,
                        unit_price: item.sell_price,
                        total: item.sell_price * item.quantity,
                        profit: calculateProfit(item.buy_price, item.sell_price) * item.quantity
                    })),
                    subtotal: subtotal,
                    tax: tax,
                    total: total,
                    total_profit: cart.reduce((total, item) => total + (calculateProfit(item.buy_price, item.sell_price) * item.quantity), 0),
                    payment_method: paymentDetails.method,
                    payment_details: paymentDetails,
                    loyaltyDiscount: loyaltyDiscount,
                    customer: selectedCustomer
                };

                // Update products stock
                const updatedProducts = products.map(product => {
                    const cartItem = cart.find(item => item.id === product.id);
                    if (cartItem) {
                        return {
                            ...product,
                            available_stock: Math.max(0, product.available_stock - cartItem.quantity),
                            items_sold: (product.items_sold || 0) + cartItem.quantity
                        };
                    }
                    return product;
                });

                // Update customer loyalty points if applicable
                let updatedCustomers = customers;
                if (selectedCustomer && loyaltyDiscount === 0) {
                    const pointsEarned = Math.floor(total / 1000);
                    updatedCustomers = customers.map(customer =>
                        customer.id === selectedCustomer.id
                            ? {
                                ...customer,
                                loyaltyPoints: (customer.loyaltyPoints || 0) + pointsEarned,
                                totalSpent: (customer.totalSpent || 0) + total,
                                visitCount: (customer.visitCount || 0) + 1,
                                lastVisit: new Date().toISOString()
                            }
                            : customer
                    );
                    setCustomers(updatedCustomers);
                    safeSetJSON('customers', updatedCustomers);
                }

                // Save data
                const existingSales = safeParseJSON('sales', []);
                const updatedSales = [...existingSales, sale];

                safeSetJSON('sales', updatedSales);
                safeSetJSON('products', updatedProducts);

                setProducts(updatedProducts);
                setCurrentSale(sale);
                setCart([]);

                showToast('Sale completed successfully!');
                setShowReceipt(true);
            };

            // Toast system
            const showToast = (message, type = 'success') => {
                const id = generateId();
                const toast = { id, message, type };
                setToasts(prev => [...prev, toast]);

                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 5000);
            };

            // Quick access management
            const saveQuickAccessProducts = (newQuickAccess) => {
                setQuickAccessProducts(newQuickAccess);
                safeSetJSON('quickAccessProducts', newQuickAccess);
                showToast('Quick access products updated');
            };

            // Customer management
            const handleCustomerUpdate = (updatedCustomers) => {
                setCustomers(updatedCustomers);
            };

            const handleLoyaltyPointsUpdate = (customerId, newPoints, pointsChange, discountValue = 0) => {
                const updatedCustomers = customers.map(customer =>
                    customer.id === customerId
                        ? { ...customer, loyaltyPoints: newPoints }
                        : customer
                );
                setCustomers(updatedCustomers);
                safeSetJSON('customers', updatedCustomers);

                if (pointsChange > 0) {
                    showToast(`${pointsChange} points added to customer`);
                } else {
                    showToast(`${Math.abs(pointsChange)} points redeemed for ${formatCurrency(discountValue)} discount`);
                }
            };

            // ... (rest of the POSApp component remains the same, including all the sub-components)

            return (
                <div className="min-h-screen bg-gray-50 relative">
                    {/* Wallpaper */}
                    {settings?.wallpaper && (
                        <div
                            className="pos-wallpaper fixed inset-0 bg-cover bg-center -z-10"
                            style={{
                                backgroundImage: `url(${settings.wallpaper})`,
                                opacity: (settings.wallpaperOpacity || 10) / 100
                            }}
                        />
                    )}

                    {/* Main POS Interface */}
                    <div className="relative flex flex-col h-screen">
                        {/* Header */}
                        <Header />

                        {/* Main Content */}
                        <div className="flex flex-col lg:flex-row flex-1 overflow-hidden">
                            {/* Products Section */}
                            <div className="flex-1 p-4 sm:p-6 overflow-auto custom-scrollbar">
                                <SearchBar />
                                <QuickAccessSection />
                                <ProductsGrid />
                            </div>

                            {/* Cart Section */}
                            <div className="w-full lg:w-96 bg-gray-800 border-t lg:border-t-0 lg:border-l border-gray-200 p-4 sm:p-6 overflow-auto custom-scrollbar">
                                <CartSection />
                            </div>
                        </div>
                    </div>

                    {/* Modals */}
                    <CashPaymentModal
                        isOpen={showCashPayment}
                        onClose={() => setShowCashPayment(false)}
                        cartTotal={cartTotal}
                        onPaymentComplete={handleCashPayment}
                    />

                    <MobilePaymentModal
                        isOpen={showMobilePayment}
                        onClose={() => setShowMobilePayment(false)}
                        cartTotal={cartTotal}
                        onPaymentComplete={handleMobilePayment}
                    />

                    <ReceiptModal
                        isOpen={showReceipt}
                        onClose={() => setShowReceipt(false)}
                        sale={currentSale}
                        settings={settings}
                    />

                    <BarcodeScanner
                        isOpen={showBarcodeScanner}
                        onClose={() => setShowBarcodeScanner(false)}
                        onScan={handleBarcodeScan}
                    />

                    <LoyaltyProgram
                        isOpen={showLoyaltyProgram}
                        onClose={() => setShowLoyaltyProgram(false)}
                        customer={selectedCustomer}
                        onPointsUpdate={handleLoyaltyPointsUpdate}
                    />

                    <CustomerManagement
                        isOpen={showCustomerManagement}
                        onClose={() => setShowCustomerManagement(false)}
                        customers={customers}
                        onCustomerUpdate={handleCustomerUpdate}
                    />

                    <QuickAccessManager
                        isOpen={showQuickAccessManager}
                        onClose={() => setShowQuickAccessManager(false)}
                        products={products}
                        currentQuickAccess={quickAccessProducts}
                        onSave={saveQuickAccessProducts}
                    />

                    {/* Offline Indicator */}
                    {isOffline && (
                        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center">
                            <i className="fas fa-wifi-slash mr-2"></i>
                            Offline Mode - Data will sync when online
                        </div>
                    )}

                    {/* Toasts */}
                    <div className="fixed bottom-4 right-4 space-y-2 z-50" role="status">
                        {toasts.map(toast => (
                            <Toast
                                key={toast.id}
                                message={toast.message}
                                type={toast.type}
                                onClose={() => setToasts(prev => prev.filter(t => t.id !== toast.id))}
                            />
                        ))}
                    </div>
                </div>
            );
        };


        // ============================================================================
        // ENHANCED MANAGER APPLICATION - SINGLE DEFINITION
        // ============================================================================

        const ManagerApp = ({ currentUser, onLogout }) => {
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            const [currentView, setCurrentView] = useState('dashboard');
            const [toasts, setToasts] = useState([]);
            const [users, setUsers] = useState([]);
            const [products, setProducts] = useState([]);
            const [sales, setSales] = useState([]);
            const [lowStockProducts, setLowStockProducts] = useState([]);
            const [expiringProducts, setExpiringProducts] = useState([]);
            const [showUserModal, setShowUserModal] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [showProductModal, setShowProductModal] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [systemSettings, setSystemSettings] = useState({
                supermarketName: 'ProfitPoint POS Pro',
                branchLocation: 'Dar es Salaam, Tanzania',
                phoneNumber: '+255 123 456 789',
                slogan: 'Quality Products, Best Prices',
                receiptFooter: 'Thank you for shopping with us! Please come again.',
                theme: 'blue',
                logo: null,
                wallpaper: null,
                wallpaperOpacity: 10,
                receiptSettings: {
                    showLogo: true,
                    showSlogan: false,
                    showPhone: false,
                    showAddress: false,
                    showThankYou: true,
                    fontSize: '12px',
                    printCustomerCopy: true,
                    printMerchantCopy: false
                }
            });

            // Chart instances ref
            const chartInstances = useRef({
                revenue: null,
                category: null,
                payment: null
            });

            // Rest of the ManagerApp component code remains the same...

            // Initialize data with error handling
            useEffect(() => {
                const savedUsers = safeParseJSON('users', []);
                const savedProducts = safeParseJSON('products', []);
                const savedSales = safeParseJSON('sales', []);
                const savedSettings = safeParseJSON('systemSettings');

                setUsers(savedUsers);
                setProducts(savedProducts);
                setSales(savedSales);

                if (savedSettings) {
                    setSystemSettings(savedSettings);
                    applyTheme(savedSettings.theme);
                }

                // Calculate low stock and expiring products
                const lowStock = savedProducts.filter(p => (p.available_stock || 0) <= (p.reorder_level || 0));
                const expiring = savedProducts.filter(p => isExpiringSoon(p.expiration_date));
                setLowStockProducts(lowStock);
                setExpiringProducts(expiring);

                if (savedProducts.length === 0) {
                    createSampleProducts();
                }

                if (savedUsers.length === 0) {
                    createSampleUsers();
                }

                if (savedSales.length === 0) {
                    createSampleSales();
                }
            }, []);

            // Cleanup charts on unmount
            useEffect(() => {
                return () => {
                    // Destroy all chart instances
                    Object.values(chartInstances.current).forEach(chart => {
                        if (chart) {
                            chart.destroy();
                        }
                    });
                };
            }, []);

            // Apply theme to document
            const applyTheme = (theme) => {
                document.body.className = document.body.className.replace(/theme-\w+/g, '');
                document.body.classList.add(`theme-${theme}`);
            };

            // Create sample products with validation
            const createSampleProducts = () => {
                const sampleProducts = [
                    {
                        id: generateId(),
                        barcode: '1001',
                        name: 'Bread',
                        category: 'Bakery',
                        buy_price: 1500,
                        sell_price: 2500,
                        available_stock: 25,
                        items_sold: 0,
                        reorder_level: 10,
                        expiration_date: null
                    },
                    {
                        id: generateId(),
                        barcode: '1002',
                        name: 'Milk 1L',
                        category: 'Dairy',
                        buy_price: 2000,
                        sell_price: 3200,
                        available_stock: 15,
                        items_sold: 0,
                        reorder_level: 5,
                        expiration_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                    },
                    {
                        id: generateId(),
                        barcode: '1003',
                        name: 'Rice 5kg',
                        category: 'Grains',
                        buy_price: 12000,
                        sell_price: 15000,
                        available_stock: 32,
                        items_sold: 0,
                        reorder_level: 15,
                        expiration_date: null
                    },
                    {
                        id: generateId(),
                        barcode: '1013',
                        name: 'Apples',
                        category: 'Fruits',
                        buy_price: 800,
                        sell_price: 1500,
                        available_stock: 30,
                        items_sold: 0,
                        reorder_level: 10,
                        expiration_date: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                    },
                    {
                        id: generateId(),
                        barcode: '1014',
                        name: 'Tomatoes',
                        category: 'Vegetables',
                        buy_price: 500,
                        sell_price: 1000,
                        available_stock: 40,
                        items_sold: 0,
                        reorder_level: 15,
                        expiration_date: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                    }
                ];

                setProducts(sampleProducts);
                safeSetJSON('products', sampleProducts);

                // Recalculate low stock and expiring
                const lowStock = sampleProducts.filter(p => p.available_stock <= (p.reorder_level || 0));
                const expiring = sampleProducts.filter(p => isExpiringSoon(p.expiration_date));
                setLowStockProducts(lowStock);
                setExpiringProducts(expiring);
            };

            // Create sample users
            const createSampleUsers = () => {
                const sampleUsers = [
                    {
                        id: generateId(),
                        username: 'operator',
                        password: 'operator123',
                        display_name: 'POS Operator',
                        role: 'operator',
                        status: 'active',
                        permissions: ['pos', 'view_sales']
                    },
                    {
                        id: generateId(),
                        username: 'manager',
                        password: 'manager123',
                        display_name: 'Store Manager',
                        role: 'manager',
                        status: 'active',
                        permissions: ['all']
                    }

                ];

                setUsers(sampleUsers);
                safeSetJSON('users', sampleUsers);
            };

            // Create sample sales with validation
            const createSampleSales = () => {
                const operatorUser = users.find(u => u.role === 'operator') || { id: 'operator1', display_name: 'POS Operator' };
                const sampleProductsLocal = safeParseJSON('products', []);

                const sampleSales = [
                    {
                        id: generateId(),
                        date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                        user_id: operatorUser.id,
                        user_name: operatorUser.display_name,
                        items: [
                            {
                                id: sampleProductsLocal[0]?.id || '1',
                                name: sampleProductsLocal[0]?.name || 'Bread',
                                quantity: 2,
                                unit_price: sampleProductsLocal[0]?.sell_price || 2500,
                                total: 5000,
                                profit: 2000
                            }
                        ],
                        subtotal: 5000,
                        tax: 0,
                        total: 5000,
                        total_profit: 2000,
                        payment_method: 'cash',
                        payment_details: { amountReceived: 5000, change: 0 }
                    },
                    {
                        id: generateId(),
                        date: new Date().toISOString(),
                        user_id: operatorUser.id,
                        user_name: operatorUser.display_name,
                        items: [
                            {
                                id: sampleProductsLocal[1]?.id || '2',
                                name: sampleProductsLocal[1]?.name || 'Milk 1L',
                                quantity: 1,
                                unit_price: sampleProductsLocal[1]?.sell_price || 3200,
                                total: 3200,
                                profit: 1200
                            },
                            {
                                id: sampleProductsLocal[2]?.id || '3',
                                name: sampleProductsLocal[2]?.name || 'Rice 5kg',
                                quantity: 1,
                                unit_price: sampleProductsLocal[2]?.sell_price || 15000,
                                total: 15000,
                                profit: 3000
                            }
                        ],
                        subtotal: 18200,
                        tax: 0,
                        total: 18200,
                        total_profit: 4200,
                        payment_method: 'mpesa',
                        payment_details: { phoneNumber: '255712345678', transactionId: 'TXN123456' }
                    }
                ];

                // Update products' items_sold for demo
                const updatedProducts = sampleProductsLocal.map(p => {
                    const soldItem = sampleSales.flatMap(s => s.items).find(item => item.id === p.id);
                    if (soldItem) {
                        return { ...p, items_sold: (p.items_sold || 0) + soldItem.quantity };
                    }
                    return p;
                });

                safeSetJSON('products', updatedProducts);
                setProducts(updatedProducts);

                setSales(sampleSales);
                safeSetJSON('sales', sampleSales);
            };

            // Toast system
            const showToast = (message, type = 'success') => {
                const id = generateId();
                const toast = { id, message, type };
                setToasts(prev => [...prev, toast]);

                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            };

            // User management functions
            const openAddUserModal = () => {
                setEditingUser(null);
                setShowUserModal(true);
            };

            const openEditUserModal = (user) => {
                setEditingUser(user);
                setShowUserModal(true);
            };

            const saveUser = (userData) => {
                if (editingUser) {
                    const updatedUsers = users.map(user =>
                        user.id === editingUser.id ? { ...user, ...userData } : user
                    );
                    setUsers(updatedUsers);
                    safeSetJSON('users', updatedUsers);
                    showToast('User updated successfully');
                } else {
                    const newUser = {
                        id: generateId(),
                        ...userData
                    };
                    const updatedUsers = [...users, newUser];
                    setUsers(updatedUsers);
                    safeSetJSON('users', updatedUsers);
                    showToast('User added successfully');
                }
                setShowUserModal(false);
            };

            const deleteUser = (userId) => {
                if (userId === currentUser.id) {
                    showToast('You cannot delete your own account', 'error');
                    return;
                }

                if (window.confirm('Are you sure you want to delete this user?')) {
                    const updatedUsers = users.filter(user => user.id !== userId);
                    setUsers(updatedUsers);
                    safeSetJSON('users', updatedUsers);
                    showToast('User deleted successfully');
                }
            };

            // Product management functions
            const openAddProductModal = () => {
                setEditingProduct(null);
                setShowProductModal(true);
            };

            const openEditProductModal = (product) => {
                setEditingProduct(product);
                setShowProductModal(true);
            };

            const saveProduct = (productData) => {
                if (editingProduct) {
                    const updatedProducts = products.map(product =>
                        product.id === editingProduct.id ? { ...product, ...productData } : product
                    );
                    setProducts(updatedProducts);
                    safeSetJSON('products', updatedProducts);
                    showToast('Product updated successfully');
                } else {
                    const newProduct = {
                        id: generateId(),
                        ...productData
                    };
                    const updatedProducts = [...products, newProduct];
                    setProducts(updatedProducts);
                    safeSetJSON('products', updatedProducts);
                    showToast('Product added successfully');
                }

                // Recalculate low stock and expiring products
                const updatedProductsList = safeParseJSON('products', []);
                const lowStock = updatedProductsList.filter(p => (p.available_stock || 0) <= (p.reorder_level || 0));
                const expiring = updatedProductsList.filter(p => isExpiringSoon(p.expiration_date));
                setLowStockProducts(lowStock);
                setExpiringProducts(expiring);

                setShowProductModal(false);
            };

            const deleteProduct = (productId) => {
                if (window.confirm('Are you sure you want to delete this product?')) {
                    const updatedProducts = products.filter(product => product.id !== productId);
                    setProducts(updatedProducts);
                    safeSetJSON('products', updatedProducts);

                    // Recalculate low stock and expiring products
                    const lowStock = updatedProducts.filter(p => (p.available_stock || 0) <= (p.reorder_level || 0));
                    const expiring = updatedProducts.filter(p => isExpiringSoon(p.expiration_date));
                    setLowStockProducts(lowStock);
                    setExpiringProducts(expiring);

                    showToast('Product deleted successfully');
                }
            };

            // System settings functions
            const saveSystemSettings = (settings) => {
                setSystemSettings(settings);
                safeSetJSON('systemSettings', settings);
                applyTheme(settings.theme);
                showToast('System settings saved successfully');
                setShowSettingsModal(false);
            };

            // Delete sales in range
            const deleteSalesInRange = (startDate, endDate) => {
                if (!startDate || !endDate) {
                    showToast('Please select both start and end dates', 'error');
                    return;
                }
                if (window.confirm(`Are you sure you want to delete sales from ${formatDate(startDate)} to ${formatDate(endDate)}? This action cannot be undone.`)) {
                    const filteredSales = sales.filter(sale => {
                        const saleDate = new Date(sale.date).toISOString().split('T')[0];
                        return saleDate >= startDate && saleDate <= endDate;
                    });

                    if (filteredSales.length === 0) {
                        showToast('No sales found in the selected range', 'error');
                        return;
                    }

                    const remainingSales = sales.filter(sale => {
                        const saleDate = new Date(sale.date).toISOString().split('T')[0];
                        return saleDate < startDate || saleDate > endDate;
                    });

                    setSales(remainingSales);
                    safeSetJSON('sales', remainingSales);
                    showToast(`${filteredSales.length} sales deleted successfully`);
                }
            };

            // PDF Export function for products
            const exportProductsToPDF = () => {
                if (products.length === 0) {
                    showToast('No products data to export', 'error');
                    return;
                }

                const doc = new jsPDF();

                // Add header
                doc.setFontSize(20);
                doc.setTextColor(40, 40, 150);
                doc.text(systemSettings.supermarketName.toUpperCase() + ' - PRODUCTS INVENTORY', 105, 15, { align: 'center' });

                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated on: ${formatDateTime(new Date())}`, 105, 22, { align: 'center' });

                // Add summary section
                doc.setFontSize(14);
                doc.setTextColor(40, 40, 40);
                doc.text('PRODUCTS SUMMARY', 20, 35);

                doc.setFontSize(10);
                const totalProducts = products.length;
                const totalValue = products.reduce((total, product) => total + ((product.sell_price || 0) * (product.available_stock || 0)), 0);
                const lowStockCount = lowStockProducts.length;
                const expiringCount = expiringProducts.length;

                doc.text(`Total Products: ${totalProducts}`, 20, 45);
                doc.text(`Total Inventory Value: ${formatCurrency(totalValue)}`, 20, 52);
                doc.text(`Low Stock Items: ${lowStockCount}`, 20, 59);
                doc.text(`Expiring Soon: ${expiringCount}`, 20, 66);

                // Add products table
                const tableColumn = ["Name", "Category", "Stock", "Buy Price", "Sell Price", "Profit"];
                const tableRows = [];

                products.forEach(product => {
                    const profit = calculateProfit(product.buy_price, product.sell_price);
                    const productData = [
                        product.name,
                        product.category,
                        (product.available_stock || 0).toString(),
                        formatCurrency(product.buy_price),
                        formatCurrency(product.sell_price),
                        formatCurrency(profit)
                    ];
                    tableRows.push(productData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 80,
                    theme: 'grid',
                    headStyles: { fillColor: [59, 130, 246] },
                    styles: { fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 40 },
                        1: { cellWidth: 30 },
                        2: { cellWidth: 20 },
                        3: { cellWidth: 30 },
                        4: { cellWidth: 30 },
                        5: { cellWidth: 30 }
                    }
                });

                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Page ${i} of ${pageCount}`, 105, doc.internal.pageSize.height - 10, { align: 'center' });
                }

                // Save the PDF
                doc.save(`products_inventory_${formatDate(new Date()).replace(/\//g, '-')}.pdf`);
                showToast('Products inventory exported to PDF successfully');
            };

            // PDF Export function for sales
            const exportSalesToPDF = () => {
                if (sales.length === 0) {
                    showToast('No sales data to export', 'error');
                    return;
                }

                const doc = new jsPDF();

                // Add header
                doc.setFontSize(20);
                doc.setTextColor(40, 40, 150);
                doc.text(systemSettings.supermarketName.toUpperCase() + ' - SALES REPORT', 105, 15, { align: 'center' });

                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated on: ${formatDateTime(new Date())}`, 105, 22, { align: 'center' });

                // Add summary section
                doc.setFontSize(14);
                doc.setTextColor(40, 40, 40);
                doc.text('SALES SUMMARY', 20, 35);

                doc.setFontSize(10);
                const totalRevenue = sales.reduce((total, sale) => total + (sale.total || 0), 0);
                const totalSalesCount = sales.length;
                const totalItems = sales.reduce((total, sale) => {
                    return total + (sale.items?.reduce((itemTotal, item) => itemTotal + (item.quantity || 0), 0) || 0);
                }, 0);
                const totalProfit = sales.reduce((total, sale) => total + (sale.total_profit || 0), 0);

                doc.text(`Total Sales: ${totalSalesCount}`, 20, 45);
                doc.text(`Total Revenue: ${formatCurrency(totalRevenue)}`, 20, 52);
                doc.text(`Total Items Sold: ${totalItems}`, 20, 59);
                doc.text(`Total Profit: ${formatCurrency(totalProfit)}`, 20, 66);

                // Add sales table
                const tableColumn = ["Date", "Receipt #", "Cashier", "Items", "Total", "Profit", "Payment"];
                const tableRows = [];

                sales.slice().reverse().forEach(sale => {
                    const saleData = [
                        formatDate(sale.date),
                        sale.id.slice(-8).toUpperCase(),
                        sale.user_name,
                        (sale.items?.length || 0) + " items",
                        formatCurrency(sale.total || 0),
                        formatCurrency(sale.total_profit || 0),
                        (sale.payment_method || '').toUpperCase()
                    ];
                    tableRows.push(saleData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 80,
                    theme: 'grid',
                    headStyles: { fillColor: [59, 130, 246] },
                    styles: { fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 25 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 25 },
                        3: { cellWidth: 20 },
                        4: { cellWidth: 25 },
                        5: { cellWidth: 25 },
                        6: { cellWidth: 20 }
                    }
                });

                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Page ${i} of ${pageCount}`, 105, doc.internal.pageSize.height - 10, { align: 'center' });
                }

                // Save the PDF
                doc.save(`sales_report_${formatDate(new Date()).replace(/\//g, '-')}.pdf`);
                showToast('Sales report exported to PDF successfully');
            };

            // CSV Export function
            const exportSalesToCSV = () => {
                if (sales.length === 0) {
                    showToast('No sales data to export', 'error');
                    return;
                }

                // Prepare data for CSV
                const csvData = sales.map(sale => ({
                    'Date': formatDate(sale.date),
                    'Time': formatTime(sale.date),
                    'Receipt #': sale.id.slice(-8).toUpperCase(),
                    'Cashier': sale.user_name,
                    'Items': sale.items?.map(item => `${item.name} (${item.quantity})`).join('; ') || '',
                    'Subtotal': sale.subtotal || 0,
                    'Tax': sale.tax || 0,
                    'Total': sale.total || 0,
                    'Profit': sale.total_profit || 0,
                    'Payment Method': (sale.payment_method || '').toUpperCase()
                }));

                // Convert to CSV
                const headers = Object.keys(csvData[0]);
                const csvRows = [
                    headers.join(','),
                    ...csvData.map(row =>
                        headers.map(header => {
                            const value = row[header];
                            // Handle values that might contain commas
                            return typeof value === 'string' && value.includes(',')
                                ? `"${value}"`
                                : value;
                        }).join(',')
                    )
                ];

                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sales_report_${formatDate(new Date()).replace(/\//g, '-')}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('Sales report exported to CSV successfully');
            };

            // Export products to CSV
            const exportProductsToCSV = () => {
                if (products.length === 0) {
                    showToast('No products data to export', 'error');
                    return;
                }

                const csvData = products.map(product => ({
                    'Barcode': product.barcode,
                    'Name': product.name,
                    'Category': product.category,
                    'Buy Price': product.buy_price || 0,
                    'Sell Price': product.sell_price || 0,
                    'Profit': calculateProfit(product.buy_price, product.sell_price),
                    'Stock': product.available_stock || 0,
                    'Reorder Level': product.reorder_level || 0,
                    'Items Sold': product.items_sold || 0,
                    'Expiration Date': product.expiration_date || 'N/A'
                }));

                const headers = Object.keys(csvData[0]);
                const csvRows = [
                    headers.join(','),
                    ...csvData.map(row =>
                        headers.map(header => {
                            const value = row[header];
                            return typeof value === 'string' && value.includes(',')
                                ? `"${value}"`
                                : value;
                        }).join(',')
                    )
                ];

                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `products_inventory_${formatDate(new Date()).replace(/\//g, '-')}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('Products inventory exported to CSV successfully');
            };

            // Dashboard statistics
            const totalRevenue = useMemo(() => {
                return sales.reduce((total, sale) => total + (sale.total || 0), 0);
            }, [sales]);

            const totalProfit = useMemo(() => {
                return sales.reduce((total, sale) => total + (sale.total_profit || 0), 0);
            }, [sales]);

            const totalProducts = products.length;
            const totalUsers = users.length;
            const totalSales = sales.length;

            // Recent sales for dashboard
            const recentSales = useMemo(() => {
                return sales.slice(-5).reverse();
            }, [sales]);

            // Enhanced Dashboard Component with Fixed Charts
            const DashboardView = () => {
                const revenueChartRef = useRef(null);
                const categoryChartRef = useRef(null);
                const paymentChartRef = useRef(null);

                // Calculate real data for dashboard
                const todaySales = useMemo(() => {
                    const today = new Date().toISOString().split('T')[0];
                    return sales.filter(sale => sale.date && sale.date.includes(today));
                }, [sales]);

                const todayRevenue = todaySales.reduce((total, sale) => total + (sale.total || 0), 0);
                const todayProfit = todaySales.reduce((total, sale) => total + (sale.total_profit || 0), 0);
                const todayItemsSold = todaySales.reduce((total, sale) => {
                    return total + (sale.items?.reduce((itemTotal, item) => itemTotal + (item.quantity || 0), 0) || 0);
                }, 0);

                const weeklySales = useMemo(() => {
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                    return sales.filter(sale => new Date(sale.date) >= oneWeekAgo);
                }, [sales]);

                const weeklyRevenue = weeklySales.reduce((total, sale) => total + (sale.total || 0), 0);
                const weeklyProfit = weeklySales.reduce((total, sale) => total + (sale.total_profit || 0), 0);
                const weeklyItemsSold = weeklySales.reduce((total, sale) => {
                    return total + (sale.items?.reduce((itemTotal, item) => itemTotal + (item.quantity || 0), 0) || 0);
                }, 0);

                // Initialize charts with cleanup
                useEffect(() => {
                    if (currentView !== 'dashboard') return;

                    let revenueChart, categoryChart, paymentChart;

                    // Revenue Chart
                    if (revenueChartRef.current) {
                        const revenueCtx = revenueChartRef.current.getContext('2d');

                        // Destroy existing chart
                        if (chartInstances.current.revenue) {
                            chartInstances.current.revenue.destroy();
                        }

                        revenueChart = new Chart(revenueCtx, {
                            type: 'line',
                            data: {
                                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                                datasets: [{
                                    label: 'Revenue',
                                    data: [1250000, 1320000, 1180000, 1450000, 1580000, 1820000, 1950000],
                                    borderColor: 'rgb(59, 130, 246)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function (context) {
                                                return 'TZS ' + context.parsed.y.toLocaleString();
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function (value) {
                                                return 'TZS ' + (value / 1000000).toFixed(1) + 'M';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        chartInstances.current.revenue = revenueChart;
                    }

                    // Category Chart
                    if (categoryChartRef.current) {
                        const categoryCtx = categoryChartRef.current.getContext('2d');

                        if (chartInstances.current.category) {
                            chartInstances.current.category.destroy();
                        }

                        categoryChart = new Chart(categoryCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Groceries', 'Bakery', 'Dairy', 'Beverages', 'Personal Care', 'Fruits & Veg'],
                                datasets: [{
                                    data: [25, 15, 12, 18, 10, 20],
                                    backgroundColor: [
                                        'rgb(59, 130, 246)',
                                        'rgb(16, 185, 129)',
                                        'rgb(245, 158, 11)',
                                        'rgb(139, 92, 246)',
                                        'rgb(239, 68, 68)',
                                        'rgb(14, 165, 233)'
                                    ],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                        chartInstances.current.category = categoryChart;
                    }

                    // Payment Chart
                    if (paymentChartRef.current) {
                        const paymentCtx = paymentChartRef.current.getContext('2d');

                        if (chartInstances.current.payment) {
                            chartInstances.current.payment.destroy();
                        }

                        paymentChart = new Chart(paymentCtx, {
                            type: 'pie',
                            data: {
                                labels: ['Cash', 'M-PESA', 'Airtel Money', 'Tigo Pesa'],
                                datasets: [{
                                    data: [45, 35, 12, 8],
                                    backgroundColor: [
                                        'rgb(16, 185, 129)',
                                        'rgb(59, 130, 246)',
                                        'rgb(239, 68, 68)',
                                        'rgb(245, 158, 11)'
                                    ],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                        chartInstances.current.payment = paymentChart;
                    }

                    // Cleanup function
                    return () => {
                        if (revenueChart) revenueChart.destroy();
                        if (categoryChart) categoryChart.destroy();
                        if (paymentChart) paymentChart.destroy();
                    };
                }, [currentView]);

                // Export dashboard data
                const exportDashboardData = () => {
                    const dashboardData = {
                        'Total Revenue': formatCurrency(totalRevenue),
                        'Total Profit': formatCurrency(totalProfit),
                        'Total Sales': totalSales,
                        'Total Products': totalProducts,
                        'Total Users': totalUsers,
                        'Today Revenue': formatCurrency(todayRevenue),
                        'Today Profit': formatCurrency(todayProfit),
                        'Today Sales': todaySales.length,
                        'Weekly Revenue': formatCurrency(weeklyRevenue),
                        'Weekly Profit': formatCurrency(weeklyProfit),
                        'Weekly Sales': weeklySales.length,
                        'Low Stock Products': lowStockProducts.length,
                        'Expiring Products': expiringProducts.length
                    };

                    const csvData = Object.entries(dashboardData).map(([key, value]) => ({
                        'Metric': key,
                        'Value': value
                    }));

                    const headers = Object.keys(csvData[0]);
                    const csvRows = [
                        headers.join(','),
                        ...csvData.map(row =>
                            headers.map(header => {
                                const value = row[header];
                                return typeof value === 'string' && value.includes(',')
                                    ? `"${value}"`
                                    : value;
                            }).join(',')
                        )
                    ];

                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `dashboard_summary_${formatDate(new Date()).replace(/\//g, '-')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showToast('Dashboard data exported to CSV successfully');
                };

                return (
                    <div className="p-6">
                        <div className="mb-8">
                            <h1 className="text-2xl font-bold text-gray-800">ProfitPoint POS Pro</h1>
                            <p className="text-gray-600">Welcome back, {currentUser.display_name}. Here's what's happening today.</p>
                        </div>

                        {/* Date Range Filter */}
                        <div className="bg-white dashboard-card p-6 mb-6 fade-in">
                            <div className="flex justify-between items-center">
                                <h2 className="text-lg font-bold text-gray-800">Analytics Overview</h2>
                                <div className="flex space-x-4 responsive-btn-group">

                                    <button
                                        onClick={exportDashboardData}
                                        className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                                    >
                                        <i className="fas fa-download mr-2"></i>
                                        Export Report
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Key Metrics */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                            <div className="stat-card p-6 fade-in">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-blue-100">Total Revenue</p>
                                        <p className="text-2xl font-bold mt-2">{formatCurrency(totalRevenue)}</p>
                                        <div className="flex items-center mt-2">
                                            <span className="kpi-badge kpi-positive">
                                                <i className="fas fa-arrow-up mr-1"></i>
                                                12.5%
                                            </span>
                                            <span className="text-blue-100 text-sm ml-2">vs last period</span>
                                        </div>
                                    </div>
                                    <div className="bg-white bg-opacity-20 p-3 rounded-lg">
                                        <i className="fas fa-money-bill-wave text-white text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div className="stat-card p-6 fade-in delay-1">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-pink-100">Total Profit</p>
                                        <p className="text-2xl font-bold mt-2">{formatCurrency(totalProfit)}</p>
                                        <div className="flex items-center mt-2">
                                            <span className="kpi-badge kpi-positive">
                                                <i className="fas fa-arrow-up mr-1"></i>
                                                15.2%
                                            </span>
                                            <span className="text-pink-100 text-sm ml-2">vs last period</span>
                                        </div>
                                    </div>
                                    <div className="bg-white bg-opacity-20 p-3 rounded-lg">
                                        <i className="fas fa-chart-line text-white text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div className="stat-card p-6 fade-in delay-2">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-cyan-100">Total Sales</p>
                                        <p className="text-2xl font-bold mt-2">{totalSales}</p>
                                        <div className="flex items-center mt-2">
                                            <span className="kpi-badge kpi-positive">
                                                <i className="fas fa-arrow-up mr-1"></i>
                                                8.2%
                                            </span>
                                            <span className="text-cyan-100 text-sm ml-2">vs last period</span>
                                        </div>
                                    </div>
                                    <div className="bg-white bg-opacity-20 p-3 rounded-lg">
                                        <i className="fas fa-shopping-cart text-white text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div className="stat-card p-6 fade-in delay-3">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-green-100">Products</p>
                                        <p className="text-2xl font-bold mt-2">{totalProducts}</p>
                                        <div className="flex items-center mt-2">
                                            <span className="kpi-badge kpi-positive">
                                                <i className="fas fa-arrow-up mr-1"></i>
                                                15.7%
                                            </span>
                                            <span className="text-green-100 text-sm ml-2">vs last period</span>
                                        </div>
                                    </div>
                                    <div className="bg-white bg-opacity-20 p-3 rounded-lg">
                                        <i className="fas fa-box text-white text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div className="stat-card p-6 fade-in delay-4">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-yellow-100">Users</p>
                                        <p className="text-2xl font-bold mt-2">{totalUsers}</p>
                                        <div className="flex items-center mt-2">
                                            <span className="kpi-badge kpi-positive">
                                                <i className="fas fa-arrow-up mr-1"></i>
                                                10.2%
                                            </span>
                                            <span className="text-yellow-100 text-sm ml-2">vs last period</span>
                                        </div>
                                    </div>
                                    <div className="bg-white bg-opacity-20 p-3 rounded-lg">
                                        <i className="fas fa-users text-white text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Charts Row 1 */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            {/* Revenue Chart */}
                            <div className="bg-white dashboard-card p-6 fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-lg font-bold text-gray-800">Revenue Overview</h2>
                                    <div className="flex space-x-2 responsive-btn-group">
                                        <button className="responsive-btn responsive-btn-primary">Daily</button>
                                        <button className="responsive-btn responsive-btn-outline">Weekly</button>
                                        <button className="responsive-btn responsive-btn-outline">Monthly</button>
                                    </div>
                                </div>
                                <div className="chart-container">
                                    <canvas ref={revenueChartRef}></canvas>
                                </div>
                            </div>

                            {/* Sales by Category */}
                            <div className="bg-white dashboard-card p-6 fade-in delay-1">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-lg font-bold text-gray-800">Sales by Category</h2>
                                    <button
                                        onClick={() => setCurrentView('reports')}
                                        className="responsive-btn responsive-btn-outline"
                                    >
                                        View Details
                                    </button>
                                </div>
                                <div className="chart-container">
                                    <canvas ref={categoryChartRef}></canvas>
                                </div>
                            </div>
                        </div>

                        {/* Charts Row 2 */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            {/* Payment Methods */}
                            <div className="bg-white dashboard-card p-6 fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-lg font-bold text-gray-800">Payment Methods</h2>
                                </div>
                                <div className="chart-container">
                                    <canvas ref={paymentChartRef}></canvas>
                                </div>
                            </div>

                            {/* Top Products */}
                            <div className="bg-white dashboard-card p-6 fade-in delay-1">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-lg font-bold text-gray-800">Top Products</h2>
                                    <button
                                        onClick={() => setCurrentView('products')}
                                        className="responsive-btn responsive-btn-outline"
                                    >
                                        View All
                                    </button>
                                </div>
                                <div className="space-y-4">
                                    {products.slice(0, 5).map((product, index) => (
                                        <div key={product.id} className="flex items-center justify-between">
                                            <div className="flex items-center">
                                                <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                                    <i className="fas fa-box text-blue-600"></i>
                                                </div>
                                                <div>
                                                    <p className="font-medium text-gray-800">{product.name}</p>
                                                    <p className="text-sm text-gray-500">{product.category}</p>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-bold text-gray-800">{formatCurrency((product.sell_price || 0) * (product.items_sold || 0))}</p>
                                                <p className="text-sm text-gray-500">{product.items_sold || 0} units</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Inventory Alerts */}
                            <div className="bg-white dashboard-card p-6 fade-in delay-2">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-lg font-bold text-gray-800">Inventory Alerts</h2>
                                    <button
                                        onClick={() => setCurrentView('inventory')}
                                        className="responsive-btn responsive-btn-outline"
                                    >
                                        Manage
                                    </button>
                                </div>
                                <div className="space-y-4">
                                    {lowStockProducts.slice(0, 5).map(product => (
                                        <div key={product.id} className="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                            <div className="flex items-center">
                                                <div className="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                                                    <i className="fas fa-exclamation-triangle text-red-600"></i>
                                                </div>
                                                <div>
                                                    <p className="font-medium text-gray-800">{product.name}</p>
                                                    <p className="text-sm text-gray-500">Stock: {product.available_stock} units</p>
                                                </div>
                                            </div>
                                            <span className="text-red-600 font-medium">Low</span>
                                        </div>
                                    ))}

                                    {lowStockProducts.length === 0 && (
                                        <div className="text-center py-4">
                                            <p className="text-gray-500">All products are well stocked</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Bottom Row */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Recent Sales */}
                            <div className="bg-white dashboard-card p-6 fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-lg font-bold text-gray-800">Recent Sales</h2>
                                    <button
                                        onClick={() => setCurrentView('sales')}
                                        className="responsive-btn responsive-btn-outline"
                                    >
                                        View All
                                    </button>
                                </div>
                                <div className="space-y-4">
                                    {recentSales.map(sale => (
                                        <div key={sale.id} className="flex items-center justify-between border-b border-gray-100 pb-4">
                                            <div>
                                                <p className="font-medium text-gray-800">#{sale.id.slice(-8).toUpperCase()}</p>
                                                <p className="text-sm text-gray-500">{formatDate(sale.date)} {formatTime(sale.date)}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-bold text-gray-800">{formatCurrency(sale.total || 0)}</p>
                                                <p className="text-sm text-gray-500 capitalize">{sale.payment_method}</p>
                                                <p className="text-sm text-green-600">Profit: {formatCurrency(sale.total_profit || 0)}</p>
                                            </div>
                                        </div>
                                    ))}

                                    {recentSales.length === 0 && (
                                        <div className="text-center py-4">
                                            <p className="text-gray-500">No recent sales</p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Staff Performance */}
                            <div className="bg-white dashboard-card p-6 fade-in delay-1">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-lg font-bold text-gray-800">Staff Performance</h2>
                                    <button
                                        onClick={() => setCurrentView('users')}
                                        className="responsive-btn responsive-btn-outline"
                                    >
                                        View Details
                                    </button>
                                </div>
                                <div className="space-y-4">
                                    {users.filter(user => user.role === 'operator').map(user => (
                                        <div key={user.id} className="flex items-center justify-between">
                                            <div className="flex items-center">
                                                <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                    <i className="fas fa-user text-blue-600"></i>
                                                </div>
                                                <div>
                                                    <p className="font-medium text-gray-800">{user.display_name}</p>
                                                    <div className="flex items-center">
                                                        <span className="status-indicator status-online"></span>
                                                        <span className="text-sm text-gray-500">Active</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-bold text-gray-800">
                                                    {formatCurrency(sales
                                                        .filter(sale => sale.user_id === user.id)
                                                        .reduce((total, sale) => total + (sale.total || 0), 0)
                                                    )}
                                                </p>
                                                <p className="text-sm text-gray-500">
                                                    {sales.filter(sale => sale.user_id === user.id).length} sales
                                                </p>
                                                <p className="text-sm text-green-600">
                                                    Profit: {formatCurrency(sales
                                                        .filter(sale => sale.user_id === user.id)
                                                        .reduce((total, sale) => total + (sale.total_profit || 0), 0)
                                                    )}
                                                </p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const UsersView = () => {
                return (
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold text-gray-800">ProfitPoint POS Pro</h1>
                            <button
                                onClick={openAddUserModal}
                                className="responsive-btn responsive-btn-secondary responsive-btn-full-mobile"
                                aria-label="Add new user"
                            >
                                <i className="fas fa-plus mr-2"></i>
                                Add User
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow-md overflow-hidden" role="table" aria-label="Users table">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permissions</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {users.map(user => (
                                        <tr key={user.id} role="row">
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <div className="flex items-center">
                                                    <div className="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
                                                        <i className="fas fa-user text-blue-500" aria-hidden="true"></i>
                                                    </div>
                                                    <div className="ml-4">
                                                        <div className="text-sm font-medium text-gray-900">{user.display_name}</div>
                                                        <div className="text-sm text-gray-500">{user.username}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.username}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className={`px-2 py-1 text-xs rounded-full capitalize ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' :
                                                    user.role === 'manager' ? 'bg-blue-100 text-blue-800' :
                                                        'bg-green-100 text-green-800'
                                                    }`}>
                                                    {user.role}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className={`px-2 py-1 text-xs rounded-full ${user.status === 'active' ? 'bg-green-100 text-green-800' :
                                                    user.status === 'inactive' ? 'bg-gray-100 text-gray-800' :
                                                        'bg-red-100 text-red-800'
                                                    }`}>
                                                    {user.status}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div className="max-w-xs truncate" title={user.permissions?.join(', ')}>
                                                    {user.permissions?.join(', ')}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button
                                                    onClick={() => openEditUserModal(user)}
                                                    className="responsive-btn responsive-btn-outline mr-3"
                                                    aria-label={`Edit ${user.display_name}`}
                                                >
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button
                                                    onClick={() => deleteUser(user.id)}
                                                    className="responsive-btn responsive-btn-danger"
                                                    aria-label={`Delete ${user.display_name}`}
                                                >
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}

                                    {users.length === 0 && (
                                        <tr>
                                            <td colSpan="6" className="px-6 py-8 text-center text-gray-500">
                                                <i className="fas fa-users text-gray-300 text-4xl mb-3 block" aria-hidden="true"></i>
                                                <p>No users found</p>
                                                <p className="text-sm mt-2">Add your first user to get started</p>
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>

                        <UserModal
                            isOpen={showUserModal}
                            onClose={() => setShowUserModal(false)}
                            onSave={saveUser}
                            user={editingUser}
                        />
                    </div>
                );
            };

            // Products Component
            const ProductsView = () => {
                const productsWithProfit = useMemo(() => {
                    return products.map(p => ({
                        ...p,
                        profit: calculateProfit(p.buy_price, p.sell_price)
                    }));
                }, [products]);

                return (
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold text-gray-800">ProfitPoint POS Pro</h1>
                            <div className="flex space-x-4 responsive-btn-group">
                                <button
                                    onClick={openAddProductModal}
                                    className="responsive-btn responsive-btn-secondary responsive-btn-full-mobile"
                                    aria-label="Add new product"
                                >
                                    <i className="fas fa-plus mr-2"></i>
                                    Add Product
                                </button>
                                <button
                                    onClick={exportProductsToCSV}
                                    className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                                    aria-label="Export products to CSV"
                                >
                                    <i className="fas fa-download mr-2"></i>
                                    Export CSV
                                </button>
                                <button
                                    onClick={exportProductsToPDF}
                                    className="responsive-btn responsive-btn-accent responsive-btn-full-mobile"
                                    aria-label="Export products to PDF"
                                >
                                    <i className="fas fa-file-pdf mr-2"></i>
                                    Export PDF
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-md overflow-hidden" role="table" aria-label="Products table">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Barcode</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Buy Price</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sell Price</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {productsWithProfit.map(product => (
                                        <tr key={product.id} role="row">
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <div className="flex items-center">
                                                    <div className="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                                        <i className="fas fa-box text-blue-500" aria-hidden="true"></i>
                                                    </div>
                                                    <div className="ml-4">
                                                        <div className="text-sm font-medium text-gray-900">{product.name}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{product.category}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{product.barcode}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <div className="text-sm text-gray-500">
                                                    {product.available_stock}
                                                    {product.available_stock <= (product.reorder_level || 0) && (
                                                        <span className="ml-2 text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full" role="alert">Low</span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(product.buy_price)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(product.sell_price)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatCurrency(product.profit)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {product.expiration_date ? formatDate(product.expiration_date) : 'N/A'}
                                                {isExpiringSoon(product.expiration_date) && (
                                                    <span className="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full" role="alert">Soon</span>
                                                )}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button
                                                    onClick={() => openEditProductModal(product)}
                                                    className="responsive-btn responsive-btn-outline mr-3"
                                                    aria-label={`Edit ${product.name}`}
                                                >
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button
                                                    onClick={() => deleteProduct(product.id)}
                                                    className="responsive-btn responsive-btn-danger"
                                                    aria-label={`Delete ${product.name}`}
                                                >
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <ProductModal
                            isOpen={showProductModal}
                            onClose={() => setShowProductModal(false)}
                            onSave={saveProduct}
                            product={editingProduct}
                        />
                    </div>
                );
            };

            // Sales History Component - FIXED with profit calculation and filtering
            const SalesView = () => {
                const [filterDate, setFilterDate] = useState('');
                const [startDate, setStartDate] = useState('');
                const [endDate, setEndDate] = useState('');
                const [paymentFilter, setPaymentFilter] = useState('');
                const [cashierFilter, setCashierFilter] = useState('');
                // Add separate states for deletion range to avoid conflicts
                const [deleteStartDate, setDeleteStartDate] = useState('');
                const [deleteEndDate, setDeleteEndDate] = useState('');

                const filteredSales = useMemo(() => {
                    let filtered = [...sales].reverse(); // Show latest first

                    if (filterDate) {
                        filtered = filtered.filter(sale => {
                            const saleDate = new Date(sale.date).toISOString().split('T')[0];
                            return saleDate === filterDate;
                        });
                    }

                    if (startDate && endDate) {
                        filtered = filtered.filter(sale => {
                            const saleDate = new Date(sale.date).toISOString().split('T')[0];
                            return saleDate >= startDate && saleDate <= endDate;
                        });
                    }

                    if (paymentFilter) {
                        filtered = filtered.filter(sale =>
                            sale.payment_method.toLowerCase().includes(paymentFilter.toLowerCase())
                        );
                    }

                    if (cashierFilter) {
                        filtered = filtered.filter(sale =>
                            sale.user_name.toLowerCase().includes(cashierFilter.toLowerCase())
                        );
                    }

                    return filtered;
                }, [sales, filterDate, startDate, endDate, paymentFilter, cashierFilter]);

                const totalSalesAmount = filteredSales.reduce((total, sale) => total + (sale.total || 0), 0);
                const totalProfit = filteredSales.reduce((total, sale) => total + (sale.total_profit || 0), 0);
                const totalItemsSold = filteredSales.reduce((total, sale) => {
                    return total + (sale.items?.reduce((itemTotal, item) => itemTotal + (item.quantity || 0), 0) || 0);
                }, 0);

                // Get unique cashiers for filter
                const uniqueCashiers = useMemo(() => {
                    const cashiers = [...new Set(sales.map(sale => sale.user_name))];
                    return cashiers;
                }, [sales]);

                // Clear all filters
                const clearFilters = () => {
                    setFilterDate('');
                    setStartDate('');
                    setEndDate('');
                    setPaymentFilter('');
                    setCashierFilter('');
                };

                return (
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold text-gray-800">ProfitPoint POS Pro</h1>
                            <div className="flex space-x-4 responsive-btn-group">
                                <button
                                    onClick={exportSalesToPDF}
                                    className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                                    aria-label="Export sales to PDF"
                                >
                                    <i className="fas fa-file-pdf mr-2"></i>
                                    Export PDF
                                </button>
                                <button
                                    onClick={exportSalesToCSV}
                                    className="responsive-btn responsive-btn-secondary responsive-btn-full-mobile"
                                    aria-label="Export sales to CSV"
                                >
                                    <i className="fas fa-file-csv mr-2"></i>
                                    Export CSV
                                </button>
                            </div>
                        </div>

                        {/* Filters Section */}
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-bold text-gray-800">Filters</h2>
                                <button
                                    onClick={clearFilters}
                                    className="responsive-btn responsive-btn-outline"
                                >
                                    Clear All
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Single Date</label>
                                    <input
                                        type="date"
                                        value={filterDate}
                                        onChange={(e) => setFilterDate(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        aria-label="Filter by specific date"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input
                                        type="date"
                                        value={startDate}
                                        onChange={(e) => setStartDate(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        aria-label="Start date for range filter"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input
                                        type="date"
                                        value={endDate}
                                        onChange={(e) => setEndDate(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        aria-label="End date for range filter"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                                    <select
                                        value={paymentFilter}
                                        onChange={(e) => setPaymentFilter(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        aria-label="Filter by payment method"
                                    >
                                        <option value="">All Methods</option>
                                        <option value="cash">Cash</option>
                                        <option value="mpesa">M-PESA</option>
                                        <option value="airtelmoney">Airtel Money</option>
                                        <option value="tigopesa">Tigo Pesa</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Cashier</label>
                                    <select
                                        value={cashierFilter}
                                        onChange={(e) => setCashierFilter(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        aria-label="Filter by cashier"
                                    >
                                        <option value="">All Cashiers</option>
                                        {uniqueCashiers.map(cashier => (
                                            <option key={cashier} value={cashier}>{cashier}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>

                        {/* Summary Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                            <div className="bg-white rounded-lg shadow-md p-6" role="group" aria-label="Total Sales Summary">
                                <div className="flex items-center">
                                    <div className="rounded-full bg-blue-100 p-3 mr-4">
                                        <i className="fas fa-shopping-cart text-blue-500 text-xl" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <p className="text-gray-500 text-sm">Total Sales</p>
                                        <p className="text-2xl font-bold text-gray-800">{filteredSales.length}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-lg shadow-md p-6" role="group" aria-label="Revenue Summary">
                                <div className="flex items-center">
                                    <div className="rounded-full bg-green-100 p-3 mr-4">
                                        <i className="fas fa-money-bill-wave text-green-500 text-xl" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <p className="text-gray-500 text-sm">Revenue</p>
                                        <p className="text-2xl font-bold text-gray-800">{formatCurrency(totalSalesAmount)}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-lg shadow-md p-6" role="group" aria-label="Profit Summary">
                                <div className="flex items-center">
                                    <div className="rounded-full bg-purple-100 p-3 mr-4">
                                        <i className="fas fa-chart-line text-purple-500 text-xl" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <p className="text-gray-500 text-sm">Profit</p>
                                        <p className="text-2xl font-bold text-gray-800">{formatCurrency(totalProfit)}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-lg shadow-md p-6" role="group" aria-label="Items Sold Summary">
                                <div className="flex items-center">
                                    <div className="rounded-full bg-orange-100 p-3 mr-4">
                                        <i className="fas fa-boxes text-orange-500 text-xl" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <p className="text-gray-500 text-sm">Items Sold</p>
                                        <p className="text-2xl font-bold text-gray-800">{totalItemsSold}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Sales Table */}
                        <div className="bg-white rounded-lg shadow-md overflow-hidden" role="table" aria-label="Sales history table">
                            <div className="table-container">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Receipt #</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cashier</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {filteredSales.map(sale => (
                                            <tr key={sale.id} role="row" className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm text-gray-900">{formatDate(sale.date)}</div>
                                                    <div className="text-xs text-gray-500">{formatTime(sale.date)}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                                                    #{sale.id.slice(-8).toUpperCase()}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{sale.user_name}</td>
                                                <td className="px-6 py-4 text-sm text-gray-500">
                                                    <div className="max-w-xs">
                                                        {sale.items?.map(item => (
                                                            <div key={item.id} className="mb-1">
                                                                {item.name} (x{item.quantity})
                                                            </div>
                                                        ))}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <span className={`px-2 py-1 text-xs rounded-full capitalize ${sale.payment_method === 'cash' ? 'bg-green-100 text-green-800' :
                                                        sale.payment_method === 'mpesa' ? 'bg-blue-100 text-blue-800' :
                                                            'bg-purple-100 text-purple-800'
                                                        }`}>
                                                        {sale.payment_method}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                                                    {formatCurrency(sale.total || 0)}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600">
                                                    {formatCurrency(sale.total_profit || 0)}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            {filteredSales.length === 0 && (
                                <div className="text-center py-12">
                                    <i className="fas fa-chart-line text-gray-300 text-6xl mb-4" aria-hidden="true"></i>
                                    <p className="text-gray-500 text-lg">No sales found</p>
                                    <p className="text-gray-400 text-sm mt-2">
                                        {sales.length === 0 ? 'Make a sale to see it here' : 'Try adjusting your filters'}
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Delete Sales Range */}
                        <div className="bg-white rounded-lg shadow-md p-6 mt-6">
                            <h2 className="text-lg font-bold text-gray-800 mb-4">Delete Sales in Range</h2>
                            <div className="flex space-x-4 responsive-btn-group">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input
                                        type="date"
                                        value={deleteStartDate}
                                        onChange={(e) => setDeleteStartDate(e.target.value)}
                                        className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        aria-label="Start date for deletion"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input
                                        type="date"
                                        value={deleteEndDate}
                                        onChange={(e) => setDeleteEndDate(e.target.value)}
                                        className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        aria-label="End date for deletion"
                                    />
                                </div>
                                <div className="flex items-end">
                                    <button
                                        onClick={() => deleteSalesInRange(deleteStartDate, deleteEndDate)}
                                        className="responsive-btn responsive-btn-danger responsive-btn-full-mobile"
                                        aria-label="Delete sales in selected range"
                                    >
                                        <i className="fas fa-trash mr-2"></i>
                                        Delete Sales
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Reports Component - FIXED with profit analytics
            const ReportsView = () => {
                const [startDate, setStartDate] = useState('');
                const [endDate, setEndDate] = useState('');
                const [reportType, setReportType] = useState('sales');

                const filteredSales = useMemo(() => {
                    let filtered = sales;

                    if (startDate) {
                        filtered = filtered.filter(sale => {
                            const saleDate = new Date(sale.date).toISOString().split('T')[0];
                            return saleDate >= startDate;
                        });
                    }

                    if (endDate) {
                        filtered = filtered.filter(sale => {
                            const saleDate = new Date(sale.date).toISOString().split('T')[0];
                            return saleDate <= endDate;
                        });
                    }

                    return filtered;
                }, [sales, startDate, endDate]);

                // Calculate comprehensive report data
                const reportData = useMemo(() => {
                    const totalRevenue = filteredSales.reduce((total, sale) => total + (sale.total || 0), 0);
                    const totalProfit = filteredSales.reduce((total, sale) => total + (sale.total_profit || 0), 0);
                    const totalItems = filteredSales.reduce((total, sale) => {
                        return total + (sale.items?.reduce((itemTotal, item) => itemTotal + (item.quantity || 0), 0) || 0);
                    }, 0);
                    const averageSale = filteredSales.length > 0 ? totalRevenue / filteredSales.length : 0;
                    const averageProfit = filteredSales.length > 0 ? totalProfit / filteredSales.length : 0;

                    // Payment method breakdown
                    const paymentBreakdown = filteredSales.reduce((acc, sale) => {
                        const method = sale.payment_method;
                        if (!acc[method]) {
                            acc[method] = { count: 0, amount: 0, profit: 0 };
                        }
                        acc[method].count += 1;
                        acc[method].amount += (sale.total || 0);
                        acc[method].profit += (sale.total_profit || 0);
                        return acc;
                    }, {});

                    // Daily sales trend
                    const dailySales = filteredSales.reduce((acc, sale) => {
                        const date = formatDate(sale.date);
                        if (!acc[date]) {
                            acc[date] = { sales: 0, revenue: 0, profit: 0 };
                        }
                        acc[date].sales += 1;
                        acc[date].revenue += (sale.total || 0);
                        acc[date].profit += (sale.total_profit || 0);
                        return acc;
                    }, {});

                    // Top selling products
                    const productSales = {};
                    filteredSales.forEach(sale => {
                        sale.items?.forEach(item => {
                            if (!productSales[item.name]) {
                                productSales[item.name] = {
                                    name: item.name,
                                    quantity: 0,
                                    revenue: 0,
                                    profit: 0
                                };
                            }
                            productSales[item.name].quantity += (item.quantity || 0);
                            productSales[item.name].revenue += (item.total || 0);
                            productSales[item.name].profit += (item.profit || 0);
                        });
                    });

                    const topProducts = Object.values(productSales)
                        .sort((a, b) => b.revenue - a.revenue)
                        .slice(0, 10);

                    // Cashier performance
                    const cashierPerformance = filteredSales.reduce((acc, sale) => {
                        const cashier = sale.user_name;
                        if (!acc[cashier]) {
                            acc[cashier] = { sales: 0, revenue: 0, profit: 0 };
                        }
                        acc[cashier].sales += 1;
                        acc[cashier].revenue += (sale.total || 0);
                        acc[cashier].profit += (sale.total_profit || 0);
                        return acc;
                    }, {});

                    return {
                        totalRevenue,
                        totalProfit,
                        totalItems,
                        averageSale,
                        averageProfit,
                        totalSales: filteredSales.length,
                        paymentBreakdown,
                        dailySales,
                        topProducts,
                        cashierPerformance
                    };
                }, [filteredSales]);

                // Export comprehensive report
                const exportComprehensiveReport = () => {
                    if (filteredSales.length === 0) {
                        showToast('No report data to export', 'error');
                        return;
                    }

                    const reportDataForExport = [
                        // Summary section
                        {
                            'Section': 'SUMMARY',
                            'Metric': 'Total Sales',
                            'Value': reportData.totalSales,
                            'Details': ''
                        },
                        {
                            'Section': 'SUMMARY',
                            'Metric': 'Total Revenue',
                            'Value': formatCurrency(reportData.totalRevenue),
                            'Details': ''
                        },
                        {
                            'Section': 'SUMMARY',
                            'Metric': 'Total Profit',
                            'Value': formatCurrency(reportData.totalProfit),
                            'Details': ''
                        },
                        {
                            'Section': 'SUMMARY',
                            'Metric': 'Total Items Sold',
                            'Value': reportData.totalItems,
                            'Details': ''
                        },
                        {
                            'Section': 'SUMMARY',
                            'Metric': 'Average Sale Value',
                            'Value': formatCurrency(reportData.averageSale),
                            'Details': ''
                        },
                        {
                            'Section': 'SUMMARY',
                            'Metric': 'Average Profit per Sale',
                            'Value': formatCurrency(reportData.averageProfit),
                            'Details': ''
                        },
                        // Empty row for spacing
                        {
                            'Section': '',
                            'Metric': '',
                            'Value': '',
                            'Details': ''
                        },
                        // Payment breakdown
                        {
                            'Section': 'PAYMENT METHODS',
                            'Metric': 'Method',
                            'Value': 'Transactions',
                            'Details': 'Amount / Profit'
                        },
                        ...Object.entries(reportData.paymentBreakdown).map(([method, data]) => ({
                            'Section': 'PAYMENT METHODS',
                            'Metric': method.toUpperCase(),
                            'Value': data.count,
                            'Details': `${formatCurrency(data.amount)} / ${formatCurrency(data.profit)}`
                        })),
                        // Empty row for spacing
                        {
                            'Section': '',
                            'Metric': '',
                            'Value': '',
                            'Details': ''
                        },
                        // Top products
                        {
                            'Section': 'TOP PRODUCTS',
                            'Metric': 'Product Name',
                            'Value': 'Quantity Sold',
                            'Details': 'Revenue / Profit'
                        },
                        ...reportData.topProducts.map((product, index) => ({
                            'Section': 'TOP PRODUCTS',
                            'Metric': product.name,
                            'Value': product.quantity,
                            'Details': `${formatCurrency(product.revenue)} / ${formatCurrency(product.profit)}`
                        }))
                    ];

                    const headers = ['Section', 'Metric', 'Value', 'Details'];
                    const csvRows = [
                        headers.join(','),
                        ...reportDataForExport.map(row =>
                            headers.map(header => {
                                const value = row[header];
                                return typeof value === 'string' && value.includes(',')
                                    ? `"${value}"`
                                    : value;
                            }).join(',')
                        )
                    ];

                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `comprehensive_report_${formatDate(new Date()).replace(/\//g, '-')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showToast('Comprehensive report exported to CSV successfully');
                };

                return (
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold text-gray-800">ProfitPoint POS Pro</h1>
                            <div className="flex space-x-4 responsive-btn-group">
                                <input
                                    type="date"
                                    value={startDate}
                                    onChange={(e) => setStartDate(e.target.value)}
                                    className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    aria-label="Start date for report"
                                />
                                <input
                                    type="date"
                                    value={endDate}
                                    onChange={(e) => setEndDate(e.target.value)}
                                    className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    aria-label="End date for report"
                                />

                                <button
                                    onClick={exportComprehensiveReport}
                                    className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                                    aria-label="Export comprehensive report"
                                >
                                    <i className="fas fa-download mr-2"></i>
                                    Export Report
                                </button>
                            </div>
                        </div>

                        {/* Summary Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-6">
                            <div className="bg-white rounded-lg shadow-md p-6" role="group" aria-label="Total Sales Report">
                                <div className="flex items-center">
                                    <div className="rounded-full bg-blue-100 p-3 mr-4">
                                        <i className="fas fa-shopping-cart text-blue-500 text-xl" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <p className="text-gray-500 text-sm">Total Sales</p>
                                        <p className="text-2xl font-bold text-gray-800">{reportData.totalSales}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-lg shadow-md p-6" role="group" aria-label="Revenue Report">
                                <div className="flex items-center">
                                    <div className="rounded-full bg-green-100 p-3 mr-4">
                                        <i className="fas fa-money-bill-wave text-green-500 text-xl" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <p className="text-gray-500 text-sm">Revenue</p>
                                        <p className="text-2xl font-bold text-gray-800">{formatCurrency(reportData.totalRevenue)}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-lg shadow-md p-6" role="group" aria-label="Profit Report">
                                <div className="flex items-center">
                                    <div className="rounded-full bg-purple-100 p-3 mr-4">
                                        <i className="fas fa-chart-line text-purple-500 text-xl" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <p className="text-gray-500 text-sm">Profit</p>
                                        <p className="text-2xl font-bold text-gray-800">{formatCurrency(reportData.totalProfit)}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-lg shadow-md p-6" role="group" aria-label="Average Sale Report">
                                <div className="flex items-center">
                                    <div className="rounded-full bg-yellow-100 p-3 mr-4">
                                        <i className="fas fa-chart-bar text-yellow-500 text-xl" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <p className="text-gray-500 text-sm">Avg. Sale</p>
                                        <p className="text-2xl font-bold text-gray-800">{formatCurrency(reportData.averageSale)}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-lg shadow-md p-6" role="group" aria-label="Average Profit Report">
                                <div className="flex items-center">
                                    <div className="rounded-full bg-red-100 p-3 mr-4">
                                        <i className="fas fa-coins text-red-500 text-xl" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <p className="text-gray-500 text-sm">Avg. Profit</p>
                                        <p className="text-2xl font-bold text-gray-800">{formatCurrency(reportData.averageProfit)}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-lg shadow-md p-6" role="group" aria-label="Items Sold Report">
                                <div className="flex items-center">
                                    <div className="rounded-full bg-orange-100 p-3 mr-4">
                                        <i className="fas fa-boxes text-orange-500 text-xl" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <p className="text-gray-500 text-sm">Items Sold</p>
                                        <p className="text-2xl font-bold text-gray-800">{reportData.totalItems}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Top Products */}
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">Top Selling Products</h3>
                                <ul className="space-y-4" role="list">
                                    {reportData.topProducts.map((product, index) => (
                                        <li key={index} className="flex items-center justify-between" role="listitem">
                                            <div className="flex items-center">
                                                <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                    <span className="text-blue-500 text-sm font-bold">{index + 1}</span>
                                                </div>
                                                <div>
                                                    <p className="text-gray-800 font-medium">{product.name}</p>
                                                    <p className="text-sm text-gray-500">{product.quantity} units</p>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-gray-800 font-bold">{formatCurrency(product.revenue)}</p>
                                                <p className="text-green-600 text-sm">{formatCurrency(product.profit)} profit</p>
                                            </div>
                                        </li>
                                    ))}

                                    {reportData.topProducts.length === 0 && (
                                        <div className="text-center py-4">
                                            <p className="text-gray-500">No sales data available</p>
                                        </div>
                                    )}
                                </ul>
                            </div>

                            {/* Payment Methods */}
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">Payment Methods</h3>
                                <ul className="space-y-4" role="list">
                                    {Object.entries(reportData.paymentBreakdown).map(([method, data]) => (
                                        <li key={method} className="flex items-center justify-between" role="listitem">
                                            <div className="flex items-center">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center mr-3 ${method === 'cash' ? 'bg-green-100' :
                                                    method === 'mpesa' ? 'bg-blue-100' :
                                                        'bg-purple-100'
                                                    }`}>
                                                    <i className={`fas ${method === 'cash' ? 'fa-money-bill-wave text-green-500' :
                                                        method === 'mpesa' ? 'fa-mobile-alt text-blue-500' :
                                                            'fa-wifi text-purple-500'
                                                        }`}></i>
                                                </div>
                                                <div>
                                                    <p className="text-gray-800 font-medium capitalize">{method}</p>
                                                    <p className="text-sm text-gray-500">{data.count} transactions</p>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-gray-800 font-bold">{formatCurrency(data.amount)}</p>
                                                <p className="text-green-600 text-sm">{formatCurrency(data.profit)} profit</p>
                                                <p className="text-gray-500 text-sm">
                                                    {((data.amount / reportData.totalRevenue) * 100).toFixed(1)}%
                                                </p>
                                            </div>
                                        </li>
                                    ))}

                                    {Object.keys(reportData.paymentBreakdown).length === 0 && (
                                        <div className="text-center py-4">
                                            <p className="text-gray-500">No payment data available</p>
                                        </div>
                                    )}
                                </ul>
                            </div>
                        </div>

                        {/* Cashier Performance */}
                        <div className="bg-white rounded-lg shadow-md p-6 mt-6">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Cashier Performance</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cashier</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sales</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Sale</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {Object.entries(reportData.cashierPerformance).map(([cashier, data]) => (
                                            <tr key={cashier}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{cashier}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{data.sales}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formatCurrency(data.revenue)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">{formatCurrency(data.profit)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {formatCurrency(data.revenue / data.sales)}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600">
                                                    {formatCurrency(data.profit / data.sales)}
                                                </td>
                                            </tr>
                                        ))}

                                        {Object.keys(reportData.cashierPerformance).length === 0 && (
                                            <tr>
                                                <td colSpan="6" className="px-6 py-4 text-center text-gray-500">
                                                    No cashier performance data available
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            // Inventory Component
            const InventoryView = () => {
                const abcProducts = useMemo(() => performABC(products), [products]);

                // State for filters and stock history
                const [categoryFilter, setCategoryFilter] = useState('all');
                const [expiryFilter, setExpiryFilter] = useState('all');
                const [selectedProduct, setSelectedProduct] = useState(null);
                const [showStockHistory, setShowStockHistory] = useState(false);

                // Calculate stock value and retail value with proper field mapping
                const stockValue = useMemo(() => {
                    return products.reduce((total, product) => {
                        const stock = Number(product.available_stock) || 0;
                        // Map buy_price to cost_price
                        const costPrice = Number(product.cost_price) || Number(product.buy_price) || Number(product.price) || 0;
                        return total + (stock * costPrice);
                    }, 0);
                }, [products]);

                const retailValue = useMemo(() => {
                    return products.reduce((total, product) => {
                        const stock = Number(product.available_stock) || 0;
                        // Map sell_price to selling_price
                        const sellingPrice = Number(product.selling_price) || Number(product.sell_price) || Number(product.price) || 0;
                        return total + (stock * sellingPrice);
                    }, 0);
                }, [products]);

                const potentialProfit = useMemo(() => {
                    return retailValue - stockValue;
                }, [retailValue, stockValue]);

                // Get unique categories for filter
                const categories = useMemo(() => {
                    const uniqueCategories = [...new Set(products.map(product => product.category))];
                    return uniqueCategories.filter(category => category && category.trim() !== '');
                }, [products]);

                // Filter products based on selected filters
                const filteredProducts = useMemo(() => {
                    let filtered = abcProducts;

                    // Filter by category
                    if (categoryFilter !== 'all') {
                        filtered = filtered.filter(product => product.category === categoryFilter);
                    }

                    // Filter by expiry
                    if (expiryFilter !== 'all') {
                        const today = new Date();
                        switch (expiryFilter) {
                            case 'expired':
                                filtered = filtered.filter(product =>
                                    product.expiration_date && new Date(product.expiration_date) < today
                                );
                                break;
                            case 'expiring_soon':
                                filtered = filtered.filter(product =>
                                    product.expiration_date && isExpiringSoon(product.expiration_date)
                                );
                                break;
                            case 'not_expired':
                                filtered = filtered.filter(product =>
                                    !product.expiration_date || new Date(product.expiration_date) >= today
                                );
                                break;
                            default:
                                break;
                        }
                    }

                    return filtered;
                }, [abcProducts, categoryFilter, expiryFilter]);

                // Get stock history for a product
                const getStockHistory = (productId) => {
                    // This is a placeholder - you'll need to implement based on your actual data structure
                    return [
                        { date: '2024-01-15', change: 50, type: 'purchase', newStock: 150 },
                        { date: '2024-01-20', change: -20, type: 'sale', newStock: 130 },
                        { date: '2024-01-25', change: 100, type: 'purchase', newStock: 230 },
                        { date: '2024-02-01', change: -45, type: 'sale', newStock: 185 },
                    ];
                };

                // Export inventory to CSV
                const exportInventoryToCSV = () => {
                    if (products.length === 0) {
                        showToast('No inventory data to export', 'error');
                        return;
                    }

                    const inventoryData = products.map(product => {
                        const stock = Number(product.available_stock) || 0;
                        // Map buy_price to cost_price for CSV
                        const costPrice = Number(product.cost_price) || Number(product.buy_price) || Number(product.price) || 0;
                        // Map sell_price to selling_price for CSV
                        const sellingPrice = Number(product.selling_price) || Number(product.sell_price) || Number(product.price) || 0;

                        return {
                            'Barcode': product.barcode,
                            'Name': product.name,
                            'Category': product.category,
                            'Stock': stock,
                            'Cost Price': costPrice,
                            'Selling Price': sellingPrice,
                            'Reorder Level': product.reorder_level || 0,
                            'ABC Category': abcProducts.find(p => p.id === product.id)?.abc_category || 'C',
                            'Status': stock === 0 ? 'Out of Stock' :
                                stock <= (product.reorder_level || 0) ? 'Low Stock' : 'In Stock',
                            'Expiration Date': product.expiration_date || 'N/A'
                        };
                    });

                    const headers = Object.keys(inventoryData[0]);
                    const csvRows = [
                        headers.join(','),
                        ...inventoryData.map(row =>
                            headers.map(header => {
                                const value = row[header];
                                return typeof value === 'string' && value.includes(',')
                                    ? `"${value}"`
                                    : value;
                            }).join(',')
                        )
                    ];

                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `inventory_report_${formatDate(new Date()).replace(/\//g, '-')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showToast('Inventory report exported to CSV successfully');
                };

                // View stock history for a product
                const viewStockHistory = (product) => {
                    setSelectedProduct(product);
                    setShowStockHistory(true);
                };

                return (
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold text-gray-800">ProfitPoint POS Pro</h1>
                            <button
                                onClick={exportInventoryToCSV}
                                className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                                aria-label="Export inventory to CSV"
                            >
                                <i className="fas fa-download mr-2"></i>
                                Export CSV
                            </button>
                        </div>

                        {/* Stock Value and Retail Value Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Total Stock Value</p>
                                        <p className="text-2xl font-bold text-blue-600">
                                            ${stockValue.toFixed(2)}
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            Based on cost price
                                        </p>
                                    </div>
                                    <div className="bg-blue-100 p-3 rounded-full">
                                        <i className="fas fa-boxes text-blue-500 text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Total Retail Value</p>
                                        <p className="text-2xl font-bold text-green-600">
                                            ${retailValue.toFixed(2)}
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            Based on selling price
                                        </p>
                                    </div>
                                    <div className="bg-green-100 p-3 rounded-full">
                                        <i className="fas fa-tags text-green-500 text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Potential Profit</p>
                                        <p className="text-2xl font-bold text-purple-600">
                                            ${potentialProfit.toFixed(2)}
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            Retail - Stock Value
                                        </p>
                                    </div>
                                    <div className="bg-purple-100 p-3 rounded-full">
                                        <i className="fas fa-chart-line text-purple-500 text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm font-medium text-gray-600">Total Products</p>
                                        <p className="text-2xl font-bold text-orange-600">
                                            {products.length}
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            Active inventory items
                                        </p>
                                    </div>
                                    <div className="bg-orange-100 p-3 rounded-full">
                                        <i className="fas fa-cubes text-orange-500 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Filters Section */}
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Filter by Category
                                    </label>
                                    <select
                                        value={categoryFilter}
                                        onChange={(e) => setCategoryFilter(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="all">All Categories</option>
                                        {categories.map(category => (
                                            <option key={category} value={category}>
                                                {category}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Filter by Expiry
                                    </label>
                                    <select
                                        value={expiryFilter}
                                        onChange={(e) => setExpiryFilter(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="all">All Products</option>
                                        <option value="expired">Expired</option>
                                        <option value="expiring_soon">Expiring Soon</option>
                                        <option value="not_expired">Not Expired</option>
                                    </select>
                                </div>

                                <div className="flex items-end">
                                    <button
                                        onClick={() => {
                                            setCategoryFilter('all');
                                            setExpiryFilter('all');
                                        }}
                                        className="responsive-btn responsive-btn-outline responsive-btn-full-mobile"
                                    >
                                        Clear Filters
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-lg font-bold text-gray-800">Low Stock Alert</h2>
                                    <span className="bg-red-100 text-red-800 px-2 py-1 rounded-full text-sm" aria-label={`${lowStockProducts.length} low stock products`}>
                                        {lowStockProducts.length} products
                                    </span>
                                </div>

                                <ul className="space-y-4" role="list">
                                    {lowStockProducts.map(product => (
                                        <li key={product.id} className="flex items-center justify-between border-b border-gray-100 pb-3" role="listitem">
                                            <div>
                                                <p className="font-medium text-gray-800">{product.name}</p>
                                                <p className="text-sm text-gray-500">Current: {product.available_stock} • Reorder: {product.reorder_level || 0}</p>
                                            </div>
                                            <div className="text-right">
                                                <span className="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full" role="alert">
                                                    Low Stock
                                                </span>
                                            </div>
                                        </li>
                                    ))}

                                    {lowStockProducts.length === 0 && (
                                        <div className="text-center py-4">
                                            <p className="text-gray-500">All products are well stocked</p>
                                        </div>
                                    )}
                                </ul>
                            </div>

                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h2 className="text-lg font-bold text-gray-800 mb-4">ABC Analysis Summary</h2>
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">A Items (High Value)</span>
                                        <span className="font-bold text-red-600">{abcProducts.filter(p => p.abc_category === 'A').length}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">B Items (Medium Value)</span>
                                        <span className="font-bold text-yellow-600">{abcProducts.filter(p => p.abc_category === 'B').length}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">C Items (Low Value)</span>
                                        <span className="font-bold text-green-600">{abcProducts.filter(p => p.abc_category === 'C').length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Inventory Table */}
                        <div className="bg-white rounded-lg shadow-md overflow-hidden" role="table" aria-label="Inventory table">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost Price</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Selling Price</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reorder Level</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ABC Category</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredProducts.map(product => {
                                        const stock = Number(product.available_stock) || 0;
                                        // Map buy_price to cost_price for display
                                        const costPrice = Number(product.cost_price) || Number(product.buy_price) || Number(product.price) || 0;
                                        // Map sell_price to selling_price for display
                                        const sellingPrice = Number(product.selling_price) || Number(product.sell_price) || Number(product.price) || 0;

                                        let status = 'In Stock';
                                        let statusColor = 'bg-green-100 text-green-800';

                                        if (stock === 0) {
                                            status = 'Out of Stock';
                                            statusColor = 'bg-red-100 text-red-800';
                                        } else if (stock <= (product.reorder_level || 0)) {
                                            status = 'Low Stock';
                                            statusColor = 'bg-orange-100 text-orange-800';
                                        }

                                        let abcColor = '';
                                        switch (product.abc_category) {
                                            case 'A': abcColor = 'bg-red-100 text-red-800'; break;
                                            case 'B': abcColor = 'bg-yellow-100 text-yellow-800'; break;
                                            case 'C': abcColor = 'bg-green-100 text-green-800'; break;
                                        }

                                        return (
                                            <tr key={product.id} role="row">
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="flex items-center">
                                                        <div className="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                                            <i className="fas fa-box text-blue-500" aria-hidden="true"></i>
                                                        </div>
                                                        <div className="ml-4">
                                                            <div className="text-sm font-medium text-gray-900">{product.name}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{product.category}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{stock}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${costPrice.toFixed(2)}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${sellingPrice.toFixed(2)}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{product.reorder_level || 0}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <span className={`px-2 py-1 text-xs rounded-full ${abcColor}`}>
                                                        {product.abc_category}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {product.expiration_date ? formatDate(product.expiration_date) : 'N/A'}
                                                    {isExpiringSoon(product.expiration_date) && (
                                                        <span className="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full" role="alert">Soon</span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <span className={`px-2 py-1 text-xs rounded-full ${statusColor}`}>
                                                        {status}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button
                                                        onClick={() => viewStockHistory(product)}
                                                        className="responsive-btn responsive-btn-outline"
                                                        aria-label={`View stock history for ${product.name}`}
                                                    >
                                                        <i className="fas fa-history mr-1"></i>
                                                        History
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>

                        {/* Stock History Modal */}
                        {showStockHistory && selectedProduct && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
                                    <div className="flex justify-between items-center p-6 border-b">
                                        <h3 className="text-lg font-bold text-gray-800">
                                            Stock History - {selectedProduct.name}
                                        </h3>
                                        <button
                                            onClick={() => setShowStockHistory(false)}
                                            className="responsive-btn responsive-btn-outline"
                                            aria-label="Close stock history"
                                        >
                                            <i className="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div className="p-6 overflow-y-auto max-h-[60vh]">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Change</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New Stock</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {getStockHistory(selectedProduct.id).map((history, index) => (
                                                    <tr key={index}>
                                                        <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                                            {formatDate(history.date)}
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 capitalize">
                                                            {history.type}
                                                        </td>
                                                        <td className={`px-4 py-3 whitespace-nowrap text-sm font-medium ${history.change > 0 ? 'text-green-600' : 'text-red-600'
                                                            }`}>
                                                            {history.change > 0 ? '+' : ''}{history.change}
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                                            {history.newStock}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="flex justify-end p-6 border-t">
                                        <button
                                            onClick={() => setShowStockHistory(false)}
                                            className="responsive-btn responsive-btn-outline"
                                        >
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // Settings Component
            const SettingsView = () => {
                return (
                    <div className="p-6">
                        <div className="mb-8">
                            <h1 className="text-2xl font-bold text-gray-800">ProfitPoint POS Pro</h1>
                            <p className="text-gray-600">Manage your system preferences</p>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h2 className="text-lg font-bold text-gray-800 mb-4">System Configuration</h2>

                                <div className="space-y-6">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <h3 className="font-medium text-gray-800">Supermarket Branding</h3>
                                            <p className="text-sm text-gray-500">Customize logo, name, and appearance</p>
                                        </div>
                                        <button
                                            onClick={() => setShowSettingsModal(true)}
                                            className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                                            aria-label="Configure system settings"
                                        >
                                            Configure
                                        </button>
                                    </div>

                                    <div className="border-t border-gray-200 pt-4">
                                        <h3 className="font-medium text-gray-800 mb-2">Current Settings</h3>
                                        <div className="space-y-2 text-sm" role="list">
                                            <div className="flex justify-between" role="listitem">
                                                <span className="text-gray-600">Supermarket Name:</span>
                                                <span className="font-medium">{systemSettings.supermarketName}</span>
                                            </div>
                                            <div className="flex justify-between" role="listitem">
                                                <span className="text-gray-600">Branch Location:</span>
                                                <span className="font-medium">{systemSettings.branchLocation}</span>
                                            </div>
                                            <div className="flex justify-between" role="listitem">
                                                <span className="text-gray-600">Phone Number:</span>
                                                <span className="font-medium">{systemSettings.phoneNumber}</span>
                                            </div>
                                            <div className="flex justify-between" role="listitem">
                                                <span className="text-gray-600">Theme:</span>
                                                <span className="font-medium capitalize">{systemSettings.theme}</span>
                                            </div>
                                            <div className="flex justify-between" role="listitem">
                                                <span className="text-gray-600">Wallpaper:</span>
                                                <span className="font-medium">{systemSettings.wallpaper ? 'Enabled' : 'Disabled'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Sidebar Component
            const Sidebar = () => {
                const menuItems = [
                    { key: 'dashboard', label: 'Dashboard', icon: 'fa-tachometer-alt' },
                    { key: 'users', label: 'User Management', icon: 'fa-users' },
                    { key: 'products', label: 'Products', icon: 'fa-box' },
                    { key: 'sales', label: 'Sales History', icon: 'fa-chart-line' },
                    { key: 'reports', label: 'Reports', icon: 'fa-chart-bar' },
                    { key: 'inventory', label: 'Inventory', icon: 'fa-warehouse' },
                    { key: 'settings', label: 'Settings', icon: 'fa-cog' }
                ];

                return (
                    <div className={`manager-sidebar bg-gradient-to-br from-slate-800 via-blue-800 to-slate-900 text-white h-screen fixed left-0 top-0 overflow-y-auto custom-scrollbar ${sidebarCollapsed ? 'collapsed' : ''}`}>
                        <div className="p-4">
                            <div className="flex items-center justify-between mb-8">
                                {!sidebarCollapsed && (
                                    <div className="flex items-center">
                                        {systemSettings?.logo ? (
                                            <img src={systemSettings.logo} alt={`${systemSettings.supermarketName || 'ProfitPoint POS'} logo`} className="h-8 w-8 mr-2 object-contain" />
                                        ) : (
                                            <i className="fas fa-shopping-cart text-blue-400 text-2xl mr-2" aria-hidden="true"></i>
                                        )}
                                        <h1 className="text-xl font-bold text-white">
                                            {systemSettings?.supermarketName || 'ProfitPoint POS'}
                                        </h1>
                                    </div>
                                )}
                                <button
                                    onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                                    className="responsive-btn responsive-btn-outline"
                                    aria-label={sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'}
                                >
                                    <i className={`fas ${sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'}`}></i>
                                </button>
                            </div>

                            <nav className="space-y-2" role="navigation">
                                {menuItems.map(item => (
                                    <button
                                        key={item.key}
                                        onClick={() => setCurrentView(item.key)}
                                        className={`responsive-btn ${currentView === item.key
                                            ? 'responsive-btn-primary'
                                            : 'responsive-btn-outline'
                                            }`}
                                        aria-label={`Navigate to ${item.label}`}
                                    >
                                        <i className={`fas ${item.icon} ${sidebarCollapsed ? 'text-lg' : 'mr-3'}`}></i>
                                        {!sidebarCollapsed && <span>{item.label}</span>}
                                    </button>
                                ))}
                            </nav>

                            <div className="mt-8 pt-8 border-t border-gray-700">
                                <div className="flex items-center px-3 py-3">
                                    <div className="w-10 h-10 bg-blue-900 rounded-full flex items-center justify-center">
                                        <i className="fas fa-user text-blue-400" aria-hidden="true"></i>
                                    </div>
                                    {!sidebarCollapsed && (
                                        <div className="ml-3">
                                            <div className="text-sm font-medium text-white">{currentUser.display_name}</div>
                                            <div className="text-xs text-gray-400 capitalize">{currentUser.role}</div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Main render
            return (
                <div className="min-h-screen bg-gray-100">
                    <Sidebar />

                    <div className={`manager-content ${sidebarCollapsed ? 'expanded' : ''}`}>
                        <div className="bg-white shadow-sm border-b border-gray-200">
                            <div className="flex justify-between items-center px-6 py-4">
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">
                                        {currentView === 'dashboard' && 'Dashboard'}
                                        {currentView === 'users' && 'User Management'}
                                        {currentView === 'products' && 'Product Management'}
                                        {currentView === 'sales' && 'Sales History'}
                                        {currentView === 'reports' && 'Reports'}
                                        {currentView === 'inventory' && 'Inventory Management'}
                                        {currentView === 'settings' && 'Settings'}
                                    </h1>
                                </div>

                                <div className="flex items-center space-x-4">
                                    <div className="relative">
                                        <button
                                            onClick={() => setCurrentView('inventory')}
                                            className="responsive-btn responsive-btn-outline"
                                        >
                                            <i className="fas fa-bell"></i>
                                        </button>
                                        <span className="notification-dot"></span>
                                    </div>

                                    <div className="flex items-center bg-gray-100 px-4 py-2 rounded-lg">
                                        <div className="text-sm">
                                            <div className="font-medium text-gray-800">{currentUser.display_name}</div>
                                            <div className="text-gray-600 capitalize">{currentUser.role}</div>
                                        </div>
                                    </div>

                                    <button
                                        onClick={onLogout}
                                        className="responsive-btn responsive-btn-danger"
                                        aria-label="Logout"
                                    >
                                        <i className="fas fa-sign-out-alt mr-2"></i>
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div>
                            {currentView === 'dashboard' && <DashboardView />}
                            {currentView === 'users' && <UsersView />}
                            {currentView === 'products' && <ProductsView />}
                            {currentView === 'sales' && <SalesView />}
                            {currentView === 'reports' && <ReportsView />}
                            {currentView === 'inventory' && <InventoryView />}
                            {currentView === 'settings' && <SettingsView />}
                        </div>
                    </div>

                    {/* Toast Container */}
                    <div className="fixed bottom-4 right-4 space-y-2 z-50" role="status">
                        {toasts.map(toast => (
                            <Toast key={toast.id} message={toast.message} type={toast.type} />
                        ))}
                    </div>

                    {/* System Settings Modal */}
                    <SystemSettingsModal
                        isOpen={showSettingsModal}
                        onClose={() => setShowSettingsModal(false)}
                        settings={systemSettings}
                        onSave={saveSystemSettings}
                    />
                </div>
            );
        };

        // ============================================================================
        // MAIN APPLICATION COMPONENT WITH ERROR BOUNDARY
        // ============================================================================

        // Simple Error Boundary Component
        const ErrorBoundary = ({ children }) => {
            const [hasError, setHasError] = useState(false);

            useEffect(() => {
                const handleError = (error) => {
                    console.error('Application error:', error);
                    setHasError(true);
                };

                window.addEventListener('error', handleError);
                return () => window.removeEventListener('error', handleError);
            }, []);

            if (hasError) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
                            <div className="text-red-500 text-6xl mb-4">
                                <i className="fas fa-exclamation-triangle"></i>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Something went wrong</h2>
                            <p className="text-gray-600 mb-6">
                                The application encountered an error. Please refresh the page to continue.
                            </p>
                            <button
                                onClick={() => window.location.reload()}
                                className="responsive-btn responsive-btn-primary responsive-btn-full-mobile"
                            >
                                Refresh Page
                            </button>
                        </div>
                    </div>
                );
            }

            return children;
        };

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [systemSettings, setSystemSettings] = useState({
                supermarketName: 'ProfitPoint POS Pro',
                branchLocation: 'Dar es Salaam, Tanzania',
                phoneNumber: '+255 123 456 789',
                slogan: 'Quality Products, Best Prices',
                receiptFooter: 'Thank you for shopping with us! Please come again.',
                theme: 'blue',
                logo: null,
                wallpaper: null,
                wallpaperOpacity: 10,
                receiptSettings: {
                    showLogo: true,
                    showSlogan: false,
                    showPhone: false,
                    showAddress: false,
                    showThankYou: true,
                    fontSize: '12px',
                    printCustomerCopy: true,
                    printMerchantCopy: false
                }
            });

            useEffect(() => {
                // Check if user is already logged in with error handling
                try {
                    const savedUser = safeParseJSON('currentUser');
                    const savedSettings = safeParseJSON('systemSettings');

                    if (savedUser) {
                        setCurrentUser(savedUser);
                    }

                    if (savedSettings) {
                        setSystemSettings(savedSettings);
                        applyTheme(savedSettings.theme);
                    }
                } catch (error) {
                    console.error('Error loading app data:', error);
                } finally {
                    setIsLoading(false);
                }
            }, []);

            // Apply theme to document
            const applyTheme = (theme) => {
                try {
                    document.body.className = document.body.className.replace(/theme-\w+/g, '');
                    document.body.classList.add(`theme-${theme}`);
                } catch (error) {
                    console.error('Error applying theme:', error);
                }
            };

            const handleLogin = (user) => {
                setCurrentUser(user);
            };

            const handleLogout = () => {
                localStorage.removeItem('currentUser');
                setCurrentUser(null);
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 to-purple-900 flex items-center justify-center" aria-live="polite">
                        <div className="text-center">
                            <div className="spinner mx-auto mb-4" style={{ width: '40px', height: '40px' }}></div>
                            <p className="text-white text-lg">Loading ProfitPoint POS Pro...</p>
                        </div>
                    </div>
                );
            }

            if (!currentUser) {
                return <LoginView onLogin={handleLogin} />;
            }

            // Route to appropriate app based on user role
            if (currentUser.role === 'manager' || currentUser.role === 'admin') {
                return (
                    <ErrorBoundary>
                        <ManagerApp currentUser={currentUser} onLogout={handleLogout} />
                    </ErrorBoundary>
                );
            } else {
                return (
                    <ErrorBoundary>
                        <POSApp currentUser={currentUser} onLogout={handleLogout} settings={systemSettings} />
                    </ErrorBoundary>
                );
            }
        };

        // Render the app with error handling
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (error) {
            console.error('Failed to render application:', error);
            document.getElementById('root').innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
                        <div class="text-red-500 text-6xl mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Render Error</h2>
                        <p class="text-gray-600 mb-6">
                            Failed to initialize the application. Please refresh the page.
                        </p>
                        <button onclick="window.location.reload()" class="responsive-btn responsive-btn-primary responsive-btn-full-mobile">
                            Refresh Page
                        </button>
                    </div>
                </div>
            `;
        }
    </script>
</body>

</html>